#!/usr/bin/env python3
"""
–¢–µ—Å—Ç P3: –ê–ª–∏–∞—Å—ã –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞

–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç:
- "–ø–∏—Ç–µ—Ä", "—Å–ø–±", "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥" ‚Üí ID=5
- "–Ω–∏–∂–Ω–∏–π", "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥" ‚Üí ID=8
- "–º–∏–Ω–≤–æ–¥—ã", "–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –≤–æ–¥—ã" ‚Üí ID=39
- –∏ —Ç.–¥.
"""

import sys
sys.path.insert(0, ".")

from app.core.tourvisor_constants import get_departure_id, DEPARTURES

GREEN = "\033[92m"
RED = "\033[91m"
YELLOW = "\033[93m"
BLUE = "\033[94m"
RESET = "\033[0m"


def test_aliases():
    """–¢–µ—Å—Ç –≤—Å–µ—Ö –∞–ª–∏–∞—Å–æ–≤ –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞."""
    
    print(f"\n{YELLOW}{'='*70}")
    print("  –¢–ï–°–¢ P3: –ê–õ–ò–ê–°–´ –ì–û–†–û–î–û–í –í–´–õ–ï–¢–ê")
    print(f"{'='*70}{RESET}\n")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏: (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–∂–∏–¥–∞–µ–º—ã–π ID, –æ–ø–∏—Å–∞–Ω–∏–µ)
    test_cases = [
        # ==================== –°–ê–ù–ö–¢-–ü–ï–¢–ï–†–ë–£–†–ì (ID=5) ====================
        ("–ø–∏—Ç–µ—Ä", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"),
        ("—Å–ø–±", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞"),
        ("—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - –ø–æ–ª–Ω—ã–π —Å –¥–µ—Ñ–∏—Å–æ–º"),
        ("—Å–∞–Ω–∫—Ç –ø–µ—Ç–µ—Ä–±—É—Ä–≥", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - –ø–æ–ª–Ω—ã–π –±–µ–∑ –¥–µ—Ñ–∏—Å–∞"),
        ("—Å.–ø–µ—Ç–µ—Ä–±—É—Ä–≥", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π (—Å—Ç–∞—Ä—ã–π)"),
        ("–ø–µ—Ç–µ—Ä–±—É—Ä–≥", 5, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ - –∫–æ—Ä–æ—Ç–∫–∏–π"),
        
        # ==================== –ú–û–°–ö–í–ê (ID=1) ====================
        ("–º–æ—Å–∫–≤–∞", 1, "–ú–æ—Å–∫–≤–∞ - –ø–æ–ª–Ω—ã–π"),
        ("–º—Å–∫", 1, "–ú–æ—Å–∫–≤–∞ - –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞"),
        
        # ==================== –ù–ò–ñ–ù–ò–ô –ù–û–í–ì–û–†–û–î (ID=8) ====================
        ("–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥", 8, "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ - –ø–æ–ª–Ω—ã–π"),
        ("–Ω.–Ω–æ–≤–≥–æ—Ä–æ–¥", 8, "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π"),
        ("–Ω–∏–∂–Ω–∏–π", 8, "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"),
        
        # ==================== –ï–ö–ê–¢–ï–†–ò–ù–ë–£–†–ì (ID=3) ====================
        ("–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", 3, "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ - –ø–æ–ª–Ω—ã–π"),
        ("–µ–∫–±", 3, "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ - –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞"),
        
        # ==================== –ù–û–í–û–°–ò–ë–ò–†–°–ö (ID=9) ====================
        ("–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", 9, "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ - –ø–æ–ª–Ω—ã–π"),
        ("–Ω–æ–≤–æ—Å–∏–±", 9, "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"),
        ("–Ω—Å–∫", 9, "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ - –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞"),
        
        # ==================== –†–û–°–¢–û–í-–ù–ê-–î–û–ù–£ (ID=18) ====================
        ("—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É", 18, "–†–æ—Å—Ç–æ–≤ - –ø–æ–ª–Ω—ã–π —Å –¥–µ—Ñ–∏—Å–∞–º–∏"),
        ("—Ä–æ—Å—Ç–æ–≤ –Ω–∞ –¥–æ–Ω—É", 18, "–†–æ—Å—Ç–æ–≤ - –ø–æ–ª–Ω—ã–π –±–µ–∑ –¥–µ—Ñ–∏—Å–æ–≤"),
        ("—Ä–æ—Å—Ç–æ–≤", 18, "–†–æ—Å—Ç–æ–≤ - –∫–æ—Ä–æ—Ç–∫–∏–π"),
        ("—Ä–Ω–¥", 18, "–†–æ—Å—Ç–æ–≤ - –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞"),
        
        # ==================== –ú–ò–ù–ï–†–ê–õ–¨–ù–´–ï –í–û–î–´ (ID=39) ====================
        ("–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –≤–æ–¥—ã", 39, "–ú–∏–Ω–≤–æ–¥—ã - –ø–æ–ª–Ω—ã–π"),
        ("–º–∏–Ω.–≤–æ–¥—ã", 39, "–ú–∏–Ω–≤–æ–¥—ã - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π (—Å—Ç–∞—Ä—ã–π)"),
        ("–º–∏–Ω–≤–æ–¥—ã", 39, "–ú–∏–Ω–≤–æ–¥—ã - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"),
        ("–∫–º–≤", 39, "–ú–∏–Ω–≤–æ–¥—ã - –ö–ú–í"),
        
        # ==================== –ù–ê–ë–ï–†–ï–ñ–ù–´–ï –ß–ï–õ–ù–´ (ID=61) ====================
        ("–Ω–∞–±–µ—Ä–µ–∂–Ω—ã–µ —á–µ–ª–Ω—ã", 61, "–ù–∞–±.–ß–µ–ª–Ω—ã - –ø–æ–ª–Ω—ã–π"),
        ("–Ω–∞–±.—á–µ–ª–Ω—ã", 61, "–ù–∞–±.–ß–µ–ª–Ω—ã - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π (—Å—Ç–∞—Ä—ã–π)"),
        ("—á–µ–ª–Ω—ã", 61, "–ù–∞–±.–ß–µ–ª–Ω—ã - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π"),
        
        # ==================== –Æ–ñ–ù–û-–°–ê–•–ê–õ–ò–ù–°–ö (ID=24) ====================
        ("—é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫", 24, "–Æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫ - –ø–æ–ª–Ω—ã–π"),
        ("—é.—Å–∞—Ö–∞–ª–∏–Ω—Å–∫", 24, "–Æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫ - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π (—Å—Ç–∞—Ä—ã–π)"),
        ("—é–∂–Ω–æ—Å–∞—Ö–∞–ª–∏–Ω—Å–∫", 24, "–Æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫ - —Å–ª–∏—Ç–Ω–æ"),
        
        # ==================== –ü–ï–¢–†–û–ü–ê–í–õ–û–í–°–ö-–ö–ê–ú–ß–ê–¢–°–ö–ò–ô (ID=43) ====================
        ("–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–∫–∞–º—á–∞—Ç—Å–∫–∏–π", 43, "–ü-–ö–∞–º—á–∞—Ç—Å–∫–∏–π - –ø–æ–ª–Ω—ã–π"),
        ("–ø.–∫–∞–º—á–∞—Ç—Å–∫–∏–π", 43, "–ü-–ö–∞–º—á–∞—Ç—Å–∫–∏–π - —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π (—Å—Ç–∞—Ä—ã–π)"),
        ("–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫", 43, "–ü-–ö–∞–º—á–∞—Ç—Å–∫–∏–π - –∫–æ—Ä–æ—Ç–∫–∏–π"),
        ("–∫–∞–º—á–∞—Ç–∫–∞", 43, "–ü-–ö–∞–º—á–∞—Ç—Å–∫–∏–π - —Ä–µ–≥–∏–æ–Ω"),
        
        # ==================== –î–†–£–ì–ò–ï –ì–û–†–û–î–ê (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ —Å–ª–æ–º–∞–ª–∏—Å—å) ====================
        ("–∫–∞–∑–∞–Ω—å", 10, "–ö–∞–∑–∞–Ω—å"),
        ("—Å–æ—á–∏", 56, "–°–æ—á–∏"),
        ("–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä", 11, "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä"),
        ("—É—Ñ–∞", 4, "–£—Ñ–∞"),
        ("—Å–∞–º–∞—Ä–∞", 7, "–°–∞–º–∞—Ä–∞"),
        ("—á–µ–ª—è–±–∏–Ω—Å–∫", 6, "–ß–µ–ª—è–±–∏–Ω—Å–∫"),
    ]
    
    passed = 0
    failed = 0
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–æ–¥–∞–º –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    current_city = None
    
    for alias, expected_id, description in test_cases:
        result = get_departure_id(alias)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        city_name = description.split(" - ")[0] if " - " in description else description
        
        if city_name != current_city:
            current_city = city_name
            print(f"\n{BLUE}üìç {city_name} (ID={expected_id}):{RESET}")
        
        if result == expected_id:
            print(f"   {GREEN}‚úÖ \"{alias}\" ‚Üí {result}{RESET}")
            passed += 1
        else:
            print(f"   {RED}‚ùå \"{alias}\" ‚Üí {result} (–æ–∂–∏–¥–∞–ª–æ—Å—å {expected_id}){RESET}")
            failed += 1
    
    # –ò—Ç–æ–≥–∏
    print(f"\n{YELLOW}{'='*70}")
    total = passed + failed
    success_rate = (passed / total * 100) if total > 0 else 0
    
    if failed == 0:
        print(f"  ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´: {passed}/{total} ({success_rate:.0f}%)")
    else:
        print(f"  ‚ö†Ô∏è –†–ï–ó–£–õ–¨–¢–ê–¢: {passed}/{total} ({success_rate:.0f}%)")
        print(f"  ‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {failed} —Ç–µ—Å—Ç–æ–≤")
    
    print(f"{'='*70}{RESET}\n")
    
    return failed == 0


def test_real_scenarios():
    """–¢–µ—Å—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    
    print(f"\n{YELLOW}{'='*70}")
    print("  –¢–ï–°–¢ –†–ï–ê–õ–¨–ù–´–• –°–¶–ï–ù–ê–†–ò–ï–í (–∏–∑ —Ç–µ—Å—Ç–æ–≤ 4.1, 4.2)")
    print(f"{'='*70}{RESET}\n")
    
    # –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    scenarios = [
        # –¢–µ—Å—Ç 4.1: "–≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã –≤ –¢—É—Ä—Ü–∏—é –∏–∑ –ü–∏—Ç–µ—Ä–∞"
        {
            "input": "–∏–∑ –ü–∏—Ç–µ—Ä–∞",
            "extract": "–ø–∏—Ç–µ—Ä",  # –ß—Ç–æ –∏–∑–≤–ª–µ—á—ë—Ç –±–æ—Ç
            "expected_id": 5,
            "expected_city": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
            "test_name": "–¢–µ—Å—Ç 4.1: –ì–æ—Ä—è—â–∏–µ –∏–∑ –ü–∏—Ç–µ—Ä–∞"
        },
        # –¢–µ—Å—Ç 4.2: "–≥–æ—Ä—è—â–∏–π —Ç—É—Ä –∏–∑ –ü–∏—Ç–µ—Ä–∞ –≤ –ï–≥–∏–ø–µ—Ç"
        {
            "input": "–∏–∑ –ø–∏—Ç–µ—Ä–∞",
            "extract": "–ø–∏—Ç–µ—Ä",
            "expected_id": 5,
            "expected_city": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
            "test_name": "–¢–µ—Å—Ç 4.2: –ì–æ—Ä—è—â–∏–π –∏–∑ –ø–∏—Ç–µ—Ä–∞ (lowercase)"
        },
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
        {
            "input": "–≤—ã–ª–µ—Ç –∏–∑ –°–ü–±",
            "extract": "—Å–ø–±",
            "expected_id": 5,
            "expected_city": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
            "test_name": "–í—ã–ª–µ—Ç –∏–∑ –°–ü–±"
        },
        {
            "input": "–∏–∑ –ù–∏–∂–Ω–µ–≥–æ",
            "extract": "–Ω–∏–∂–Ω–∏–π",
            "expected_id": 8,
            "expected_city": "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
            "test_name": "–ò–∑ –ù–∏–∂–Ω–µ–≥–æ (—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π)"
        },
        {
            "input": "–∏–∑ –ú–∏–Ω–≤–æ–¥",
            "extract": "–º–∏–Ω–≤–æ–¥",  # —Å –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º
            "expected_id": None,  # –ü—Ä–æ–≤–µ—Ä–∏–º - –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏
            "expected_city": "–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã",
            "test_name": "–ò–∑ –ú–∏–Ω–≤–æ–¥ (—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂)"
        },
    ]
    
    passed = 0
    failed = 0
    
    for scenario in scenarios:
        result = get_departure_id(scenario["extract"])
        expected = scenario["expected_id"]
        
        # –î–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–∂–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
        if expected is None:
            # –ü—Ä–æ–±—É–µ–º –±–µ–∑ –æ–∫–æ–Ω—á–∞–Ω–∏—è
            alt_result = get_departure_id("–º–∏–Ω–≤–æ–¥—ã")
            if alt_result:
                print(f"   {YELLOW}‚ö†Ô∏è {scenario['test_name']}: \"{scenario['extract']}\" –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ \"–º–∏–Ω–≤–æ–¥—ã\" ‚Üí {alt_result}{RESET}")
                passed += 1  # –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö
                continue
        
        if result == expected:
            print(f"   {GREEN}‚úÖ {scenario['test_name']}: \"{scenario['extract']}\" ‚Üí ID={result}{RESET}")
            passed += 1
        else:
            print(f"   {RED}‚ùå {scenario['test_name']}: \"{scenario['extract']}\" ‚Üí {result} (–æ–∂–∏–¥–∞–ª–æ—Å—å {expected}){RESET}")
            failed += 1
    
    print(f"\n{YELLOW}{'='*70}")
    print(f"  –ò–¢–û–ì–û –°–¶–ï–ù–ê–†–ò–ï–í: {passed}/{passed + failed}")
    print(f"{'='*70}{RESET}\n")
    
    return failed == 0


if __name__ == "__main__":
    print(f"\n{BLUE}üìä –í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞ –≤ –±–∞–∑–µ: {len(set(DEPARTURES.values()))}{RESET}")
    print(f"{BLUE}üìä –í—Å–µ–≥–æ –∞–ª–∏–∞—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ): {len(DEPARTURES)}{RESET}")
    
    success1 = test_aliases()
    success2 = test_real_scenarios()
    
    if success1 and success2:
        print(f"\n{GREEN}üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´!{RESET}\n")
        exit(0)
    else:
        print(f"\n{RED}‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã!{RESET}\n")
        exit(1)
