# XML шлюз TOURVISOR

## ПОИСК ТУРОВ

Поисковый шлюз TourVisor позволяет создавать поисковые запросы и получать их результат в формате XML либо JSON, тем самым возможно реализовать полностью индивидуальное оформление поисковой системы и произвольную выдачу результатов пользователям.

Результаты выдаются в кодировке **UTF-8 (Unicode)**.

---

## Схема работы с сервисом

Поиск туров в шлюзе осуществляется асинхронно и состоит из трех этапов:

1. Создается поисковый запрос (детально см.ниже), куда передаются необходимые параметры поиска (страна, город вылета, даты, кол-во ночей и т.п.). В ответ шлюз выдает единственный параметр – идентификатор поискового запроса. По этому идентификатору (далее для краткости «ID запроса») происходит дальнейшее отслеживание статуса поиска и получение результатов поиска туров.

2. Примерно через 3-5 секунд (раньше этого времени результатов поиска, как правило, не бывает) делается запрос на статус поиска. В ответ система выдает краткую сводку – какой % поиска уже был завершен, сколько туров найдено и какова минимальная цена (подробно см. ниже). На основании этой информации принимается решение – получать ли результаты запроса или ждать дальше. Мы рекомендуем следующий алгоритм – если поиск завершен или прошло более 7 секунд с начала поиска – то выдаем первый результат.

3. Делаем запрос на получение результатов поиска (подробнее см.ниже). В ответ система выдает туры, которые удалось получить на текущий момент. Также передается краткая сводка поиска (см. предыдущий пункт – 2) – если поиск еще не завершен, то мы рекомендуем каждые 2 секунды запрашивать статус поиска. Далее все зависит от Вашего алгоритма работы. Рекомендуемая схема – когда поиск завершится – выдаем клиенту оповещение о том, что найдены новые туры и обновляем результаты поиска.

---

## Авторизация

При работе со шлюзом требуется авторизация. Для этого используется логин и пароль от личного кабинета TourVisor.ru.

**Параметры авторизации:**

| Параметр | Описание |
|----------|----------|
| `authlogin` | логин в системе TourVisor |
| `authpass` | пароль в системе TourVisor |

---

## Формирование поискового запроса

Для того, чтобы запустить поиск, необходимо передать параметры поиска GET запросом на адрес:

```
http://tourvisor.ru/xml/search.php
```

Часть параметров передается кодами (например страна, город вылета) – кодировку можно получить из соответствующих справочников (см. инструкцию «XML - справочники»).

В ответ выдается числовой идентификатор запроса - по нему можно отслеживать статус и получать результаты поиска.

> **Внимание!** Получать статус и результаты поиска можно только с того же IP адреса, с которого делался первоначальный запрос.

### Параметры поискового запроса

| Параметр | Описание |
|----------|----------|
| `departure` | код города вылета |
| `country` | код страны |
| `datefrom` | дата от в формате дд.мм.гггг (если не указан - текущая дата +1 день) |
| `dateto` | дата до в формате дд.мм.гггг (если не указан - текущая дата +8 дней). Максимальный диапазон = 2 недели (14 дней) |
| `nightsfrom` | ночей от (по умолчанию = 7) |
| `nightsto` | ночей до (по умолчанию = 10) |
| `adults` | кол-во взрослых (по умолчанию = 2) |
| `child` | кол-во детей (по умолчанию = 0) |
| `childage1` | возраст 1 ребенка, лет (опционально). Младенец = 1. |
| `childage2` | возраст 2 ребенка, лет (опционально). Младенец = 1. |
| `childage3` | возраст 3 ребенка, лет (опционально). Младенец = 1. |
| `stars` | категория отеля (звездность) (опционально) |
| `starsbetter` | 1 – показывать категории лучше указанной. по умолчанию 1 (опционально) |
| `meal` | тип питания (код) (опционально) |
| `mealbetter` | 1 – показывать питание лучше указанного. по умолчанию 1 (опционально) |
| `rating` | рейтинг отеля (опционально). Используется кодировка: 0: любой, 2: >= 3.0, 3: >= 3.5, 4: >= 4.0, 5: >= 4.5 (т.е. нужно передать целое число, соотв. критерию) |
| `hotels` | коды отелей (если несколько, то через запятую) (опционально) |
| `hoteltypes` | типы отелей (через запятую: active, relax, family, health, city, beach, deluxe) пример:relax,beach (опционально). |
| `pricetype` | тип цены. 0 – цена за номер, 1 – цена за человека (по умолчанию 0) |
| `regions` | коды курортов (если несколько, то через запятую) (опционально) |
| `subregions` | коды вложенных курортов (районов) (если несколько, то через запятую) (опционально). Если Вам нужен поиск по конкретному району (subregion), то соответствующий ему параметр regions указывать не нужно, иначе будет производиться поиск по всему курорту (region), который Вы указали. |
| `operators` | список операторов (через запятую) (опционально) |
| `pricefrom` | цена от (в рублях, опционально) |
| `priceto` | цена до (в рублях, опционально) |
| `currency` | валюта, в которой производить выдачу результатов поиска. 0 = рубли (по-умолчанию), 1 – у.е. (USD или EUR, зависит от страны), 2 – бел.рубли, 3 – тенге |
| `hideregular` | 1 - скрыть туры на регулярных рейсах |
| `services` | список услуг в отеле, через запятую, опционально |
| `format` | json или xml - по умолчанию xml |

### Пример запроса

```
http://tourvisor.ru/xml/search.php?authlogin=test&authpass=123123&departure=3&country=1&datefrom=15.02.2014&dateto=21.02.2014&nightsfrom=6&nightsto=10&adults=2&child=0&format=xml
```

### Пример ответа

```xml
<result>
  <requestid>32023799</requestid>
</result>
```

Элемент `requestid` содержит идентификатор поискового запроса.

---

## Получение статуса и результатов поискового запроса

Для того, чтобы получить статус или результаты (туры) по запущенному поисковому запросу, необходимо передать идентификатор requestid GET запросом на адрес:

```
http://tourvisor.ru/xml/result.php
```

Также передается параметр `type`, который определяет ответ:
- `type=status` – в ответе передается только статус запроса (для отслеживания прогресса поиска)
- `type=result` – в ответе передаются текущие результаты поиска + статус запроса

Если параметр `type` не указан, то выдаются результаты + статус (т.е. по умолчанию `type=result`).

> **Внимание!** Получать статус и результаты поиска можно только с того же IP адреса, с которого делался первоначальный запрос.

### Параметры запроса

| Параметр | Описание |
|----------|----------|
| `requestid` | идентификатор запроса, который мы получили при вызове search.php (этот параметр является обязательным!) |
| `type` | что получаем в ответе. status - только статус запроса, result - результаты (туры) + статус. По умолчанию - result |
| `page` | страница результатов поиска, которую нужно загрузить (по умолчанию = 1). За один раз выдается ограниченное количество отелей (см.следующий параметр onpage). Если этого количества недостаточно, можно загрузить больше результатов, указав page=2, затем page=3 и т.д. (этот параметр не является обязательным) |
| `onpage` | сколько отелей выдавать на одной странице (по умолчанию 25) (этот параметр не является обязательным) |
| `nodescription` | если этот параметр = 1, то краткое описание отеля не передается (удобно, если Вы его не используете, чтобы уменьшить объем передаваемой информации) |
| `operatorstatus` | если = 1, передает расширенный статус по операторам (показывает какие операторы были найдены, минимальная цена и количество найденных отелей по каждому туроператору) |

### Блок статуса (status)

| Поле | Описание |
|------|----------|
| `state` | статус поиска: searching – идет поиск, finished – поиск завершен |
| `hotelsfound` | количество отелей, которое уже найдено |
| `toursfound` | количество туров, которое уже найдено |
| `minprice` | минимальная цена, найденная на текущий момент |
| `progress` | прогресс поиска – сколько % завершено (например, 40 или 70) |
| `timepassed` | сколько времени в секундах прошло с начала поиска |
| `operators` | (если указан параметр operatorstatus=1) – массив информации об уже найденных туроператорах (код, минимальная цена, кол-во отелей) |

### Блок результатов (result)

Результаты выдаются сгруппированными по отелям. Блок результатов содержит массив элементов `hotel`:

| Поле | Описание |
|------|----------|
| `hotelcode` | код отеля |
| `price` | цена в рублях (минимальная по этому отелю) |
| `countrycode` | код страны |
| `countryname` | название страны (на русском) |
| `regioncode` | код курорта для данного отеля |
| `regionname` | название курорта (на русском) |
| `subregioncode` | код вложенного курорта (района) для данного отеля, если есть (для большой части отелей он не задан и равен 0). |
| `hotelname` | название отеля |
| `hotelstars` | категория отеля (2,3,4 или 5) |
| `hotelrating` | рейтинг отеля от 1 до 5 (дробный), если нет = 0 |
| `hoteldescription` | краткое описание отеля (если его нет, то пусто) |
| `fulldesclink` | ссылка на полное описание отеля (если на Вашем сайте установлен модуль «Описания стран, курортов, отелей», то ссылка будет вести на Ваш сайт, иначе ссылка будет вести на наш нейтральный домен) |
| `reviewlink` | ссылка на отзывы по отелю (правила те же, что для fulldesclink) |
| `picturelink` | ссылка на картинку отеля (ширина 130px) |
| `isphoto` | есть ли фотографии в описании отеля (1 / 0) |
| `iscoords` | есть ли координаты в описании отеля (1 / 0) |
| `isdescription` | есть ли детальное описание отеля (1 / 0) |
| `isreviews` | есть ли отзывы по отелю (1 / 0) |
| `seadistance` | расстояние до моря (в метрах) |

### Блок tours (туры для отеля)

Блок `hotel` содержит блок `tours`, в котором содержится массив элементов `tour`:

| Поле | Описание |
|------|----------|
| `operatorcode` | код туроператора |
| `operatorname` | название туроператора |
| `flydate` | дата вылета в формате дд.мм.гггг |
| `nights` | кол-во ночей |
| `price` | цена в рублях. Цена уже содержит топливный сбор и уже учитывает скидку, которая настроена в личном кабинете (т.е. алгоритм расчета совпадает с алгоритмом расчета для обычного поискового модуля, установленного на сайте). |
| `fuelcharge` | топливный сбор в рублях (на весь тур) |
| `priceue` | цена в у.е. (указывается справочно, пересчитывается по текущему курсу туроператора из цены в рублях, не включает топливный сбор) |
| `placement` | название типа размещения |
| `adults` | кол-во взрослых |
| `child` | кол-во детей |
| `meal` | тип питания (краткое наименование) |
| `mealrussian` | полное русское наименование питания |
| `room` | тип комнаты |
| `tourname` | наименование тура |
| `tourid` | индивидуальный код тура (будет использоваться позднее для получения детальной информации о туре, списка авиарейсов и т.п.). Обратите внимание, что данный код, как правило, действует не более суток. Поэтому не следует использовать его для долговременного хранения. |
| `currency` | код (название) валюты, в которой представлена цена. Один из: RUB, EUR, USD, BYR, KZT |
| `regular` | если = 1, то данный тур выполняется на регулярных рейсах (возможны доплаты к туру) |
| `promo` | если = 1, то данный тур - со сниженной комиссией (промо) |
| `onrequest` | метка, если она = 1, то места на авиарейсах (именно на рейсах, а не в отеле) по данному туру “под запрос”. |
| `flightstatus` | места на рейсах: 1 = “под запрос”, 2 = "мало" |
| `hotelstatus` | места в отеле: 1 = “под запрос”, 2 = "мгновенное подтверждение" |
| `nightflight` | если есть ночной перелет, указывается количество ночей в дороге |

### Пример запроса статуса

```
http://tourvisor.ru/xml/result.php?authlogin=test&authpass=1231&requestid=32023799&type=status
```

### Пример ответа статуса

```xml
<data>
  <status>
    <state>finished</state>
    <hotelsfound>99</hotelsfound>
    <toursfound>463</toursfound>
    <minprice>30481</minprice>
    <progress>100</progress>
    <timepassed>34</timepassed>
  </status>
</data>
```

### Пример запроса результатов поиска

```
http://tourvisor.ru/xml/result.php?authlogin=test&authpass=1231&requestid=32023799&type=result
```

### Пример ответа результатов

```xml
<data>
  <status>
    <state>finished</state>
    <hotelsfound>99</hotelsfound>
    <toursfound>463</toursfound>
    <minprice>30481</minprice>
    <progress>100</progress>
    <timepassed>34</timepassed>
  </status>
  <result>
    <hotel>
      <hotelcode>470</hotelcode>
      <price>30481</price>
      <countrycode>1</countrycode>
      <countryname>Египет</countryname>
      <regioncode>5</regioncode>
      <regionname>Хургада</regionname>
      <hotelname>SULTANA BEACH RESORT</hotelname>
      <hotelstars>3</hotelstars>
      <hotelrating>2.2</hotelrating>
      <hoteldescription>Очень простой и скромный отель для непритязательного экономного отдыха...</hoteldescription>
      <fulldesclink>http://manyhotels.ru/#!/hotel=sultana-beach-resort</fulldesclink>
      <reviewlink>http://manyhotels.ru/#!/hotel=sultana-beach-resort&showreviews=1</reviewlink>
      <picturelink>http://manyhotels.ru/hotel_pics/small/470.jpg</picturelink>
      <tours>
        <tour>
          <operatorcode>16</operatorcode>
          <operatorname>Sunmar</operatorname>
          <flydate>16.02.2014</flydate>
          <nights>6</nights>
          <price>30481</price>
          <fuelcharge>0</fuelcharge>
          <placement>DBL</placement>
          <adults>2</adults>
          <child>0</child>
          <meal>HB</meal>
          <mealrussian>Полупансион</mealrussian>
          <room>standard room</room>
          <tourname>Хургада</tourname>
          <tourid>16347248245</tourid>
        </tour>
        <!-- ... -->
      </tours>
    </hotel>
  </result>
</data>
```

---

## Продолжение поиска (найти еще туры)

После того, как поиск завершен, есть возможность продолжить его, чтобы получить больше предложений от туроператоров. Для этого необходимо передать идентификатор requestid GET запросом в параметре `continue` на адрес:

```
http://tourvisor.ru/xml/search.php
```

Остальные параметры поиска указывать не нужно, система определит их по идентификатору запроса.

В ответ выдается параметр `page`, в котором указывается виртуальная "страница" поиска. При первом продолжении вернется page=2, при втором page=3 и так далее. Продолжение доступно только тогда, когда предыдущий поиск по данному запросу полностью завершился (finished). Если продолжение поиска запустить не удалось, то вернется page=0.

Результаты поиска после этого можно получать как обычно (result.php). Выдается полный результат, включающий в себя начальный поиск и все его продолжения.

> **Внимание!** Каждый запрос на продолжение поиска считается отдельным поисковым запросом и отдельно учитывается в Вашей статистике (а значит, может влиять на оплату за превышение лимита запросов).

### Параметры запроса

| Параметр | Описание |
|----------|----------|
| `continue` | идентификатор запроса, который мы получили при старте поиска |
| `format` | json или xml - по умолчанию xml |

### Пример запроса продолжения поиска

```
https://tourvisor.ru/xml/search.php?authlogin=test&authpass=test&continue=1844397632&format=json
```
