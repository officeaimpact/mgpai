"""
–ö–ª–∏–µ–Ω—Ç YandexGPT –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ú–ì–ü.

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è:
- –ò–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Å—Ç—Ä–∞–Ω–∞, –¥–∞—Ç—ã, —Ç—É—Ä–∏—Å—Ç—ã)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û—Ç–≤–µ—Ç–æ–≤ –Ω–∞ FAQ –≤–æ–ø—Ä–æ—Å—ã
"""
from __future__ import annotations

import json
import httpx
from typing import Optional
from datetime import date

from app.core.config import settings


# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
# ANTI-HALLUCINATION PROMPT v2.0
ENTITY_EXTRACTION_PROMPT = """–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å –¢–û–õ–¨–ö–û —Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ø–í–ù–û —É–∫–∞–∑–∞–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

=== –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê (–°–¢–†–û–ì–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´!) ===

üö´ –ó–ê–ü–†–ï–©–ï–ù–û –ì–ê–õ–õ–Æ–¶–ò–ù–ò–†–û–í–ê–¢–¨:
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π date_from, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É–∫–∞–∑–∞–ª –¥–∞—Ç—É!
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π adults, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É–∫–∞–∑–∞–ª –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π!
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π departure_city, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —É–∫–∞–∑–∞–ª –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞!
- –ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–π –¥–µ—Ñ–æ–ª—Ç—ã ("01.01", "1 —á–µ–ª–æ–≤–µ–∫", "–ú–æ—Å–∫–≤–∞")!

‚úÖ –ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –ù–ï —É–∫–∞–∑–∞–Ω –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî –ù–ï –≤–∫–ª—é—á–∞–π –µ–≥–æ –≤ JSON!

=== –ü–†–ò–ú–ï–†–´ ===

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "—Ö–æ—á—É –≤ —Ç—É—Ä—Ü–∏—é"
–ü–†–ê–í–ò–õ–¨–ù–û: {{"intent": "search_tour", "entities": {{"destination_country": "–¢—É—Ä—Ü–∏—è"}}}}
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: {{"intent": "search_tour", "entities": {{"destination_country": "–¢—É—Ä—Ü–∏—è", "adults": 1, "date_from": "2026-01-01"}}}}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "—Ç—É—Ä—Ü–∏—è –Ω–∞ –¥–≤–æ–∏—Ö"
–ü–†–ê–í–ò–õ–¨–ù–û: {{"intent": "search_tour", "entities": {{"destination_country": "–¢—É—Ä—Ü–∏—è", "adults": 2}}}}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–µ–≥–∏–ø–µ—Ç 15 —Ñ–µ–≤—Ä–∞–ª—è"
–ü–†–ê–í–ò–õ–¨–ù–û: {{"intent": "search_tour", "entities": {{"destination_country": "–ï–≥–∏–ø–µ—Ç", "date_from": "2026-02-15"}}}}

=== –ß–¢–û –ò–ó–í–õ–ï–ö–ê–¢–¨ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω–æ!) ===
- destination_country: —Å—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- destination_region: —Ä–µ–≥–∏–æ–Ω (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
- destination_resort: –∫—É—Ä–æ—Ä—Ç (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
- date_from: –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –¥–∞—Ç–∞ —É–∫–∞–∑–∞–Ω–∞!)
- date_to: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
- nights: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–Ω–∞ 5 –Ω–æ—á–µ–π", "–Ω–∞ –Ω–µ–¥–µ–ª—é" –∏ —Ç.–¥.)
- adults: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–≤–¥–≤–æ—ë–º", "2 —á–µ–ª–æ–≤–µ–∫–∞", "–æ–¥–∏–Ω" –∏ —Ç.–¥.)
- children: —Å–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –¥–µ—Ç–µ–π (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –¥–µ—Ç–∏ —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º!)
- hotel_name: –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å)
- food_type: —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (RO, BB, HB, FB, AI, UAI) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
- departure_city: –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω "–∏–∑ –ú–æ—Å–∫–≤—ã", "–≤—ã–ª–µ—Ç –∏–∑ –°–ü–±" –∏ —Ç.–¥.)
- search_mode: —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ ("hotel_only" –µ—Å–ª–∏ "–±–µ–∑ –ø–µ—Ä–µ–ª–µ—Ç–∞/—Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å/–ø–∞–Ω—Å–∏–æ–Ω–∞—Ç")

=== INTENT (–Ω–∞–º–µ—Ä–µ–Ω–∏–µ) ===
- "search_tour" ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —Ç—É—Ä
- "hot_tours" ‚Äî –≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã ("–≥–æ—Ä—è—â–∏–π", "—Å—Ä–æ—á–Ω–æ", "–±–ª–∏–∂–∞–π—à–∏–π –≤—ã–ª–µ—Ç")
- "hotel_only" ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å –±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞ ("–±–µ–∑ –ø–µ—Ä–µ–ª–µ—Ç–∞", "—Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å", "–ø–∞–Ω—Å–∏–æ–Ω–∞—Ç")
- "general_chat" ‚Äî –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å (–ø–æ–≥–æ–¥–∞, —Å–æ–≤–µ—Ç—ã, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
- "faq_visa" ‚Äî –≤–æ–ø—Ä–æ—Å –æ –≤–∏–∑–∞—Ö
- "faq_payment" ‚Äî –≤–æ–ø—Ä–æ—Å –æ–± –æ–ø–ª–∞—Ç–µ
- "faq_cancel" ‚Äî –≤–æ–ø—Ä–æ—Å –æ–± –æ—Ç–º–µ–Ω–µ/–≤–æ–∑–≤—Ä–∞—Ç–µ
- "faq_insurance" ‚Äî –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–µ
- "faq_documents" ‚Äî –≤–æ–ø—Ä–æ—Å –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
- "greeting" ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ("–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ")
- "other" ‚Äî –¥—Ä—É–≥–æ–µ

=== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê ===
1. –¢–µ–∫—É—â–∏–π –≥–æ–¥: {current_year}. –ï—Å–ª–∏ –≥–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–π –±–ª–∏–∂–∞–π—à—É—é –ë–£–î–£–©–£–Æ –¥–∞—Ç—É.
2. "–≤–¥–≤–æ—ë–º", "–¥–ª—è –¥–≤–æ–∏—Ö" ‚Üí adults: 2 (—ç—Ç–æ –Ø–í–ù–û–ï —É–∫–∞–∑–∞–Ω–∏–µ!)
3. "–æ–¥–∏–Ω", "–æ–¥–Ω–∞", "—Å–∞–º" ‚Üí adults: 1 (—ç—Ç–æ –Ø–í–ù–û–ï —É–∫–∞–∑–∞–Ω–∏–µ!)
4. "—Å —Ä–µ–±–µ–Ω–∫–æ–º 5 –ª–µ—Ç" ‚Üí children: [5] (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –≤–æ–∑—Ä–∞—Å—Ç!)
5. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –æ—Ç–µ–ª—å ‚Äî –ù–ï —Ç—Ä–µ–±—É–π –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å.

=== –°–ï–ú–ê–ù–¢–ò–ö–ê –°–û–°–¢–ê–í–ê –¢–£–†–ò–°–¢–û–í (–í–ê–ñ–ù–û!) ===
- "—è" / "–æ–¥–∏–Ω" / "–æ–¥–Ω–∞" / "—Å–∞–º" ‚Üí adults: 1
- "–º—ã —Å –º—É–∂–µ–º" / "–º—ã —Å –∂–µ–Ω–æ–π" / "–≤–¥–≤–æ—ë–º" / "–Ω–∞—Å –¥–≤–æ–µ" ‚Üí adults: 2
- "—è –∏ —Å—ã–Ω" / "—è —Å —Ä–µ–±–µ–Ω–∫–æ–º" ‚Üí adults: 1, children_mentioned: true (–Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç!)
- "—è –∏ –¥–æ—á—å 7 –ª–µ—Ç" ‚Üí adults: 1, children: [7]
- "–º—ã —Å –¥–µ—Ç—å–º–∏" / "—Å–µ–º—å—ë–π" ‚Üí adults: 2, children_mentioned: true (–Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç!)
- "–≤—Ç—Ä–æ—ë–º —Å —Ä–µ–±–µ–Ω–∫–æ–º" ‚Üí adults: 2, children_mentioned: true
- "—Å–µ–º—å—è –∏–∑ 4" ‚Üí adults: 2, children_mentioned: true, children_count_mentioned: 2

=== OUTPUT FORMAT (–°–¢–†–û–ì–û!) ===
Output ONLY raw JSON. No markdown like ```json```. No intro. No outro.
Just a valid JSON object starting with {{ and ending with }}.

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON:
{{
  "intent": "search_tour",
  "entities": {{
    "destination_country": "–¢—É—Ä—Ü–∏—è"
  }}
}}"""

# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π FAQ
FAQ_KNOWLEDGE_BASE = """
# –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –ú–ì–ü

## –í–∏–∑—ã –∏ –≤—ä–µ–∑–¥

### –ë–µ–∑–≤–∏–∑–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω—ã –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§:
- **–¢—É—Ä—Ü–∏—è** ‚Äî –¥–æ 60 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–ï–≥–∏–ø–µ—Ç** ‚Äî –≤–∏–∑–∞ –ø–æ –ø—Ä–∏–ª—ë—Ç—É (25$) –∏–ª–∏ –±–µ–∑–≤–∏–∑–æ–≤—ã–π –≤—ä–µ–∑–¥ –≤ –®–∞—Ä–º-—ç–ª—å-–®–µ–π—Ö –¥–æ 15 –¥–Ω–µ–π
- **–û–ê–≠** ‚Äî –¥–æ 90 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–¢–∞–∏–ª–∞–Ω–¥** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã (–º–æ–∂–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –¥–æ 60)
- **–ú–∞–ª—å–¥–∏–≤—ã** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–ò–Ω–¥–æ–Ω–µ–∑–∏—è (–ë–∞–ª–∏)** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–®—Ä–∏-–õ–∞–Ω–∫–∞** ‚Äî —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –≤–∏–∑–∞ (ETA)
- **–ö—É–±–∞** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–î–æ–º–∏–Ω–∏–∫–∞–Ω–∞** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã
- **–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è** ‚Äî –¥–æ 30 –¥–Ω–µ–π –±–µ–∑ –≤–∏–∑—ã

### –°—Ç—Ä–∞–Ω—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–∏–∑—É:
- **–®–µ–Ω–≥–µ–Ω** (–ì—Ä–µ—Ü–∏—è, –ò—Å–ø–∞–Ω–∏—è, –ò—Ç–∞–ª–∏—è, –§—Ä–∞–Ω—Ü–∏—è –∏ –¥—Ä.) ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —à–µ–Ω–≥–µ–Ω—Å–∫–∞—è –≤–∏–∑–∞
- **–ö–∏–ø—Ä** ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–∏–∑–∞ –æ–Ω–ª–∞–π–Ω (–¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§)
- **–°–®–ê, –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è, –ê–≤—Å—Ç—Ä–∞–ª–∏—è** ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∑–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç—É:
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –º–∏–Ω–∏–º—É–º 6 –º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ –¥–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è
- –ù–∞–ª–∏—á–∏–µ —á–∏—Å—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è —à—Ç–∞–º–ø–æ–≤

## –û–ø–ª–∞—Ç–∞ —Ç—É—Ä–æ–≤

### –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã (Visa, MasterCard, –ú–ò–†)
- –ù–∞–ª–∏—á–Ω—ã–µ –≤ –æ—Ñ–∏—Å–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
- –°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–°–ë–ü)

### –†–∞—Å—Å—Ä–æ—á–∫–∞:
- –†–∞—Å—Å—Ä–æ—á–∫–∞ 0% –Ω–∞ 4-6 –º–µ—Å—è—Ü–µ–≤ –æ—Ç –±–∞–Ω–∫–æ–≤-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å –æ—Ç 10%

### –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –æ—Ç 30% –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –∑–∞ 14 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞ (–¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
- –ì–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã ‚Äî –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å—Ä–∞–∑—É

## –û—Ç–º–µ–Ω–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç

### –£—Å–ª–æ–≤–∏—è –æ—Ç–º–µ–Ω—ã —Ç—É—Ä–∞:
- **–ë–æ–ª–µ–µ 30 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞** ‚Äî –≤–æ–∑–≤—Ä–∞—Ç 90-100% (–∑–∞ –≤—ã—á–µ—Ç–æ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)
- **15-30 –¥–Ω–µ–π** ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 25%
- **7-14 –¥–Ω–µ–π** ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 50%
- **3-7 –¥–Ω–µ–π** ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 75%
- **–ú–µ–Ω–µ–µ 3 –¥–Ω–µ–π** ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω

### –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –Ω–µ–≤—ã–µ–∑–¥–∞:
- –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É –ø–æ –±–æ–ª–µ–∑–Ω–∏, –æ—Ç–∫–∞–∑—É –≤ –≤–∏–∑–µ, –≤—ã–∑–æ–≤—É –≤ —Å—É–¥ –∏ –¥—Ä.
- –°—Ç–æ–∏–º–æ—Å—Ç—å: 3-5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç—É—Ä–∞
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–ª—è—Ç—å –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

## –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞:
- –í–∫–ª—é—á–µ–Ω–∞ –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–∞–∫–µ—Ç–Ω—ã—Ö —Ç—É—Ä–æ–≤
- –ü–æ–∫—Ä—ã—Ç–∏–µ –æ—Ç 30 000 –¥–æ 50 000 USD
- –ü–æ–∫—Ä—ã–≤–∞–µ—Ç: —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –º–µ–¥. –ø–æ–º–æ—â—å, –≥–æ—Å–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—é, —ç–≤–∞–∫—É–∞—Ü–∏—é

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏:
- **–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –Ω–µ–≤—ã–µ–∑–¥–∞** ‚Äî –æ—Ç–º–µ–Ω–∞ –ø–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º
- **–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –±–∞–≥–∞–∂–∞** ‚Äî –ø–æ—Ç–µ—Ä—è, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –±–∞–≥–∞–∂–∞
- **–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –Ω–µ—Å—á–∞—Å—Ç–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤** ‚Äî —Ç—Ä–∞–≤–º—ã –≤–æ –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞
- **–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞** ‚Äî –¥–∞–π–≤–∏–Ω–≥, —Å–µ—Ä—Ñ–∏–Ω–≥, –ª—ã–∂–∏

## –î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–µ–∑–¥–∫–∏

### –í–∑—Ä–æ—Å–ª—ã–µ:
- –ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 6+ –º–µ—Å—è—Ü–µ–≤)
- –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã –∏ –≤–∞—É—á–µ—Ä –æ—Ç–µ–ª—è
- –°—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å
- –ö–æ–ø–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–∞—Å–ø–æ—Ä—Ç–∞

### –î–µ—Ç–∏:
- –ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç —Ä–µ–±—ë–Ω–∫–∞ (–∏–ª–∏ –∑–∞–ø–∏—Å—å –≤ –ø–∞—Å–ø–æ—Ä—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –¥–µ—Ç–µ–π –¥–æ 14 –ª–µ—Ç)
- –°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏ (–∫–æ–ø–∏—è)
- –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –≤—ã–µ–∑–¥ –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ–¥–µ—Ç —Å –æ–¥–Ω–∏–º —Ä–æ–¥–∏—Ç–µ–ª–µ–º)

### –î–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω:
- –û–±—Ä–∞—Ç–Ω—ã–µ –±–∏–ª–µ—Ç—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–µ–∑–¥–∞)
- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
"""

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ FAQ
FAQ_ANSWER_PROMPT = """–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –ú–ì–ü.
–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å.
–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.
–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π:
{knowledge_base}

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}

–î–∞–π –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç:"""


class YandexGPTClient:
    """
    –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YandexGPT API.
    """
    
    BASE_URL = "https://llm.api.cloud.yandex.net/foundationModels/v1"
    
    def __init__(self):
        self.folder_id = settings.YANDEX_FOLDER_ID
        self.api_key = settings.YANDEX_API_KEY
        self.model = settings.YANDEX_MODEL
        self.enabled = settings.YANDEX_GPT_ENABLED
        self.client: Optional[httpx.AsyncClient] = None
    
    async def _get_client(self) -> httpx.AsyncClient:
        """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP –∫–ª–∏–µ–Ω—Ç–∞."""
        if self.client is None:
            self.client = httpx.AsyncClient(timeout=60.0)
        return self.client
    
    async def _call_api(
        self,
        system_prompt: str,
        user_prompt: str,
        temperature: float = 0.3,
        max_tokens: int = 1000
    ) -> str:
        """
        –í—ã–∑–æ–≤ YandexGPT API.
        
        Args:
            system_prompt: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            user_prompt: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0-1)
            max_tokens: –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
            
        Returns:
            –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
        """
        if not self.enabled or not self.api_key or not self.folder_id:
            raise ValueError("YandexGPT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ YANDEX_API_KEY –∏ YANDEX_FOLDER_ID")
        
        client = await self._get_client()
        
        model_uri = f"gpt://{self.folder_id}/{self.model}"
        
        payload = {
            "modelUri": model_uri,
            "completionOptions": {
                "stream": False,
                "temperature": temperature,
                "maxTokens": str(max_tokens)
            },
            "messages": [
                {"role": "system", "text": system_prompt},
                {"role": "user", "text": user_prompt}
            ]
        }
        
        headers = {
            "Authorization": f"Api-Key {self.api_key}",
            "Content-Type": "application/json"
        }
        
        response = await client.post(
            f"{self.BASE_URL}/completion",
            json=payload,
            headers=headers
        )
        response.raise_for_status()
        
        result = response.json()
        return result["result"]["alternatives"][0]["message"]["text"]
    
    def _clean_json_response(self, response: str) -> str:
        """
        –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.
        
        STRICT JSON PARSER: –£–¥–∞–ª—è–µ—Ç ```json```, –≤–≤–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –∫–æ–Ω—Ü–æ–≤–∫–∏.
        """
        import re
        
        response = response.strip()
        
        # –£–¥–∞–ª—è–µ–º markdown code blocks
        if "```" in response:
            # –ò—â–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–∂–¥—É ```json –∏ ```
            pattern = r'```(?:json)?\s*([\s\S]*?)```'
            match = re.search(pattern, response)
            if match:
                response = match.group(1).strip()
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–≥–æ ``` ‚Äî –±–µ—Ä—ë–º –≤—Å—ë –ø–æ—Å–ª–µ ```json
                if response.startswith("```"):
                    parts = response.split("```")
                    if len(parts) > 1:
                        response = parts[1]
                        if response.startswith("json"):
                            response = response[4:]
        
        response = response.strip()
        
        # –£–¥–∞–ª—è–µ–º –≤–≤–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ JSON
        # –ù–∞–ø—Ä–∏–º–µ—Ä: "–í–æ—Ç JSON:\n{...}" –∏–ª–∏ "Response: {...}"
        json_start = response.find('{')
        if json_start > 0:
            response = response[json_start:]
        
        # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ JSON
        # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É
        json_end = response.rfind('}')
        if json_end != -1 and json_end < len(response) - 1:
            response = response[:json_end + 1]
        
        return response.strip()
    
    async def extract_entities(self, user_message: str) -> dict:
        """
        –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            user_message: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å intent –∏ entities
        """
        if not self.enabled:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ LLM –æ—Ç–∫–ª—é—á–µ–Ω
            return {"intent": "search_tour", "entities": {}}
        
        try:
            current_year = date.today().year
            system_prompt = ENTITY_EXTRACTION_PROMPT.format(current_year=current_year)
            
            response = await self._call_api(
                system_prompt=system_prompt,
                user_prompt=user_message,
                temperature=0.1,
                max_tokens=500
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ ‚Äî STRICT JSON PARSER
            response = self._clean_json_response(response)
            
            result = json.loads(response)
            return result
            
        except json.JSONDecodeError as e:
            print(f"JSON parse error: {e}, response: {response}")
            # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            try:
                import re
                json_match = re.search(r'\{[\s\S]*\}', response)
                if json_match:
                    result = json.loads(json_match.group())
                    return result
            except:
                pass
            return {"intent": "search_tour", "entities": {}}
        except Exception as e:
            print(f"YandexGPT error: {e}")
            return {"intent": "search_tour", "entities": {}}
    
    async def answer_faq(self, question: str) -> str:
        """
        –û—Ç–≤–µ—Ç –Ω–∞ FAQ –≤–æ–ø—Ä–æ—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
        
        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        """
        if not self.enabled:
            return ""
        
        try:
            prompt = FAQ_ANSWER_PROMPT.format(
                knowledge_base=FAQ_KNOWLEDGE_BASE,
                question=question
            )
            
            response = await self._call_api(
                system_prompt="–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.",
                user_prompt=prompt,
                temperature=0.3,
                max_tokens=800
            )
            
            return response.strip()
            
        except Exception as e:
            print(f"YandexGPT FAQ error: {e}")
            return ""
    
    async def generate_conversational_response(
        self,
        user_message: str,
        search_params: dict,
        conversation_history: list
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å.
        
        –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–≥–æ–¥–µ, —Å–æ–≤–µ—Ç—ã –ø–æ –æ—Ç–µ–ª—è–º, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω
        –∏ –º—è–≥–∫–æ –ø–æ–¥–≤–æ–¥–∏—Ç –∫ —Å–±–æ—Ä—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–∞.
        
        Args:
            user_message: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            search_params: –£–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            
        Returns:
            –û—Ç–≤–µ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π + –º—è–≥–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞–Ω–∞—Ö
        """
        if not self.enabled:
            return ""
        
        try:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
            from app.agent.prompts import get_general_chat_prompt, get_system_prompt
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            chat_prompt = get_general_chat_prompt(user_message, search_params)
            system_prompt = get_system_prompt()
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–æ–æ–±—â–µ–Ω–∏—è)
            recent_history = conversation_history[-4:] if len(conversation_history) > 4 else conversation_history
            history_text = "\n".join([
                f"{'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' if msg['role'] == 'user' else '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: {msg['content']}"
                for msg in recent_history[:-1]  # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            ])
            
            if history_text:
                chat_prompt = f"–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n{history_text}\n\n{chat_prompt}"
            
            response = await self._call_api(
                system_prompt=system_prompt,
                user_prompt=chat_prompt,
                temperature=0.7,  # –ë–æ–ª–µ–µ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
                max_tokens=600
            )
            
            return response.strip()
            
        except Exception as e:
            print(f"YandexGPT conversational error: {e}")
            return ""
    
    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–∞."""
        if self.client:
            await self.client.aclose()
            self.client = None


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∏–µ–Ω—Ç–∞
llm_client = YandexGPTClient()
