================================================================================
–ü–û–õ–ù–´–ô –î–ê–ú–ü –ö–û–î–ê –ü–†–û–ï–ö–¢–ê –ú–ì–ü
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2026-01-12
================================================================================

–§–∞–π–ª—ã –≤ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ:
1. app/agent/nodes.py (2472 —Å—Ç—Ä–æ–∫–∏) - –õ–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞ –∏ –ø–æ–∏—Å–∫–∞
2. app/agent/state.py (431 —Å—Ç—Ä–æ–∫–∞) - –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
3. app/agent/prompts.py (439 —Å—Ç—Ä–æ–∫) - –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
4. app/services/tourvisor.py (2002 —Å—Ç—Ä–æ–∫–∏) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API
5. app/models/domain.py (579 —Å—Ç—Ä–æ–∫) - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö Pydantic

================================================================================

=== app/agent/nodes.py ===

"""
–£–∑–ª—ã –≥—Ä–∞—Ñ–∞ LangGraph –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ú–ì–ü.

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –¥–ª—è –ø–æ–∏—Å–∫–∞
- –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤" —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é
- –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –º—è–≥–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏–π
"""
from __future__ import annotations

import re
import logging
from datetime import date, timedelta
from typing import Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

from app.agent.state import (
    AgentState,
    PartialSearchParams,
    get_cascade_stage,
    get_missing_required_params,
    get_funnel_stage,
    needs_quality_check,
    check_skip_quality_phrase,
    format_context,
    is_off_season,
    MASS_DESTINATIONS,
    COUNTRY_SEASONS,
    AGREEMENT_PHRASES,
)
from app.models.domain import (
    SearchRequest,
    Destination,
    FoodType
)
from app.services.tourvisor import tourvisor_service
from app.core.config import settings
from app.agent.prompts import (
    FAQ_RESPONSES,
    DESTINATIONS_KNOWLEDGE,
)


# ==================== ENTITY EXTRACTION ====================

# ==================== –í–ê–õ–ò–î–ù–´–ï –°–¢–†–ê–ù–´ (Anti-Hallucination) ====================
# –¢–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–¥–∞—ë–º —á–µ—Ä–µ–∑ Tourvisor

COUNTRIES_MAP = {
    "—Ç—É—Ä—Ü–∏—è": "–¢—É—Ä—Ü–∏—è", "—Ç—É—Ä—Ü–∏—é": "–¢—É—Ä—Ü–∏—è", "turkey": "–¢—É—Ä—Ü–∏—è",
    "–µ–≥–∏–ø–µ—Ç": "–ï–≥–∏–ø–µ—Ç", "egypt": "–ï–≥–∏–ø–µ—Ç",
    "–æ–∞—ç": "–û–ê–≠", "—ç–º–∏—Ä–∞—Ç—ã": "–û–ê–≠", "–¥—É–±–∞–π": "–û–ê–≠", "uae": "–û–ê–≠",
    "—Ç–∞–∏–ª–∞–Ω–¥": "–¢–∞–∏–ª–∞–Ω–¥", "—Ç–∞–π": "–¢–∞–∏–ª–∞–Ω–¥", "thailand": "–¢–∞–∏–ª–∞–Ω–¥", "–ø—Ö—É–∫–µ—Ç": "–¢–∞–∏–ª–∞–Ω–¥",
    "–º–∞–ª—å–¥–∏–≤—ã": "–ú–∞–ª—å–¥–∏–≤—ã", "–∫–∏–ø—Ä": "–ö–∏–ø—Ä", "–≥—Ä–µ—Ü–∏—è": "–ì—Ä–µ—Ü–∏—è",
    "–∏—Å–ø–∞–Ω–∏—è": "–ò—Å–ø–∞–Ω–∏—è", "–∏—Ç–∞–ª–∏—è": "–ò—Ç–∞–ª–∏—è", "—á–µ—Ä–Ω–æ–≥–æ—Ä–∏—è": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è",
    "—Ç—É–Ω–∏—Å": "–¢—É–Ω–∏—Å", "–¥–æ–º–∏–Ω–∏–∫–∞–Ω–∞": "–î–æ–º–∏–Ω–∏–∫–∞–Ω–∞", "–∫—É–±–∞": "–ö—É–±–∞",
    "—à—Ä–∏-–ª–∞–Ω–∫–∞": "–®—Ä–∏-–õ–∞–Ω–∫–∞", "–≤—å–µ—Ç–Ω–∞–º": "–í—å–µ—Ç–Ω–∞–º", "–∏–Ω–¥–æ–Ω–µ–∑–∏—è": "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", "–±–∞–ª–∏": "–ò–Ω–¥–æ–Ω–µ–∑–∏—è",
    # –†–æ—Å—Å–∏—è
    "—Ä–æ—Å—Å–∏—è": "–†–æ—Å—Å–∏—è", "russia": "–†–æ—Å—Å–∏—è", "—Ä—Ñ": "–†–æ—Å—Å–∏—è",
    "—Å–æ—á–∏": "–†–æ—Å—Å–∏—è", "–∫—Ä—ã–º": "–†–æ—Å—Å–∏—è", "–∞–Ω–∞–ø–∞": "–†–æ—Å—Å–∏—è", "–≥–µ–ª–µ–Ω–¥–∂–∏–∫": "–†–æ—Å—Å–∏—è",
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π": "–†–æ—Å—Å–∏—è", "—á–µ—Ä–Ω–æ–µ –º–æ—Ä–µ": "–†–æ—Å—Å–∏—è",
}

# –°–ø–∏—Å–æ–∫ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
VALID_COUNTRIES = set(COUNTRIES_MAP.values())

# –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
POPULAR_ALTERNATIVES = ["–¢—É—Ä—Ü–∏—è", "–ï–≥–∏–ø–µ—Ç", "–û–ê–≠", "–¢–∞–∏–ª–∞–Ω–¥", "–†–æ—Å—Å–∏—è (–°–æ—á–∏)"]

# ==================== –ò–ó–í–ï–°–¢–ù–´–ï –û–¢–ï–õ–ò (–¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è) ====================
# –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –±—Ä–µ–Ω–¥—ã –∫ —Å—Ç—Ä–∞–Ω–∞–º!
# Rixos, Radisson, Marriott –∏ –¥—Ä. –µ—Å—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∞—Ö (–¢—É—Ä—Ü–∏—è, –°–æ—á–∏, –û–ê–≠...)
# –°—Ç—Ä–∞–Ω—É –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¢–û–õ–¨–ö–û –∏–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!

KNOWN_HOTELS = {
    # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å–µ—Ç–∏ (–µ—Å—Ç—å –≤–µ–∑–¥–µ!)
    "rixos": "Rixos", "—Ä–∏–∫—Å–æ—Å": "Rixos",
    "rixos premium": "Rixos Premium", "—Ä–∏–∫—Å–æ—Å –ø—Ä–µ–º–∏—É–º": "Rixos Premium",
    "radisson": "Radisson", "—Ä—ç–¥–∏—Å—Å–æ–Ω": "Radisson", "—Ä–µ–¥–∏—Å—Å–æ–Ω": "Radisson",
    "marriott": "Marriott", "–º–∞—Ä—Ä–∏–æ—Ç—Ç": "Marriott", "–º–∞—Ä–∏–æ—Ç—Ç": "Marriott",
    "hilton": "Hilton", "—Ö–∏–ª—Ç–æ–Ω": "Hilton",
    "hyatt": "Hyatt", "—Ö–∞—è—Ç—Ç": "Hyatt",
    "sheraton": "Sheraton", "—à–µ—Ä–∞—Ç–æ–Ω": "Sheraton",
    
    # –¢—É—Ä–µ—Ü–∫–∏–µ –±—Ä–µ–Ω–¥—ã (–Ω–æ –ù–ï –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –¢—É—Ä—Ü–∏–∏!)
    "calista": "Calista Luxury Resort", "–∫–∞–ª–∏—Å—Ç": "Calista Luxury Resort",
    "regnum": "Regnum Carya", "—Ä–µ–≥–Ω—É–º": "Regnum Carya",
    "titanic": "Titanic", "—Ç–∏—Ç–∞–Ω–∏–∫": "Titanic",
    "gloria serenity": "Gloria Serenity Resort",
    "maxx royal": "Maxx Royal", "–º–∞–∫—Å —Ä–æ—è–ª": "Maxx Royal",
    "orange county": "Orange County Resort", "–æ—Ä–∞–Ω–∂ –∫–∞—É–Ω—Ç–∏": "Orange County Resort",
    "voyage belek": "Voyage Belek", "–≤–æ—è–∂ –±–µ–ª–µ–∫": "Voyage Belek",
    "delphin": "Delphin Hotel", "–¥–µ–ª—å—Ñ–∏–Ω": "Delphin Hotel",
    "barut": "Barut Hotels", "–±–∞—Ä—É—Ç": "Barut Hotels",
    
    # –ï–≥–∏–ø–µ—Ç—Å–∫–∏–µ –±—Ä–µ–Ω–¥—ã
    "steigenberger": "Steigenberger", "—à—Ç–∞–π–≥–µ–Ω–±–µ—Ä–≥–µ—Ä": "Steigenberger",
    "rixos sharm": "Rixos Sharm El Sheikh",
    "sunrise": "Sunrise Hotels", "—Å–∞–Ω—Ä–∞–π–∑": "Sunrise Hotels",
    "jaz": "Jaz Hotels", "–¥–∂–∞–∑": "Jaz Hotels",
    
    # –û–ê–≠ –±—Ä–µ–Ω–¥—ã
    "atlantis": "Atlantis The Palm", "–∞—Ç–ª–∞–Ω—Ç–∏—Å": "Atlantis The Palm",
    "jumeirah": "Jumeirah Hotels", "–¥–∂—É–º–µ–π—Ä": "Jumeirah Hotels",
    "burj al arab": "Burj Al Arab", "–±—É—Ä–¥–∂ –∞–ª—å –∞—Ä–∞–±": "Burj Al Arab",
}

RESORTS_MAP = {
    # –¢—É—Ä—Ü–∏—è
    "–±–µ–ª–µ–∫": ("–¢—É—Ä—Ü–∏—è", "–ë–µ–ª–µ–∫"), "–∫–µ–º–µ—Ä": ("–¢—É—Ä—Ü–∏—è", "–ö–µ–º–µ—Ä"),
    "–∞–Ω—Ç–∞–ª—å—è": ("–¢—É—Ä—Ü–∏—è", "–ê–Ω—Ç–∞–ª—å—è"), "–∞–Ω—Ç–∞–ª–∏—è": ("–¢—É—Ä—Ü–∏—è", "–ê–Ω—Ç–∞–ª—å—è"),
    "—Å–∏–¥–µ": ("–¢—É—Ä—Ü–∏—è", "–°–∏–¥–µ"), "–∞–ª–∞–Ω–∏—è": ("–¢—É—Ä—Ü–∏—è", "–ê–ª–∞–Ω–∏—è"),
    "–±–æ–¥—Ä—É–º": ("–¢—É—Ä—Ü–∏—è", "–ë–æ–¥—Ä—É–º"), "–º–∞—Ä–º–∞—Ä–∏—Å": ("–¢—É—Ä—Ü–∏—è", "–ú–∞—Ä–º–∞—Ä–∏—Å"),
    # –ï–≥–∏–ø–µ—Ç
    "—à–∞—Ä–º": ("–ï–≥–∏–ø–µ—Ç", "–®–∞—Ä–º-—ç–ª—å-–®–µ–π—Ö"), "—à–∞—Ä–º-—ç–ª—å-—à–µ–π—Ö": ("–ï–≥–∏–ø–µ—Ç", "–®–∞—Ä–º-—ç–ª—å-–®–µ–π—Ö"),
    "—Ö—É—Ä–≥–∞–¥–∞": ("–ï–≥–∏–ø–µ—Ç", "–•—É—Ä–≥–∞–¥–∞"),
    # –†–æ—Å—Å–∏—è
    "—Å–æ—á–∏": ("–†–æ—Å—Å–∏—è", "–°–æ—á–∏"), "–∞–¥–ª–µ—Ä": ("–†–æ—Å—Å–∏—è", "–ê–¥–ª–µ—Ä"),
    "–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª—è–Ω–∞": ("–†–æ—Å—Å–∏—è", "–ö—Ä–∞—Å–Ω–∞—è –ü–æ–ª—è–Ω–∞"), "—Ä–æ–∑–∞ —Ö—É—Ç–æ—Ä": ("–†–æ—Å—Å–∏—è", "–†–æ–∑–∞ –•—É—Ç–æ—Ä"),
    "–∞–Ω–∞–ø–∞": ("–†–æ—Å—Å–∏—è", "–ê–Ω–∞–ø–∞"), "–≥–µ–ª–µ–Ω–¥–∂–∏–∫": ("–†–æ—Å—Å–∏—è", "–ì–µ–ª–µ–Ω–¥–∂–∏–∫"),
    "–∫—Ä—ã–º": ("–†–æ—Å—Å–∏—è", "–ö—Ä—ã–º"), "—è–ª—Ç–∞": ("–†–æ—Å—Å–∏—è", "–Ø–ª—Ç–∞"), "—Å–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å": ("–†–æ—Å—Å–∏—è", "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"),
}


# ==================== SEARCH MODES (Strict Slot Filling) ====================
def detect_search_mode(text: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –†–µ–∂–∏–º—ã:
    - "hotel_only" ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å (–ù–ï —Ç—Ä–µ–±—É–µ—Ç departure_city)
    - "burning" ‚Äî –≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã (–≥–∏–±–∫–∏–µ –¥–∞—Ç—ã)
    - "package" ‚Äî –ø–∞–∫–µ—Ç–Ω—ã–π —Ç—É—Ä (—Ç—Ä–µ–±—É–µ—Ç departure_city)
    """
    text_lower = text.lower()
    
    # –†–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å" (–±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç–∞) ‚Äî –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –ü–û–ö–†–´–¢–ò–ï!
    hotel_only_triggers = [
        # –Ø–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        "–±–µ–∑ –ø–µ—Ä–µ–ª–µ—Ç", "–±–µ–∑ –ø–µ—Ä–µ–ª—ë—Ç", "–±–µ–∑ —Å–∞–º–æ–ª–µ—Ç", "–±–µ–∑ —Å–∞–º–æ–ª—ë—Ç",
        "—Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å", "—Ç–æ–ª—å–∫–æ –≥–æ—Å—Ç–∏–Ω–∏—Ü", "—Ç–æ–ª—å–∫–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ",
        "–æ—Ç–µ–ª—å –±–µ–∑", "–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞ –±–µ–∑",
        # –¢–∏–ø—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        "–ø–∞–Ω—Å–∏–æ–Ω–∞—Ç", "–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "—Å–∞–Ω–∞—Ç–æ—Ä", "–±–∞–∑–∞ –æ—Ç–¥—ã—Ö–∞",
        "—Ö–æ—Å—Ç–µ–ª", "–≥–æ—Å—Ç–µ–≤–æ–π –¥–æ–º", "–≥–ª—ç–º–ø–∏–Ω–≥",
        # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
        "–Ω–∞–∑–µ–º–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", "–Ω–∞–∑–µ–º–∫–∞", "ground service",
        "–±–µ–∑ –∞–≤–∏–∞", "–±–µ–∑ –±–∏–ª–µ—Ç", "–±–µ–∑ –ø–µ—Ä–µ–≤–æ–∑–∫",
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ (–†–æ—Å—Å–∏—è)
        "—Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤", "–æ—Ç–¥—ã—Ö –≤ —Å–æ—á–∏", "–æ—Ç–¥—ã—Ö –≤ –∫—Ä—ã–º",
    ]
    for trigger in hotel_only_triggers:
        if trigger in text_lower:
            logger.info(f"üîç DETECTED SEARCH MODE: hotel_only (trigger: '{trigger}')")
            return "hotel_only"
    
    # –†–µ–∂–∏–º "–≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã"
    burning_triggers = [
        "–≥–æ—Ä—è—â", "–≥–æ—Ä—è—á–∏–π", "—Å—Ä–æ—á–Ω–æ",
        "–±–ª–∏–∂–∞–π—à–∏–π –≤—ã–ª–µ—Ç", "–Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ",
        "–ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–Ω—É—Ç–∞", "last minute",
        "–¥–µ—à—ë–≤—ã–π —Ç—É—Ä", "–¥–µ—à–µ–≤—ã–π —Ç—É—Ä"
    ]
    for trigger in burning_triggers:
        if trigger in text_lower:
            logger.info(f"üîç DETECTED SEARCH MODE: burning (trigger: '{trigger}')")
            return "burning"
    
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–∞–∫–µ—Ç–Ω—ã–π —Ç—É—Ä
    logger.info("üîç DETECTED SEARCH MODE: package (default)")
    return "package"


FOOD_TYPE_MAP = {
    # All Inclusive
    "–≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ": FoodType.AI, "–≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ": FoodType.AI, "–≤—Å—ë –≤–∫–ª": FoodType.AI,
    "all inclusive": FoodType.AI, "ai": FoodType.AI, "–æ–ª–ª –∏–Ω–∫–ª—é–∑–∏–≤": FoodType.AI,
    
    # Ultra All Inclusive
    "—É–ª—å—Ç—Ä–∞ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ": FoodType.UAI, "—É–ª—å—Ç—Ä–∞ –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ": FoodType.UAI,
    "—É–ª—å—Ç—Ä–∞": FoodType.UAI, "ultra": FoodType.UAI, "uai": FoodType.UAI,
    
    # Bed & Breakfast
    "–∑–∞–≤—Ç—Ä–∞–∫": FoodType.BB, "–∑–∞–≤—Ç—Ä–∞–∫–∏": FoodType.BB, "—Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫": FoodType.BB,
    "—Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫–∏": FoodType.BB, "bb": FoodType.BB, "bed and breakfast": FoodType.BB,
    
    # Half Board (–∑–∞–≤—Ç—Ä–∞–∫ + —É–∂–∏–Ω)
    "–ø–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω": FoodType.HB, "hb": FoodType.HB, "half board": FoodType.HB,
    "–∑–∞–≤—Ç—Ä–∞–∫ –∏ —É–∂–∏–Ω": FoodType.HB, "–∑–∞–≤—Ç—Ä–∞–∫ —É–∂–∏–Ω": FoodType.HB,
    
    # Full Board (—Ç—Ä—ë—Ö—Ä–∞–∑–æ–≤–æ–µ)
    "–ø–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω": FoodType.FB, "fb": FoodType.FB, "full board": FoodType.FB,
    "—Ç—Ä—ë—Ö—Ä–∞–∑–æ–≤–æ–µ": FoodType.FB, "—Ç—Ä–µ—Ö—Ä–∞–∑–æ–≤–æ–µ": FoodType.FB, "—Ç—Ä–∏ —Ä–∞–∑–∞": FoodType.FB,
    
    # Room Only (–±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è)
    "–±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è": FoodType.RO, "ro": FoodType.RO, "room only": FoodType.RO,
}

# ==================== GREETING CLEANER (Python Regex) ====================
# –£–¥–∞–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ "–º—É—Å–æ—Ä–Ω—ã–µ" —Ñ—Ä–∞–∑—ã –∏–∑ –Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç–∞

def clean_response_text(text: str, is_first_message: bool = False) -> str:
    """
    –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ "–º—É—Å–æ—Ä–Ω—ã—Ö" —Ñ—Ä–∞–∑.
    
    Args:
        text: –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        is_first_message: True –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–µ—Å—Å–∏–∏ (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
    
    Returns:
        –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    if not text or is_first_message:
        return text
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏)
    garbage_patterns = [
        r'^(–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ|–ü—Ä–∏–≤–µ—Ç|–î–æ–±—Ä—ã–π –¥–µ–Ω—å|–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä|–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ)[!,.\s]*',
        r'^(Hello|Hi|Hey)[!,.\s]*',
        r'^(–ü–æ–Ω—è–ª –≤–∞—Å|–ü—Ä–∏–Ω—è—Ç–æ|–•–æ—Ä–æ—à–æ|–û—Ç–ª–∏—á–Ω–æ|–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä|–•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä)[!,.\s]*',
        r'^(–Ø –ø–æ–º–æ–≥—É –≤–∞–º|–Ø –ø–æ–¥–±–µ—Ä—É|–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º|–†–∞–¥ –ø–æ–º–æ—á—å)[^.!?]*[.!?]?\s*',
        r'^(–Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç|–Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫|–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç)[^.!?]*[.!?]?\s*',
        r'^(–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ|–ë–ª–∞–≥–æ–¥–∞—Ä—é)[^.!?]*[.!?]?\s*',
    ]
    
    cleaned = text.strip()
    
    for pattern in garbage_patterns:
        cleaned = re.sub(pattern, '', cleaned, flags=re.IGNORECASE | re.MULTILINE)
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã –≤ –Ω–∞—á–∞–ª–µ
    cleaned = cleaned.strip()
    
    # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –ø—É—Å—Ç–æ ‚Äî –≤–µ—Ä–Ω—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    if not cleaned:
        return text.strip()
    
    return cleaned


# ==================== –ú–ê–ü–ü–ò–ù–ì –£–°–õ–£–ì –û–¢–ï–õ–ï–ô (GAP Analysis) ====================
# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -> —Ç–∏–ø —É—Å–ª—É–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ

SERVICES_KEYWORDS = {
    # –¢–∏–ø –ø–ª—è–∂–∞
    "–ø–µ—Å—á–∞–Ω—ã–π –ø–ª—è–∂": "–ø–µ—Å—á–∞–Ω—ã–π",
    "–ø–µ—Å–æ–∫": "–ø–µ—Å—á–∞–Ω—ã–π",
    "–ø–µ—Å–æ—á–µ–∫": "–ø–µ—Å—á–∞–Ω—ã–π",
    "–≥–∞–ª–µ—á–Ω—ã–π –ø–ª—è–∂": "–≥–∞–ª–µ—á–Ω—ã–π",
    "–≥–∞–ª—å–∫–∞": "–≥–∞–ª–µ—á–Ω—ã–π",
    # –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    "1-—è –ª–∏–Ω–∏—è": "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
    "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è": "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
    "–Ω–∞ –±–µ—Ä–µ–≥—É": "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
    "—É –º–æ—Ä—è": "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
    "—É —Å–∞–º–æ–≥–æ –º–æ—Ä—è": "–ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
    # –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
    "–∞–∫–≤–∞–ø–∞—Ä–∫": "–∞–∫–≤–∞–ø–∞—Ä–∫",
    "–≥–æ—Ä–∫–∏": "–≥–æ—Ä–∫–∏",
    "–≤–æ–¥–Ω—ã–µ –≥–æ—Ä–∫–∏": "–≥–æ—Ä–∫–∏",
    # –î–ª—è –¥–µ—Ç–µ–π
    "–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±": "–¥–µ—Ç—Å–∫–∏–π",
    "–∞–Ω–∏–º–∞—Ü–∏—è": "–∞–Ω–∏–º–∞—Ü–∏—è",
    "–¥–ª—è –¥–µ—Ç–µ–π": "–¥–µ—Ç—Å–∫–∏–π",
    "—Å –¥–µ—Ç—å–º–∏": "–¥–µ—Ç—Å–∫–∏–π",
    # SPA
    "—Å–ø–∞": "spa",
    "spa": "spa",
    "–±–∞—Å—Å–µ–π–Ω": "–±–∞—Å—Å–µ–π–Ω",
    "–ø–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º—ã–π –±–∞—Å—Å–µ–π–Ω": "–ø–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º—ã–π",
    "–∫—Ä—ã—Ç—ã–π –±–∞—Å—Å–µ–π–Ω": "–∫—Ä—ã—Ç—ã–π –±–∞—Å—Å–µ–π–Ω",
}

# ==================== –ú–ê–ü–ü–ò–ù–ì –¢–ò–ü–û–í –û–¢–ï–õ–ï–ô (GAP Analysis) ====================
# –ü–∞—Ä–∞–º–µ—Ç—Ä hoteltypes –¥–ª—è search.php

HOTEL_TYPES_MAP = {
    # –°–µ–º–µ–π–Ω—ã–π –æ—Ç–¥—ã—Ö
    "—Å–µ–º–µ–π–Ω—ã–π": "family",
    "–¥–ª—è —Å–µ–º—å–∏": "family",
    "—Å–µ–º–µ–π–Ω—ã–π –æ—Ç–µ–ª—å": "family",
    "—Å–µ–º—å–µ–π": "family",
    # VIP / –õ—é–∫—Å
    "vip": "deluxe",
    "–≤–∏–ø": "deluxe",
    "–ª—é–∫—Å": "deluxe",
    "–ø—Ä–µ–º–∏—É–º": "deluxe",
    "—Ä–æ—Å–∫–æ—à–Ω—ã–π": "deluxe",
    "luxury": "deluxe",
    # –ü–ª—è–∂–Ω—ã–π
    "–ø–ª—è–∂–Ω—ã–π": "beach",
    "–Ω–∞ –ø–ª—è–∂–µ": "beach",
    # –ì–æ—Ä–æ–¥—Å–∫–æ–π
    "–≥–æ—Ä–æ–¥—Å–∫–æ–π": "city",
    "–≤ –≥–æ—Ä–æ–¥–µ": "city",
    # –ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö
    "–∞–∫—Ç–∏–≤–Ω—ã–π": "active",
    "—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π": "active",
    # –°–ø–æ–∫–æ–π–Ω—ã–π –æ—Ç–¥—ã—Ö
    "—Å–ø–æ–∫–æ–π–Ω—ã–π": "relax",
    "—Ä–µ–ª–∞–∫—Å": "relax",
    "—Ç–∏—Ö–∏–π": "relax",
    # –û–∑–¥–æ—Ä–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π
    "–æ–∑–¥–æ—Ä–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π": "health",
    "–ª–µ—á–µ–±–Ω—ã–π": "health",
    "—Å–∞–Ω–∞—Ç–æ—Ä–∏–π": "health",
}

# ==================== –ú–ê–ü–ü–ò–ù–ì –¢–ò–ü–û–í –¢–£–†–û–í (GAP Analysis) ====================
# –ü–∞—Ä–∞–º–µ—Ç—Ä tourtype –¥–ª—è search.php

TOUR_TYPES_MAP = {
    "–ø–ª—è–∂–Ω—ã–π": 1,
    "–ø–ª—è–∂": 1,
    "–º–æ—Ä–µ": 1,
    "–≥–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–π": 2,
    "–ª—ã–∂–∏": 2,
    "–≥–æ—Ä—ã": 2,
    "—ç–∫—Å–∫—É—Ä—Å–∏–æ–Ω–Ω—ã–π": 3,
    "—ç–∫—Å–∫—É—Ä—Å–∏–∏": 3,
    "—ç–∫—Å–∫—É—Ä—Å–∏—è": 3,
}

DEPARTURE_CITIES = {
    "–º–æ—Å–∫–≤–∞": "–ú–æ—Å–∫–≤–∞", "–º–æ—Å–∫–≤—ã": "–ú–æ—Å–∫–≤–∞", "–º—Å–∫": "–ú–æ—Å–∫–≤–∞",
    "–ø–∏—Ç–µ—Ä": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
    "–∫–∞–∑–∞–Ω—å": "–ö–∞–∑–∞–Ω—å", "–∫–∞–∑–∞–Ω–∏": "–ö–∞–∑–∞–Ω—å",
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–µ–∫–±": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–Ω–æ–≤–æ—Å–∏–±": "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä": "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä",
    "—Å–æ—á–∏": "–°–æ—á–∏",
    "—Ä–æ—Å—Ç–æ–≤": "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
    "—Å–∞–º–∞—Ä–∞": "–°–∞–º–∞—Ä–∞",
    "—É—Ñ–∞": "–£—Ñ–∞",
    "–Ω–∏–∂–Ω–∏–π": "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
    "–≤–æ—Ä–æ–Ω–µ–∂": "–í–æ—Ä–æ–Ω–µ–∂",
    "–ø–µ—Ä–º—å": "–ü–µ—Ä–º—å",
    "—á–µ–ª—è–±–∏–Ω—Å–∫": "–ß–µ–ª—è–±–∏–Ω—Å–∫",
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫",
    "–º–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –≤–æ–¥—ã": "–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã", "–º–∏–Ω–≤–æ–¥—ã": "–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –í–æ–¥—ã",
}


def extract_entities_regex(text: str) -> dict:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
    text_lower = text.lower()
    entities = {}
    
    # ==================== –ì–û–†–Ø–©–ò–ï –¢–£–†–´ / –°–†–û–ß–ù–û ====================
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç "–≥–æ—Ä—è—â–∏–π —Ç—É—Ä" ‚Äî –¥–∞—Ç–∞ = –∑–∞–≤—Ç—Ä–∞
    # –ù–û: –ù–ï —Å—Ç–∞–≤–∏–º nights –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ê–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–æ—Å–∏—Ç—å.
    if any(word in text_lower for word in ["–≥–æ—Ä—è—â", "–≥–æ—Ä—è—á–∏–π", "—Å—Ä–æ—á–Ω–æ", "–Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ", "–±–ª–∏–∂–∞–π—à–∏–π –≤—ã–ª–µ—Ç"]):
        entities["is_hot_tour"] = True
        # –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ = –∑–∞–≤—Ç—Ä–∞ (—ç—Ç–æ —Ä–∞–∑—É–º–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç –¥–ª—è "–≥–æ—Ä—è—â–∏—Ö")
        entities["date_from"] = date.today() + timedelta(days=1)
        # –ù–ï –°–¢–ê–í–ò–ú nights! –ê–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–æ—Å–∏—Ç—å "–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π?"
    
    # 1. –°—Ç—Ä–∞–Ω–∞ (–∏–∑ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞)
    country_found = False
    for key, country in COUNTRIES_MAP.items():
        if key in text_lower:
            entities["destination_country"] = country
            country_found = True
            break
    
    # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Äî –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—É—é
    # –ü–∞—Ç—Ç–µ—Ä–Ω: "—Ö–æ—á—É –≤ [–°—Ç—Ä–∞–Ω–∞]", "–ø–æ–µ—Ö–∞—Ç—å –≤ [–°—Ç—Ä–∞–Ω–∞]", "–≤ [–°—Ç—Ä–∞–Ω–∞]—É" –∏ —Ç.–¥.
    if not country_found:
        # –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–∞–Ω–∞–º–∏
        skip_words = {
            # –ú–µ—Å—è—Ü—ã
            "—è–Ω–≤–∞—Ä–µ", "—Ñ–µ–≤—Ä–∞–ª–µ", "–º–∞—Ä—Ç–µ", "–∞–ø—Ä–µ–ª–µ", "–º–∞–µ", "–∏—é–Ω–µ", 
            "–∏—é–ª–µ", "–∞–≤–≥—É—Å—Ç–µ", "—Å–µ–Ω—Ç—è–±—Ä–µ", "–æ–∫—Ç—è–±—Ä–µ", "–Ω–æ—è–±—Ä–µ", "–¥–µ–∫–∞–±—Ä–µ",
            # –ì–æ—Ä–æ–¥–∞
            "–º–æ—Å–∫–≤—É", "–º–æ—Å–∫–≤—ã", "–º–æ—Å–∫–≤–µ", "–ø–∏—Ç–µ—Ä", "–ø–∏—Ç–µ—Ä–∞", "–∫–∞–∑–∞–Ω—å", "–∫–∞–∑–∞–Ω–∏",
            # –û—Ç–µ–ª–∏
            "–æ—Ç–µ–ª—å", "–æ—Ç–µ–ª–µ", "–æ—Ç–µ–ª—é",
            # –î—Ä—É–≥–∏–µ —Å–ª–æ–≤–∞
            "—Ç—É—Ä", "—Ç—É—Ä–µ", "–ø–æ–µ–∑–¥–∫—É", "–æ—Ç–ø—É—Å–∫",
        }
        
        unknown_country_patterns = [
            r'(?:—Ö–æ—á—É|–ø–æ–µ–¥—É|–ø–æ–µ—Ö–∞—Ç—å|—Å–ª–µ—Ç–∞—Ç—å|–æ—Ç–¥–æ—Ö–Ω—É—Ç—å|—Ç—É—Ä)\s+–≤\s+([–∞-—è—ë]+)\b',
        ]
        for pattern in unknown_country_patterns:
            match = re.search(pattern, text_lower)
            if match:
                potential_country = match.group(1)
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ skip_word –∏ –¥–ª–∏–Ω–∞ > 3
                if potential_country not in skip_words and len(potential_country) > 3:
                    # –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    entities["destination_country"] = potential_country.title()
                    break
    
    # 2. –ö—É—Ä–æ—Ä—Ç
    for key, (country, resort) in RESORTS_MAP.items():
        if key in text_lower:
            entities["destination_country"] = country
            entities["destination_resort"] = resort
            break
    
    # 3. –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–í–ê–ñ–ù–û!)
    for key, city in DEPARTURE_CITIES.items():
        if key in text_lower:
            entities["departure_city"] = city
            break
    
    # 4. –î–∞—Ç—ã
    months_map = {
        "—è–Ω–≤–∞—Ä—è": 1, "—Ñ–µ–≤—Ä–∞–ª—è": 2, "–º–∞—Ä—Ç–∞": 3, "–∞–ø—Ä–µ–ª—è": 4,
        "–º–∞—è": 5, "–∏—é–Ω—è": 6, "–∏—é–ª—è": 7, "–∞–≤–≥—É—Å—Ç–∞": 8,
        "—Å–µ–Ω—Ç—è–±—Ä—è": 9, "–æ–∫—Ç—è–±—Ä—è": 10, "–Ω–æ—è–±—Ä—è": 11, "–¥–µ–∫–∞–±—Ä—è": 12
    }
    
    dates_found = []
    
    # dd.mm.yyyy
    for match in re.finditer(r'(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?', text):
        day, month = int(match.group(1)), int(match.group(2))
        year = int(match.group(3)) if match.group(3) else date.today().year
        if year < 100:
            year += 2000
        try:
            d = date(year, month, day)
            if d < date.today():
                d = date(year + 1, month, day)
            dates_found.append(d)
        except ValueError:
            pass
    
    # "dd –º–µ—Å—è—Ü–∞"
    for match in re.finditer(r'(\d{1,2})\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)', text_lower):
        day = int(match.group(1))
        month = months_map[match.group(2)]
        year = date.today().year
        try:
            d = date(year, month, day)
            if d < date.today():
                d = date(year + 1, month, day)
            dates_found.append(d)
        except ValueError:
            pass
    
    # –ú–µ—Å—è—Ü –±–µ–∑ –¥–∞—Ç—ã ‚Äî –¥–æ–ø—É—Å–∫–∞–µ–º –∏ —Å –ø—Ä–µ–¥–ª–æ–≥–æ–º –∏ –±–µ–∑
    if not dates_found:
        month_patterns = [
            (r'(?:–≤|–Ω–∞|–∫)?\s*—è–Ω–≤–∞—Ä[–µ—å—è]?', 1), (r'(?:–≤|–Ω–∞|–∫)?\s*—Ñ–µ–≤—Ä–∞–ª[–µ—å—è]?', 2),
            (r'(?:–≤|–Ω–∞|–∫)?\s*–º–∞—Ä—Ç[–µ–∞]?', 3), (r'(?:–≤|–Ω–∞|–∫)?\s*–∞–ø—Ä–µ–ª[–µ—å—è]?', 4),
            (r'(?:–≤|–Ω–∞|–∫)?\s*–º–∞[–π—é–µ—è]', 5), (r'(?:–≤|–Ω–∞|–∫)?\s*–∏—é–Ω[–µ—å—è]?', 6),
            (r'(?:–≤|–Ω–∞|–∫)?\s*–∏—é–ª[–µ—å—è]?', 7), (r'(?:–≤|–Ω–∞|–∫)?\s*–∞–≤–≥—É—Å—Ç[–µ–∞]?', 8),
            (r'(?:–≤|–Ω–∞|–∫)?\s*—Å–µ–Ω—Ç—è–±—Ä[–µ—å—è]?', 9), (r'(?:–≤|–Ω–∞|–∫)?\s*–æ–∫—Ç—è–±—Ä[–µ—å—è]?', 10),
            (r'(?:–≤|–Ω–∞|–∫)?\s*–Ω–æ—è–±—Ä[–µ—å—è]?', 11), (r'(?:–≤|–Ω–∞|–∫)?\s*–¥–µ–∫–∞–±—Ä[–µ—å—è]?', 12),
        ]
        
        for pattern, month_num in month_patterns:
            if re.search(pattern, text_lower):
                year = date.today().year
                try:
                    target = date(year, month_num, 1)
                    if target < date.today():
                        target = date(year + 1, month_num, 1)
                    dates_found.append(target)
                except ValueError:
                    pass
                break
    
    if dates_found:
        dates_found.sort()
        # === –í–ê–õ–ò–î–ê–¶–ò–Ø: –¥–∞—Ç–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º! ===
        valid_dates = [d for d in dates_found if d >= date.today()]
        if valid_dates:
            entities["date_from"] = valid_dates[0]
            # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –¢–û–ß–ù–ê–Ø (—É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å)
            entities["is_exact_date"] = True
            # === STRICT SLOT FILLING: –¥–∞—Ç–∞ –Ø–í–ù–û –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! ===
            entities["dates_confirmed"] = True
        if len(dates_found) > 1:
            entities["date_to"] = dates_found[-1]
            entities["nights"] = (dates_found[-1] - dates_found[0]).days
    
    # 5. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π
    # –ö–†–ò–¢–ò–ß–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî nights –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å > 21 –±–µ–∑ –Ø–í–ù–û–ì–û –∑–∞–ø—Ä–æ—Å–∞!
    nights_match = re.search(r'(\d+)\s*(?:–Ω–æ—á|–Ω–æ—á–µ–π|–Ω–æ—á–∏|–¥–Ω–µ–π|–¥–Ω—è|–¥–µ–Ω—å)', text_lower)
    if nights_match:
        nights = int(nights_match.group(1))
        # –†–∞–∑—É–º–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: 1-21 –Ω–æ—á–µ–π (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç—É—Ä—ã)
        # –ë–æ–ª–µ–µ 21 –Ω–æ—á–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ –∑–∞–ø—Ä–æ—Å–∏–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "30 –Ω–æ—á–µ–π")
        if 1 <= nights <= 21:
            entities["nights"] = nights
            if "date_from" in entities and "date_to" not in entities:
                entities["date_to"] = entities["date_from"] + timedelta(days=nights)
        elif nights > 21 and nights <= 30:
            # –î–ª–∏–Ω–Ω—ã–π —Ç—É—Ä ‚Äî –ø–æ–º–µ—á–∞–µ–º —è–≤–Ω–æ, –Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ–º
            entities["nights"] = nights
            entities["long_stay_explicit"] = True
            if "date_from" in entities and "date_to" not in entities:
                entities["date_to"] = entities["date_from"] + timedelta(days=nights)
        # –ï—Å–ª–∏ > 30 ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∫–∞/–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è)
    
    # 6. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö
    # –í–ê–ñ–ù–û: –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ > 6 (–¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫)
    adults_match = re.search(r'(\d+)\s*(?:–≤–∑—Ä–æ—Å–ª|—á–µ–ª–æ–≤–µ–∫|—á–µ–ª\.)', text_lower)
    if adults_match:
        adults = int(adults_match.group(1))
        if 1 <= adults <= 20:  # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ 20 –¥–ª—è –≥—Ä—É–ø–ø
            entities["adults"] = adults
            entities["adults_explicit"] = True  # –Ø–í–ù–û —É–∫–∞–∑–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!
    
    # –°–ª–æ–≤–∞ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–∏—Å–ª–æ)
    if "adults" not in entities:
        if re.search(r'–≤–¥–≤–æ[–µ—ë]–º|–¥–≤–æ–µ|–Ω–∞ –¥–≤–æ–∏—Ö|–¥–ª—è –¥–≤–æ–∏—Ö', text_lower):
            entities["adults"] = 2
            entities["adults_explicit"] = True
        elif re.search(r'–≤—Ç—Ä–æ[–µ—ë]–º|—Ç—Ä–æ–µ|–Ω–∞ —Ç—Ä–æ–∏—Ö|–¥–ª—è —Ç—Ä–æ–∏—Ö', text_lower):
            entities["adults"] = 3
            entities["adults_explicit"] = True
        elif re.search(r'–≤—á–µ—Ç–≤–µ—Ä–æ–º|—á–µ—Ç–≤–µ—Ä–æ|–Ω–∞ —á–µ—Ç–≤–µ—Ä—ã—Ö', text_lower):
            entities["adults"] = 4
            entities["adults_explicit"] = True
        elif re.search(r'–æ–¥–∏–Ω|–æ–¥–Ω–æ–≥–æ|—Å–∞–º\b|–æ–¥–Ω–∞\b', text_lower):
            entities["adults"] = 1
            entities["adults_explicit"] = True
    
    # –£–ë–†–ê–ù–û: –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ adults=2 ‚Äî —Ç–µ–ø–µ—Ä—å –∞–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–æ—Å–∏—Ç—å!
    # –ï—Å–ª–∏ adults –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Äî –ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç
    
    # 7. –î–µ—Ç–∏ (–ö–†–ò–¢–ò–ß–ù–û: –≤–æ–∑—Ä–∞—Å—Ç –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù!)
    children_ages = []
    children_count = 0  # –°—á—ë—Ç—á–∏–∫ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –¥–µ—Ç–µ–π
    
    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
    age_patterns = [
        r'(?:—Ä–µ–±[–µ—ë]–Ω(?:–æ?–∫)?|–¥–æ—á—å?|—Å—ã–Ω|–¥–æ—á–∫[–µ—É–∞]|—Å—ã–Ω[—É–∞]?)\s*(?:,?\s*)?(\d{1,2})\s*(?:–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞)',
        r'—Å\s+—Ä–µ–±[–µ—ë]–Ω–∫–æ–º\s+(\d{1,2})',
        r'(\d{1,2})\s*(?:–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞)(?:\s+—Ä–µ–±[–µ—ë]–Ω–∫)?',
        r'–≤–æ–∑—Ä–∞—Å—Ç(?:–∞|–æ–º)?\s*(?:–¥–µ—Ç–µ–π|—Ä–µ–±–µ–Ω–∫[–∞—É])?\s*[\-:]?\s*(\d{1,2})',
        r'(?:–µ–º—É|–µ–π|–∏–º)\s+(\d{1,2})\s*(?:–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞)?',
    ]
    for pattern in age_patterns:
        matches = re.findall(pattern, text_lower)
        for m in matches:
            age = int(m) if isinstance(m, str) else int(m[0]) if isinstance(m, tuple) else int(m)
            if 0 <= age <= 17 and age not in children_ages:
                children_ages.append(age)
    
    # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–æ–∑—Ä–∞—Å—Ç—ã: "5 –∏ 10 –ª–µ—Ç", "–¥–µ—Ç—è–º 3 –∏ 7"
    multi_age_match = re.search(r'(\d{1,2})\s*(?:–∏|,)\s*(\d{1,2})\s*(?:–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞)', text_lower)
    if multi_age_match:
        for i in [1, 2]:
            age = int(multi_age_match.group(i))
            if 0 <= age <= 17 and age not in children_ages:
                children_ages.append(age)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –¥–µ—Ç–µ–π –ë–ï–ó –≤–æ–∑—Ä–∞—Å—Ç–∞
    # "—Å —Ä–µ–±–µ–Ω–∫–æ–º", "—Å –¥–µ—Ç—å–º–∏", "2 –¥–µ—Ç–µ–π" –∏ —Ç.–¥.
    children_mentioned_patterns = [
        (r'—Å\s+—Ä–µ–±[–µ—ë]–Ω–∫–æ–º', 1),
        (r'—Å\s+–¥–µ—Ç(?:—å–º–∏|–µ–π)', 0),  # –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        (r'(\d+)\s+(?:—Ä–µ–±[–µ—ë]–Ω|–¥–µ—Ç)', None),  # –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ
        (r'—Ä–µ–±[–µ—ë]–Ω(?:–æ?–∫|–∫–∞)', 1),
        (r'–¥–µ—Ç–∏', 0),  # –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ
        (r'–¥–≤–æ–µ\s+–¥–µ—Ç–µ–π', 2),
        (r'—Ç—Ä–æ–µ\s+–¥–µ—Ç–µ–π', 3),
    ]
    
    for pattern, count in children_mentioned_patterns:
        match = re.search(pattern, text_lower)
        if match:
            if count is None:  # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ –≥—Ä—É–ø–ø—ã
                children_count = max(children_count, int(match.group(1)))
            elif count > 0:
                children_count = max(children_count, count)
            else:  # count == 0 ‚Äî –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–¥–µ—Ç–µ–π"
                if children_count == 0:
                    children_count = 1  # –ú–∏–Ω–∏–º—É–º 1
    
    if children_ages:
        entities["children"] = children_ages
        entities["children_count"] = len(children_ages)
    
    # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –¥–µ—Ç–∏, –Ω–æ –≤–æ–∑—Ä–∞—Å—Ç –ù–ï —É–∫–∞–∑–∞–Ω ‚Äî –ø–æ–º–µ—á–∞–µ–º!
    if children_count > 0 and not children_ages:
        entities["children_mentioned"] = True
        entities["children_count_mentioned"] = children_count
        # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º children —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –≤–æ–∑—Ä–∞—Å—Ç–æ–º!
    
    # ==================== –ü–†–û–í–ï–†–ö–ê "–ë–ï–ó –î–ï–¢–ï–ô" ====================
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —Å–∫–∞–∑–∞–ª —á—Ç–æ –±–µ–∑ –¥–µ—Ç–µ–π ‚Äî –ø–æ–º–µ—á–∞–µ–º
    no_children_patterns = [
        r'–±–µ–∑\s+–¥–µ—Ç',
        r'–¥–µ—Ç–µ–π\s+–Ω–µ—Ç',
        r'–Ω–µ—Ç\s+–¥–µ—Ç–µ–π',
        r'—Ç–æ–ª—å–∫–æ\s+–≤–∑—Ä–æ—Å–ª',
        r'–æ–¥–Ω–∏\s+–≤–∑—Ä–æ—Å–ª',
        r'–≤–∑—Ä–æ—Å–ª—ã–µ\s+–±–µ–∑',
    ]
    for pattern in no_children_patterns:
        if re.search(pattern, text_lower):
            entities["no_children_explicit"] = True
            entities["children_mentioned"] = False  # –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ —á—Ç–æ –¥–µ—Ç–µ–π –Ω–µ—Ç
            break
    
    # ==================== –°–ï–ú–ê–ù–¢–ò–ö–ê –°–û–°–¢–ê–í–ê "–Ø –∏ —Å—ã–Ω" / "–ú—ã —Å –º—É–∂–µ–º" ====================
    # "—è –∏ —Å—ã–Ω/–¥–æ—á—å" ‚Üí adults=1 + —Ä–µ–±—ë–Ω–æ–∫
    if re.search(r'—è\s+(?:–∏|—Å)\s+(?:—Å—ã–Ω|–¥–æ—á—å|–¥–æ—á–∫|—Å—ã–Ω–æ)', text_lower):
        if "adults" not in entities:
            entities["adults"] = 1
            entities["adults_explicit"] = True
        entities["children_mentioned"] = True
        entities["children_count_mentioned"] = 1
    
    # "–º—ã —Å –º—É–∂–µ–º/–∂–µ–Ω–æ–π" ‚Üí adults=2
    if re.search(r'–º—ã\s+—Å\s+(?:–º—É–∂|–∂–µ–Ω|—Å—É–ø—Ä—É–≥)', text_lower):
        if "adults" not in entities:
            entities["adults"] = 2
            entities["adults_explicit"] = True
    
    # 8. –¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è
    for key, food_type in FOOD_TYPE_MAP.items():
        if key in text_lower:
            entities["food_type"] = food_type
            entities["food_type_updated"] = True  # –§–ª–∞–≥: –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ
            break
    
    # 9. –ó–≤—ë–∑–¥–Ω–æ—Å—Ç—å
    stars_match = re.search(r'(\d)\s*(?:\*|–∑–≤–µ–∑–¥|–∑–≤[–µ—ë]–∑–¥)', text_lower)
    if stars_match:
        stars = int(stars_match.group(1))
        if 3 <= stars <= 5:
            entities["stars"] = stars
            entities["stars_updated"] = True  # –§–ª–∞–≥: –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ
    
    # 10. –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è (–ø–æ–∏—Å–∫ –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º)
    # –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞–Ω—É –ø–æ –±—Ä–µ–Ω–¥—É –æ—Ç–µ–ª—è!
    # Rixos –µ—Å—Ç—å –≤ –¢—É—Ä—Ü–∏–∏, –°–æ—á–∏, –û–ê–≠ ‚Äî —Å—Ç—Ä–∞–Ω—É –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∏–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è!
    for key, hotel_name in KNOWN_HOTELS.items():
        if key in text_lower:
            entities["hotel_name"] = hotel_name
            # –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º destination_country ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å!
            break
    
    # ==================== 11. –£–°–õ–£–ì–ò –û–¢–ï–õ–ï–ô (GAP Analysis) ====================
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —É—Å–ª—É–≥–∞–º
    service_keywords_found = []
    for keyword, service_type in SERVICES_KEYWORDS.items():
        if keyword in text_lower:
            if service_type not in service_keywords_found:
                service_keywords_found.append(service_type)
    
    if service_keywords_found:
        entities["service_keywords"] = service_keywords_found
    
    # ==================== 12. –¢–ò–ü–´ –û–¢–ï–õ–ï–ô (GAP Analysis) ====================
    hotel_types_found = []
    for keyword, hotel_type in HOTEL_TYPES_MAP.items():
        if keyword in text_lower:
            if hotel_type not in hotel_types_found:
                hotel_types_found.append(hotel_type)
    
    if hotel_types_found:
        entities["hotel_types"] = hotel_types_found
    
    # ==================== 13. –¢–ò–ü –¢–£–†–ê (GAP Analysis) ====================
    for keyword, tour_type in TOUR_TYPES_MAP.items():
        if keyword in text_lower:
            entities["tour_type"] = tour_type
            break
    
    return entities


def detect_phone_number(text: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."""
    patterns = [
        r'(?:\+7|8)[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}',
        r'(?:\+7|8)\d{10}',
    ]
    for pattern in patterns:
        match = re.search(pattern, text)
        if match:
            return match.group(0)
    return None


def detect_intent_regex(text: str, awaiting_phone: bool = False) -> str:
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    text_lower = text.lower()
    
    if awaiting_phone and detect_phone_number(text):
        return "phone_provided"
    
    # === –ü–ê–ì–ò–ù–ê–¶–ò–Ø: "–ï—â—ë —Ç—É—Ä—ã" (GAP Analysis) ===
    if any(word in text_lower for word in [
        "–µ—â—ë —Ç—É—Ä—ã", "–µ—â–µ —Ç—É—Ä—ã", "–µ—â—ë –≤–∞—Ä–∏–∞–Ω—Ç", "–µ—â–µ –≤–∞—Ä–∏–∞–Ω—Ç",
        "–ø–æ–∫–∞–∑–∞—Ç—å –µ—â—ë", "–ø–æ–∫–∞–∑–∞—Ç—å –µ—â–µ", "–ø–æ–∫–∞–∂–∏ –µ—â—ë", "–ø–æ–∫–∞–∂–∏ –µ—â–µ",
        "–±–æ–ª—å—à–µ —Ç—É—Ä–æ–≤", "–±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç", "–¥—Ä—É–≥–∏–µ —Ç—É—Ä—ã", "–¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç",
        "–µ—â—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω", "–µ—â–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω", "—Å–ª–µ–¥—É—é—â–∏–µ —Ç—É—Ä—ã", "—Å–ª–µ–¥—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç"
    ]):
        return "more_tours"
    
    # === –£–ì–õ–£–ë–õ–Å–ù–ù–´–ô –ü–û–ò–°–ö: "–ò—Å–∫–∞—Ç—å –µ—â—ë" (GAP Analysis) ===
    if any(word in text_lower for word in [
        "–∏—Å–∫–∞—Ç—å –µ—â—ë", "–∏—Å–∫–∞—Ç—å –µ—â–µ", "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫", "–∏—â–∏ –µ—â—ë",
        "–∏—â–∏ –µ—â–µ", "–ø–æ–∏—Å–∫–∞—Ç—å –µ—â—ë", "–ø–æ–∏—Å–∫–∞—Ç—å –µ—â–µ", "–¥–æ–ª—å—à–µ –∏—Å–∫–∞—Ç—å",
        "—É–≥–ª—É–±–ª—ë–Ω–Ω—ã–π –ø–æ–∏—Å–∫", "–≥–ª—É–±–∂–µ –∏—Å–∫–∞—Ç—å"
    ]):
        return "continue_search"
    
    if any(word in text_lower for word in ["–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤", "–∑–∞–±—Ä–æ–Ω–∏—Ä—É–π", "–æ—Å—Ç–∞–≤—å –∑–∞—è–≤–∫", "–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫", "—Ö–æ—á—É –∑–∞–∫–∞–∑"]):
        return "booking"
    
    if any(word in text_lower for word in ["–≥–æ—Ä—è—â", "–≥–æ—Ä—è—á–∏–µ", "—Å–∫–∏–¥–∫"]):
        return "hot_tours"
    
    if any(word in text_lower for word in ["–≤–∏–∑–∞", "–ø–∞—Å–ø–æ—Ä—Ç", "–≤—ä–µ–∑–¥"]):
        return "faq_visa"
    if any(word in text_lower for word in ["–æ–ø–ª–∞—Ç", "–∫–∞—Ä—Ç", "—Ä–∞—Å—Å—Ä–æ—á–∫"]):
        return "faq_payment"
    if any(word in text_lower for word in ["–≤–æ–∑–≤—Ä–∞—Ç", "–æ—Ç–º–µ–Ω"]):
        return "faq_cancel"
    if any(word in text_lower for word in ["—Å—Ç—Ä–∞—Ö–æ–≤", "–ø–æ–ª–∏—Å"]):
        return "faq_insurance"
    if any(word in text_lower for word in ["–¥–æ–∫—É–º–µ–Ω—Ç", "—Å–ø—Ä–∞–≤–∫"]):
        return "faq_documents"
    
    if any(word in text_lower for word in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å"]):
        return "greeting"
    
    # General chat
    if any(word in text_lower for word in ["–ø–æ–≥–æ–¥–∞", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä", "–∫–ª–∏–º–∞—Ç", "–∫–æ–≥–¥–∞ –ª—É—á—à–µ"]):
        return "general_chat"
    if any(word in text_lower for word in ["–ø–æ—Å–æ–≤–µ—Ç—É–π", "–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π", "–ø–æ–¥—Å–∫–∞–∂", "–∫–∞–∫–æ–π –ª—É—á—à–µ", "—á—Ç–æ –≤—ã–±—Ä–∞—Ç—å"]):
        return "general_chat"
    if any(word in text_lower for word in ["–∫–∞–∫–æ–π –æ—Ç–µ–ª—å", "–ª—É—á—à–∏–π –æ—Ç–µ–ª—å", "–æ—Ç–µ–ª—å –¥–ª—è –¥–µ—Ç"]):
        return "general_chat"
    if any(word in text_lower for word in ["—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å", "–¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω", "—ç–∫—Å–∫—É—Ä—Å–∏"]):
        return "general_chat"
    
    return "search_tour"


async def extract_entities_with_llm(text: str, awaiting_phone: bool = False) -> dict:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (LLM + regex fallback)."""
    from app.agent.llm import llm_client
    
    llm_entities = {}
    llm_intent = None
    
    if settings.YANDEX_GPT_ENABLED:
        try:
            result = await llm_client.extract_entities(text)
            llm_entities = result.get("entities", {})
            llm_intent = result.get("intent")
            
            # ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ò–ü–û–í –û–¢ LLM ====================
            
            # date_from: str -> date (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
            if "date_from" in llm_entities:
                val = llm_entities["date_from"]
                if isinstance(val, str):
                    # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –º—É—Å–æ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    if val.lower() in ("–Ω–µ —É–∫–∞–∑–∞–Ω–∞", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ", "null", "none", ""):
                        del llm_entities["date_from"]
                    else:
                        try:
                            parsed_date = date.fromisoformat(val)
                            # === –í–ê–õ–ò–î–ê–¶–ò–Ø: –¥–∞—Ç–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º! ===
                            if parsed_date < date.today():
                                logger.info(f"   ‚ö†Ô∏è –î–∞—Ç–∞ {parsed_date} –≤ –ø—Ä–æ—à–ª–æ–º ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
                                del llm_entities["date_from"]
                            else:
                                llm_entities["date_from"] = parsed_date
                                llm_entities["dates_confirmed"] = True  # –Ø–í–ù–û —É–∫–∞–∑–∞–Ω–∞!
                        except ValueError:
                            del llm_entities["date_from"]
            
            # date_to: str -> date (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
            if "date_to" in llm_entities:
                val = llm_entities["date_to"]
                if isinstance(val, str):
                    # –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –º—É—Å–æ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    if val.lower() in ("–Ω–µ —É–∫–∞–∑–∞–Ω–∞", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ", "null", "none", ""):
                        del llm_entities["date_to"]
                    else:
                        try:
                            llm_entities["date_to"] = date.fromisoformat(val)
                        except ValueError:
                            del llm_entities["date_to"]
            
            # food_type: str -> FoodType
            if "food_type" in llm_entities:
                val = llm_entities["food_type"]
                if isinstance(val, str):
                    try:
                        llm_entities["food_type"] = FoodType(val)
                    except ValueError:
                        del llm_entities["food_type"]
            
            # adults: str -> int (–≤–∞–ª–∏–¥–∞—Ü–∏—è 1-20, –¥–ª—è –≥—Ä—É–ø–ø > 6)
            # –ö–†–ò–¢–ò–ß–ù–û: LLM –ù–ï —Å—Ç–∞–≤–∏—Ç adults_explicit ‚Äî —Ç–æ–ª—å–∫–æ regex!
            # –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π: LLM –º–æ–∂–µ—Ç "—É–≥–∞–¥–∞—Ç—å" adults=1
            if "adults" in llm_entities:
                val = llm_entities["adults"]
                if isinstance(val, str):
                    try:
                        llm_entities["adults"] = int(val)
                    except ValueError:
                        del llm_entities["adults"]
                if isinstance(llm_entities.get("adults"), int):
                    # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ 20 –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
                    if not (1 <= llm_entities["adults"] <= 20):
                        del llm_entities["adults"]
                    # –ù–ï —Å—Ç–∞–≤–∏–º adults_explicit! –¢–æ–ª—å–∫–æ regex –º–æ–∂–µ—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å.
            
            # nights: str -> int (–≤–∞–ª–∏–¥–∞—Ü–∏—è 1-21, max 30)
            # –ö–†–ò–¢–ò–ß–ù–û: nights > 21 ‚Äî –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ (–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è), > 30 ‚Äî —Ç–æ—á–Ω–æ –æ—à–∏–±–∫–∞
            if "nights" in llm_entities:
                val = llm_entities["nights"]
                if isinstance(val, str):
                    try:
                        llm_entities["nights"] = int(val)
                    except ValueError:
                        del llm_entities["nights"]
                if isinstance(llm_entities.get("nights"), int):
                    nights_val = llm_entities["nights"]
                    # –û—Ç—Å–µ–∫–∞–µ–º –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ —Ç–∏–ø–∞ "364 –Ω–æ—á–∏"
                    if nights_val > 30 or nights_val < 1:
                        del llm_entities["nights"]
                    elif nights_val > 21:
                        # –î–ª–∏–Ω–Ω—ã–π —Ç—É—Ä ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é
                        llm_entities["long_stay_explicit"] = True
            
            # stars: str -> int (–≤–∞–ª–∏–¥–∞—Ü–∏—è 3-5)
            if "stars" in llm_entities:
                val = llm_entities["stars"]
                if isinstance(val, str):
                    try:
                        llm_entities["stars"] = int(val)
                    except ValueError:
                        del llm_entities["stars"]
                if isinstance(llm_entities.get("stars"), int):
                    if not (3 <= llm_entities["stars"] <= 5):
                        del llm_entities["stars"]
            
            # children: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å list[int]
            if "children" in llm_entities:
                val = llm_entities["children"]
                if isinstance(val, list):
                    validated_children = []
                    for age in val:
                        if isinstance(age, int) and 0 <= age <= 15:
                            validated_children.append(age)
                        elif isinstance(age, str):
                            try:
                                a = int(age)
                                if 0 <= a <= 15:
                                    validated_children.append(a)
                            except ValueError:
                                pass
                    llm_entities["children"] = validated_children if validated_children else None
                else:
                    del llm_entities["children"]
                    
        except Exception as e:
            print(f"LLM extraction failed: {e}")
    
    regex_entities = extract_entities_regex(text)
    regex_intent = detect_intent_regex(text, awaiting_phone)
    
    final_entities = regex_entities.copy()
    for key, value in llm_entities.items():
        if value is not None:
            # –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—É, –µ—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            if key == "destination_country":
                # –ï—Å–ª–∏ regex —É–∂–µ –Ω–∞—à—ë–ª –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä–∞–Ω—É - –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                if regex_entities.get("destination_country") and regex_entities["destination_country"] in VALID_COUNTRIES:
                    continue
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ LLM –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä–∞–Ω—É
                if value not in VALID_COUNTRIES and value.lower() not in COUNTRIES_MAP:
                    continue
            
            # –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º adults/nights –µ—Å–ª–∏ regex —É–∂–µ –Ω–∞—à—ë–ª –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            if key in ("adults", "nights") and key in regex_entities:
                continue
            
            final_entities[key] = value
    
    intent = llm_intent if llm_intent else regex_intent
    
    if awaiting_phone and detect_phone_number(text):
        intent = "phone_provided"
    elif detect_intent_regex(text, awaiting_phone) == "booking":
        intent = "booking"
    elif regex_intent == "general_chat" and intent == "search_tour":
        intent = "general_chat"
    
    return {"intent": intent, "entities": final_entities}


# ==================== GRAPH NODES ====================

def check_agreement_phrase(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Ñ—Ä–∞–∑–æ–π —Å–æ–≥–ª–∞—Å–∏—è."""
    text_lower = text.lower().strip()
    # –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (1-3 —Å–ª–æ–≤–∞) –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ
    if len(text_lower.split()) <= 3:
        for phrase in AGREEMENT_PHRASES:
            if phrase in text_lower:
                return True
    return False


async def input_analyzer(state: AgentState) -> AgentState:
    """–ê–Ω–∞–ª–∏–∑ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if not state["messages"]:
        return state
    
    last_message = state["messages"][-1]
    if last_message["role"] != "user":
        return state
    
    user_text = last_message["content"]
    awaiting_phone = state.get("awaiting_phone", False)
    
    # ==================== SEARCH MODE DETECTION ====================
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    detected_mode = detect_search_mode(user_text)
    current_mode = state.get("search_mode", "package")
    
    # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ package)
    # hotel_only –∏ burning —Ä–µ–∂–∏–º—ã —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏!
    if detected_mode != "package" or current_mode == "package":
        state["search_mode"] = detected_mode
    
    # –õ–æ–≥–∏—Ä—É–µ–º –í–°–ï–ì–î–ê
    logger.info(f"   üîç SEARCH MODE: {state.get('search_mode', 'package')} (detected: {detected_mode})")
    
    # ==================== –ö–û–ù–¢–ï–ö–°–¢–ù–ê–Ø –û–°–í–ï–î–û–ú–õ–Å–ù–ù–û–°–¢–¨ ====================
    # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ —É–∂–µ –∏–¥—ë—Ç —Å–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (cascade_stage > 1) –∏ –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π,
    # —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ –Ω–æ–≤—ã–π intent!
    current_cascade_stage = state.get("cascade_stage", 1)
    current_params = state.get("search_params", {}) or {}
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    logger.info(f"   üìä –¢–µ–∫—É—â–∏–π cascade_stage: {current_cascade_stage}")
    logger.info(f"   üìä –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {current_params}")
    
    # ==================== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ì–õ–ê–°–ò–Ø ====================
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª "—Ö–æ—Ä–æ—à–æ", "–æ–∫", "–¥–∞–≤–∞–π", "–¥–∞" –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
    if state.get("awaiting_agreement") and check_agreement_phrase(user_text):
        pending_action = state.get("pending_action")
        current_params = state["search_params"].copy() if state["search_params"] else {}
        
        if pending_action == "flex_dates":
            # –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –≥–∏–±–∫–∏–µ –¥–∞—Ç—ã ‚Äî —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–æ ¬±5 –¥–Ω–µ–π
            state["flex_search"] = True
            state["flex_days"] = 5  # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è
            state["awaiting_agreement"] = False
            state["pending_action"] = None
            state["intent"] = "search_tour"
            state["search_params"] = current_params
            state["cascade_stage"] = 6  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–æ–∏—Å–∫—É
            state["missing_info"] = []
            state["error"] = None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
            state["search_attempts"] = state.get("search_attempts", 0)  # –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
            return state
        elif pending_action == "any_hotel":
            # –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ª—é–±–æ–π –æ—Ç–µ–ª—å
            current_params["skip_quality_check"] = True
            state["search_params"] = current_params
            state["awaiting_agreement"] = False
            state["pending_action"] = None
            state["intent"] = "search_tour"
            state["cascade_stage"] = 6
            state["missing_info"] = []
            state["error"] = None
            return state
        elif pending_action == "alt_departure":
            # –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞
            current_params["departure_city"] = "–ú–æ—Å–∫–≤–∞"
            state["search_params"] = current_params
            state["awaiting_agreement"] = False
            state["pending_action"] = None
            state["intent"] = "search_tour"
            state["cascade_stage"] = 6
            state["missing_info"] = []
            state["error"] = None
            state["flex_days"] = 2  # –ë–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
            return state
        elif pending_action == "alt_food":
            # === SMART FALLBACK: –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (GAP Analysis) ===
            # –ú–µ–Ω—è–µ–º AI/UAI –Ω–∞ HB (–ø–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω)
            current_params["food_type"] = FoodType.HB
            state["search_params"] = current_params
            state["awaiting_agreement"] = False
            state["pending_action"] = None
            state["offered_alt_food"] = True
            state["intent"] = "search_tour"
            state["cascade_stage"] = 6
            state["missing_info"] = []
            state["error"] = None
            return state
        elif pending_action == "lower_stars":
            # === SMART FALLBACK: –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ (GAP Analysis) ===
            current_stars = current_params.get("stars", 5)
            current_params["stars"] = max(3, current_stars - 1)  # –ù–µ –Ω–∏–∂–µ 3*
            state["search_params"] = current_params
            state["awaiting_agreement"] = False
            state["pending_action"] = None
            state["offered_lower_stars"] = True
            state["intent"] = "search_tour"
            state["cascade_stage"] = 6
            state["missing_info"] = []
            state["error"] = None
            return state
    
    # ==================== CONTEXT AWARENESS: –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ ====================
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä "5"), —Å–º–æ—Ç—Ä–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    user_text_stripped = user_text.strip()
    last_question = state.get("last_question_type")
    
    if user_text_stripped.isdigit() and last_question:
        number = int(user_text_stripped)
        current_params = state["search_params"].copy() if state["search_params"] else {}
        
        if last_question == "nights" and 1 <= number <= 21:
            # "5" –≤ –æ—Ç–≤–µ—Ç –Ω–∞ "–ù–∞ —Å–∫–æ–ª—å–∫–æ –Ω–æ—á–µ–π?" ‚Üí nights=5
            current_params["nights"] = number
            state["search_params"] = current_params
            state["last_question_type"] = None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            
            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º cascade_stage (–∏–º–ø–æ—Ä—Ç —É–∂–µ –≤–≤–µ—Ä—Ö—É —Ñ–∞–π–ª–∞)
            missing = get_missing_required_params(current_params)
            cascade_stage = get_cascade_stage(current_params, state.get("search_mode", "package"))
            state["missing_info"] = missing
            state["intent"] = "search_tour"
            state["cascade_stage"] = cascade_stage
            return state
        
        elif last_question == "adults" and 1 <= number <= 10:
            # "2" –≤ –æ—Ç–≤–µ—Ç –Ω–∞ "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫?" ‚Üí adults=2
            current_params["adults"] = number
            current_params["adults_explicit"] = True
            state["search_params"] = current_params
            state["last_question_type"] = None
            
            missing = get_missing_required_params(current_params)
            cascade_stage = get_cascade_stage(current_params, state.get("search_mode", "package"))
            state["missing_info"] = missing
            state["intent"] = "search_tour"
            state["cascade_stage"] = cascade_stage
            return state
        
        elif last_question == "stars" and 3 <= number <= 5:
            # "5" –≤ –æ—Ç–≤–µ—Ç –Ω–∞ "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è?" ‚Üí stars=5
            current_params["stars"] = number
            current_params["skip_quality_check"] = True
            state["search_params"] = current_params
            state["last_question_type"] = None
            state["quality_check_asked"] = True
            state["clarification_asked"] = True  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
            
            missing = get_missing_required_params(current_params)
            cascade_stage = get_cascade_stage(current_params, state.get("search_mode", "package"))
            state["missing_info"] = missing
            state["intent"] = "search_tour"
            state["cascade_stage"] = cascade_stage
            return state
        
        elif last_question == "children_ages" and 0 <= number <= 17:
            # "7" –≤ –æ—Ç–≤–µ—Ç –Ω–∞ "–£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞" ‚Üí children=[7]
            existing_children = current_params.get("children", [])
            if number not in existing_children:
                existing_children.append(number)
            current_params["children"] = existing_children
            current_params["children_mentioned"] = False  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
            current_params["children_count_mentioned"] = 0
            state["search_params"] = current_params
            state["last_question_type"] = None
            
            missing = get_missing_required_params(current_params)
            cascade_stage = get_cascade_stage(current_params, state.get("search_mode", "package"))
            state["missing_info"] = missing
            state["intent"] = "search_tour"
            state["cascade_stage"] = cascade_stage
            return state
    
    # ==================== –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–ê –ù–ê CHILDREN_CHECK ====================
    # –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ "–ø–æ–µ–¥—É—Ç –ª–∏ –¥–µ—Ç–∏?" –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª "–Ω–µ—Ç"/"–±–µ–∑ –¥–µ—Ç–µ–π"
    if last_question == "children_check":
        current_params = state["search_params"].copy() if state["search_params"] else {}
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        no_children_words = ["–Ω–µ—Ç", "–±–µ–∑", "—Ç–æ–ª—å–∫–æ –≤–∑—Ä", "–æ–¥–Ω–∏", "–Ω–µ –±—É–¥–µ—Ç", "–Ω–µ –µ–¥—É—Ç", "–Ω–µ –ø–æ–µ–¥"]
        is_no_children = any(word in user_text.lower() for word in no_children_words)
        
        if is_no_children:
            current_params["no_children_explicit"] = True
            current_params["children_mentioned"] = False
            state["search_params"] = current_params
            state["last_question_type"] = None
            
            missing = get_missing_required_params(current_params)
            cascade_stage = get_cascade_stage(current_params, state.get("search_mode", "package"))
            state["missing_info"] = missing
            state["intent"] = "search_tour"
            state["cascade_stage"] = cascade_stage
            return state
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–µ—Å—Ç—å –¥–µ—Ç–∏, –Ω–æ –Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç)
        yes_children_words = ["–¥–∞", "–µ—Å—Ç—å", "–±—É–¥—É—Ç", "–µ–¥—É—Ç", "–ø–æ–µ–¥", "—Å —Ä–µ–±", "—Å –¥–µ—Ç"]
        is_yes_children = any(word in user_text.lower() for word in yes_children_words)
        
        if is_yes_children:
            current_params["children_mentioned"] = True
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–ª –ª–∏ –≤–æ–∑—Ä–∞—Å—Ç –≤ —ç—Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏
            # –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç extract_entities_regex –Ω–∏–∂–µ
    
    result = await extract_entities_with_llm(user_text, awaiting_phone)
    intent = result.get("intent", "search_tour")
    entities = result.get("entities", {})
    
    # ==================== –ê–ù–¢–ò-–°–ë–†–û–° INTENT ====================
    # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –º—ã –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å–±–æ—Ä–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (cascade_stage > 1),
    # –ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (1-3 —Å–ª–æ–≤–∞),
    # –ò –±—ã–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã entities ‚Äî —ç—Ç–æ –û–¢–í–ï–¢ –Ω–∞ –≤–æ–ø—Ä–æ—Å, –Ω–µ –Ω–æ–≤—ã–π intent!
    
    word_count = len(user_text.strip().split())
    has_useful_entities = bool(entities)  # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–≤–ª–µ–∫–ª–∏
    
    # –ï—Å–ª–∏ cascade_stage > 1 –∏ intent = greeting/search_tour, –Ω–æ –µ—Å—Ç—å entities ‚Äî 
    # —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å, –Ω–µ —Å–±—Ä–æ—Å –¥–∏–∞–ª–æ–≥–∞!
    if current_cascade_stage > 1 and word_count <= 3:
        if intent == "greeting":
            # –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç —Ç–∏–ø–∞ "–º–æ—Å–∫–≤–∞" –æ—à–∏–±–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ greeting
            logger.info(f"   üîÑ –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é intent: greeting -> search_tour (—Å–µ—Ä–µ–¥–∏–Ω–∞ –∫–∞—Å–∫–∞–¥–∞)")
            intent = "search_tour"
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Å—Ç—Ä–∞–Ω–∞ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–∞) ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–±–æ—Ä
        if current_params and intent in ("greeting", "search_tour"):
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            logger.info(f"   ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞—Å–∫–∞–¥, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
    
    # ==================== –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ü–ê–†–ê–ú–ï–¢–†–û–í ====================
    # –ö–†–ò–¢–ò–ß–ù–û: merged_params = –∫–æ–ø–∏—è —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ + –Ω–æ–≤—ã–µ –∏–∑ entities
    merged_params = current_params.copy() if current_params else {}
    
    # ==================== –ü–†–ò–û–†–ò–¢–ï–¢ –ù–û–í–´–• –î–ê–ù–ù–´–• ====================
    # –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ merged_params
    date_changed = False
    country_changed = False
    critical_params_changed = False
    
    for key, value in entities.items():
        if value is not None:
            old_value = merged_params.get(key)
            
            # –û—Å–æ–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç ‚Äî –Ω–æ–≤—ã–µ –¥–∞—Ç—ã –í–°–ï–ì–î–ê –∑–∞–º–µ–Ω—è—é—Ç —Å—Ç–∞—Ä—ã–µ
            if key in ("date_from", "date_to", "nights"):
                if old_value != value:
                    date_changed = True
                    critical_params_changed = True
            
            # –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω—ã ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            elif key == "destination_country":
                if old_value and old_value != value:
                    country_changed = True
                    critical_params_changed = True
            
            # –î–ï–¢–ò –ò –ö–û–ù–¢–ï–ö–°–¢: –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º children_mentioned=True –µ—Å–ª–∏ –≤ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            # –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ—Ç—è—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ—Ö–æ–¥–∞—Ö
            elif key == "children_mentioned":
                # –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–æ True, –∞ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ False (–Ω–µ—è–≤–Ω–æ–µ) ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º True
                if old_value is True and value is False:
                    logger.info(f"   üõ°Ô∏è –ó–∞—â–∏—Ç–∞ children_mentioned: —Å–æ—Ö—Ä–∞–Ω—è–µ–º True")
                    continue  # –ù–µ –∑–∞—Ç–∏—Ä–∞–µ–º
            
            merged_params[key] = value
    
    # ==================== –°–ë–†–û–° –§–õ–ê–ì–û–í –ü–†–ò –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ò–ó–ú–ï–ù–ï–ù–ò–Ø–• ====================
    # –ü—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω—ã –∏–ª–∏ –¥–∞—Ç—ã ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º clarification_asked –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
    if critical_params_changed:
        state["awaiting_agreement"] = False
        state["pending_action"] = None
        state["error"] = None
        state["flex_search"] = False
        state["flex_days"] = 2  # –ë–∞–∑–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω ¬±2 –¥–Ω—è
        state["search_attempts"] = 0
        state["offered_alt_departure"] = False
        
        # –ö–†–ò–¢–ò–ß–ù–û: –°–±—Ä–∞—Å—ã–≤–∞–µ–º –í–°–ï —Ñ–ª–∞–≥–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        if country_changed:
            state["clarification_asked"] = False
            state["quality_check_asked"] = False
            state["skip_quality_check"] = False  # RESET FLAGS: –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã –∑–∞–Ω–æ–≤–æ —Å–ø—Ä–æ—Å–∏–º –ø—Ä–æ –∑–≤—ë–∑–¥—ã
            merged_params["skip_quality_check"] = False  # –¢–∞–∫–∂–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
            logger.info(f"   üîÑ –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω—ã: {merged_params.get('destination_country')} ‚Üí —Å–±—Ä–æ—Å –í–°–ï–• —Ñ–ª–∞–≥–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞")
    
    # ==================== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –î–ï–¢–ò –ë–ï–ó –í–û–ó–†–ê–°–¢–ê ====================
    # –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã –¥–µ—Ç–∏, –Ω–æ –≤–æ–∑—Ä–∞—Å—Ç –ù–ï —É–∫–∞–∑–∞–Ω ‚Äî –ë–õ–û–ö–ò–†–£–ï–ú –ø–æ–∏—Å–∫ –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
    children_mentioned = entities.get("children_mentioned") or merged_params.get("children_mentioned")
    children_count_mentioned = entities.get("children_count_mentioned") or merged_params.get("children_count_mentioned", 0)
    existing_children_ages = merged_params.get("children", [])
    
    if children_mentioned and not existing_children_ages:
        state["search_params"] = merged_params
        state["intent"] = "ask_child_ages"
        state["missing_child_ages"] = children_count_mentioned or 1
        # –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º ‚Äî –Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π
        return state
    
    # –ï—Å–ª–∏ –Ω–æ–≤—ã–µ –≤–æ–∑—Ä–∞—Å—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω—ã ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
    if entities.get("children") and len(entities["children"]) > 0:
        merged_params["children_mentioned"] = False
        merged_params["children_count_mentioned"] = 0
    
    # ==================== –ü–†–û–í–ï–†–ö–ê –ì–†–£–ü–ü–´ > 6 –ß–ï–õ–û–í–ï–ö ====================
    total_people = merged_params.get("adults", 0) + len(merged_params.get("children", []))
    if total_people > 6:
        # –ì—Ä—É–ø–ø–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ‚Äî —ç—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        state["search_params"] = merged_params
        state["intent"] = "group_booking"
        state["is_group_request"] = True
        state["group_size"] = total_people
        state["is_first_message"] = len(state["messages"]) <= 1 and not state.get("greeted", False)
        return state
    
    # ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø –°–¢–†–ê–ù–´ (Anti-Hallucination) ====================
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —É–∫–∞–∑–∞–ª —Å—Ç—Ä–∞–Ω—É, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    country = merged_params.get("destination_country")
    if country:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç—Ä–∞–Ω–∞ –≤ –≤–∞–ª–∏–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ
        if country not in VALID_COUNTRIES:
            # –°—Ç—Ä–∞–Ω–∞ –Ω–µ –≤ –Ω–∞—à–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Äî –Ω–µ –∏—â–µ–º
            state["search_params"] = merged_params
            state["intent"] = "invalid_country"
            state["invalid_country"] = country
            state["is_first_message"] = len(state["messages"]) <= 1 and not state.get("greeted", False)
            return state
    
    # ==================== SOCHI-TO-SOCHI DETECTION ====================
    # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ = –≥–æ—Ä–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ hotel_only —Ä–µ–∂–∏–º
    departure_city = merged_params.get("departure_city", "").lower().strip() if merged_params.get("departure_city") else ""
    dest_region = merged_params.get("destination_region", "").lower().strip() if merged_params.get("destination_region") else ""
    dest_resort = merged_params.get("destination_resort", "").lower().strip() if merged_params.get("destination_resort") else ""
    dest_country = merged_params.get("destination_country", "").lower().strip() if merged_params.get("destination_country") else ""
    
    if departure_city:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω—É, –∫—É—Ä–æ—Ä—Ç—É –∏–ª–∏ —Å—Ç—Ä–∞–Ω–µ (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫)
        is_local_travel = (
            (dest_region and departure_city in dest_region) or
            (dest_resort and departure_city in dest_resort) or
            (departure_city in dest_region if dest_region else False) or
            (departure_city in dest_resort if dest_resort else False) or
            # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–æ—á–∏ ‚Üí –°–æ—á–∏)
            departure_city == dest_region or
            departure_city == dest_resort
        )
        
        if is_local_travel:
            logger.info(f"   üöó LOCAL TRAVEL DETECTED: {departure_city} ‚Üí {dest_region or dest_resort}. Switching to Hotel Only mode.")
            state["search_mode"] = "hotel_only"
            merged_params["departure_city"] = None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º ‚Äî –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è hotel_only
    
    # ==================== –ï–°–õ–ò –£–ö–ê–ó–ê–ù –û–¢–ï–õ–¨ ‚Äî –ü–†–û–ü–£–°–ö–ê–ï–ú –ó–í–Å–ó–î–ù–û–°–¢–¨ ====================
    if merged_params.get("hotel_name"):
        # –ù–µ –Ω—É–∂–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å ‚Äî –æ—Ç–µ–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
        merged_params["skip_quality_check"] = True
    
    # ==================== –ê–ù–¢–ò-–ó–ê–¶–ò–ö–õ–ò–í–ê–ù–ò–ï: –ï—Å–ª–∏ stars/food_type –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º ====================
    # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ –∑–≤—ë–∑–¥–∞—Ö/–ø–∏—Ç–∞–Ω–∏–∏ ‚Äî –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ!
    stars_updated = entities.get("stars_updated", False)
    food_type_updated = entities.get("food_type_updated", False)
    
    if stars_updated or food_type_updated:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º quality_check
        merged_params["skip_quality_check"] = True
        state["quality_check_asked"] = True  # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏
        state["clarification_asked"] = True  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ "–º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ" ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    # –í–ê–ñ–ù–û: –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ stars/food_type –ø—Ä–∏ "–º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ"
    # –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–π—Ç–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    if check_skip_quality_phrase(user_text):
        merged_params["skip_quality_check"] = True
        state["clarification_asked"] = True  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª –ø–æ–Ω—è—Ç—å —á—Ç–æ –µ–º—É –≤—Å—ë —Ä–∞–≤–Ω–æ
        # –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º stars –∏ food_type ‚Äî –ø—É—Å—Ç—å –ø–æ–∏—Å–∫ –≤–µ—Ä–Ω—ë—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –Ω–æ—á–µ–π
    if "date_from" in merged_params and "date_to" in merged_params:
        d_from = merged_params["date_from"]
        d_to = merged_params["date_to"]
        if isinstance(d_from, date) and isinstance(d_to, date):
            nights = (d_to - d_from).days
            if nights > 0:
                merged_params["nights"] = nights
    
    if "date_from" in merged_params and "nights" in merged_params and "date_to" not in merged_params:
        d_from = merged_params["date_from"]
        if isinstance(d_from, date):
            merged_params["date_to"] = d_from + timedelta(days=merged_params["nights"])
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    missing = get_missing_required_params(merged_params)
    cascade_stage = get_cascade_stage(merged_params, state.get("search_mode", "package"))
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–µ—Ä–≤–æ–µ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è)
    is_first = len(state["messages"]) <= 1 and not state.get("greeted", False)
    
    # ==================== –í–ê–ñ–ù–û: –ï–°–õ–ò –í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –°–û–ë–†–ê–ù–´ ‚Äî –ò–©–ï–ú ====================
    # –ï—Å–ª–∏ cascade_stage == 6, –∑–Ω–∞—á–∏—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–±—Ä–∞–Ω—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–∏—Å–∫—É
    # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç "–±–æ–ª—Ç–∞—Ç—å" –≤–º–µ—Å—Ç–æ –ø–æ–∏—Å–∫–∞
    if cascade_stage == 6 and intent not in ("booking", "phone_provided", "group_booking", "invalid_country"):
        intent = "search_tour"
    
    state["search_params"] = merged_params
    state["missing_info"] = missing
    state["intent"] = intent
    state["cascade_stage"] = cascade_stage
    state["is_first_message"] = is_first
    
    return state


async def faq_handler(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ FAQ."""
    intent = state.get("intent", "")
    
    # ==================== –ê–ù–¢–ò-–ü–û–í–¢–û–†–ù–û–ï –ü–†–ò–í–ï–¢–°–¢–í–ò–ï ====================
    # –ï—Å–ª–∏ —ç—Ç–æ "greeting" intent –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞ ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –∫—Ä–∞—Ç–∫–æ
    if intent == "greeting":
        messages_count = len(state.get("messages", []))
        already_greeted = state.get("greeted", False)
        
        if already_greeted or messages_count > 2:
            # –£–∂–µ –∑–¥–æ—Ä–æ–≤–∞–ª–∏—Å—å ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –∫—Ä–∞—Ç–∫–æ
            state["response"] = "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
        else:
            # –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏
            # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" ‚Äî –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É
            state["response"] = "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"
            state["greeted"] = True
        return state
    
    if intent in FAQ_RESPONSES:
        state["response"] = FAQ_RESPONSES[intent]
    else:
        state["response"] = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –Ω–∞—à—ë–ª –æ—Ç–≤–µ—Ç. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
    
    return state


async def invalid_country_handler(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã (Anti-Hallucination)."""
    invalid_country = state.get("invalid_country", "—ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")
    
    alternatives = ", ".join(POPULAR_ALTERNATIVES)
    
    state["response"] = (
        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–¥–∞—ë–º —Ç—É—Ä—ã –≤ {invalid_country}.\n\n"
        f"–ù–æ —è –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Ç–ª–∏—á–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:\n"
        f"‚Ä¢ {alternatives}\n\n"
        f"–ö–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
    )
    
    # –û—á–∏—â–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä–∞–Ω—É –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if state.get("search_params"):
        state["search_params"].pop("destination_country", None)
    
    return state


async def child_ages_handler(state: AgentState) -> AgentState:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –¥–µ—Ç–µ–π.
    
    –ö–†–ò–¢–ò–ß–ù–û –ø–æ –¢–ó: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º—è–Ω—É–ª –¥–µ—Ç–µ–π, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–ª –≤–æ–∑—Ä–∞—Å—Ç,
    –º—ã –û–ë–Ø–ó–ê–ù–´ —Å–ø—Ä–æ—Å–∏—Ç—å ‚Äî –≤–æ–∑—Ä–∞—Å—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ —Ü–µ–Ω—É —Ç—É—Ä–∞!
    """
    params = state.get("search_params", {})
    children_count = state.get("missing_child_ages", 1)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context_parts = []
    if params.get("destination_country"):
        context_parts.append(params["destination_country"])
    if params.get("departure_city"):
        context_parts.append(f"–∏–∑ {params['departure_city']}")
    if params.get("adults"):
        context_parts.append(f"{params['adults']} –≤–∑—Ä")
    
    context = ", ".join(context_parts) if context_parts else "–≤–∞—à –∑–∞–ø—Ä–æ—Å"
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å
    if children_count == 1:
        question = "–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã)."
    else:
        question = f"–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç –≤—Å–µ—Ö {children_count} –¥–µ—Ç–µ–π (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã)."
    
    # –ë–ï–ó "–ü—Ä–∏–Ω—è—Ç–æ:" ‚Äî —Å—Ä–∞–∑—É –≤–æ–ø—Ä–æ—Å
    state["response"] = question
    state["last_question_type"] = "children_ages"
    
    return state


async def general_chat_handler(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤."""
    if not state["messages"]:
        return state
    
    user_message = state["messages"][-1]["content"]
    params = state.get("search_params", {})
    
    if settings.YANDEX_GPT_ENABLED:
        from app.agent.llm import llm_client
        
        try:
            response = await llm_client.generate_conversational_response(
                user_message=user_message,
                search_params=params,
                conversation_history=state["messages"]
            )
            if response:
                state["response"] = response
                return state
        except Exception as e:
            print(f"General chat LLM error: {e}")
    
    state["response"] = generate_fallback_response(user_message, params)
    return state


def generate_fallback_response(user_message: str, params: dict) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –±–µ–∑ LLM."""
    text_lower = user_message.lower()
    
    country = None
    for key in DESTINATIONS_KNOWLEDGE.keys():
        if key in text_lower:
            country = key
            break
    
    if any(word in text_lower for word in ["–ø–æ–≥–æ–¥–∞", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä", "–∫–ª–∏–º–∞—Ç"]):
        if country and country in DESTINATIONS_KNOWLEDGE:
            info = DESTINATIONS_KNOWLEDGE[country]
            return f"–í {country.title()} —Å–µ–∑–æ–Ω: {info.get('—Å–µ–∑–æ–Ω', '—É—Ç–æ—á–Ω—è–π—Ç–µ')}. –ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É —Ç—É–¥–∞?"
        return "–ü–æ–≥–æ–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–∞–Ω—ã. –¢—É—Ä—Ü–∏—è ‚Äî –º–∞–π-–æ–∫—Ç—è–±—Ä—å, –ï–≥–∏–ø–µ—Ç ‚Äî –∫—Ä—É–≥–ª—ã–π –≥–æ–¥, –û–ê–≠ ‚Äî –æ–∫—Ç—è–±—Ä—å-–∞–ø—Ä–µ–ª—å. –ö—É–¥–∞ –ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ—Å—å?"
    
    if any(word in text_lower for word in ["–æ—Ç–µ–ª—å –¥–ª—è –¥–µ—Ç", "—Å –¥–µ—Ç—å–º–∏", "—Å–µ–º–µ–π–Ω"]):
        return "–î–ª—è —Å–µ–º–µ–π —Å –¥–µ—Ç—å–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –¢—É—Ä—Ü–∏—é ‚Äî –ë–µ–ª–µ–∫, –°–∏–¥–µ. –ö–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ–ª—ë—Ç, –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ, –∞–∫–≤–∞–ø–∞—Ä–∫–∏. –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?"
    
    if any(word in text_lower for word in ["–ª—É—á—à–µ", "–∏–ª–∏", "–≤—ã–±—Ä–∞—Ç—å"]):
        return "–¢—É—Ä—Ü–∏—è ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ–ª—ë—Ç, –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ. –ï–≥–∏–ø–µ—Ç ‚Äî –∫—Ä—É–≥–ª—ã–π –≥–æ–¥, –¥–µ—à–µ–≤–ª–µ. –û–ê–≠ ‚Äî —Ä–æ—Å–∫–æ—à—å, –∑–∏–º–æ–π. –ß—Ç–æ –¥–ª—è –í–∞—Å –≤–∞–∂–Ω–µ–µ?"
    
    return "–° —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É. –í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"


async def quality_check_handler(state: AgentState) -> AgentState:
    """–í–æ–ø—Ä–æ—Å –æ –∫–∞—á–µ—Å—Ç–≤–µ (–∑–≤—ë–∑–¥—ã/–ø–∏—Ç–∞–Ω–∏–µ)."""
    params = state.get("search_params", {})
    
    # –ë–ï–ó "–ü—Ä–∏–Ω—è—Ç–æ:" ‚Äî —Å—Ä–∞–∑—É –≤–æ–ø—Ä–æ—Å
    # –ï—Å–ª–∏ –æ—Ç–µ–ª—å –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (VIP –ø—Ä–æ—Ö–æ–¥)
    if params.get("hotel_name"):
        state["skip_quality_check"] = True
        state["cascade_stage"] = 6
        return state
    
    state["response"] = "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è ‚Äî 5 –∑–≤—ë–∑–¥ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—Ä–∏–∞–Ω—Ç—ã?"
    state["quality_check_asked"] = True
    
    return state


async def tour_searcher(state: AgentState) -> AgentState:
    """–ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤."""
    params = state["search_params"]
    
    # ==================== STRICT QUALIFICATION GUARDRAILS ====================
    # –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –ó–ê–ü–£–°–ö–ê–ï–ú –ü–û–ò–°–ö –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤!
    
    # ==================== –ì–û–†–Ø–©–ò–ï –¢–£–†–´: –¢–û–ñ–ï –ë–ï–ó –î–ï–§–û–õ–¢–û–í! ====================
    # –î–∞–∂–µ –¥–ª—è –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤ –∞–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    is_hot_tours = state.get("intent") == "hot_tours"
    
    # –ù–ï–¢ –î–ï–§–û–õ–¢–û–í! –î–∞–∂–µ –¥–ª—è –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
    if not is_hot_tours:
        # –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ ‚Äî –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞
        
        # 1. –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û (–∫—Ä–æ–º–µ —Ä–µ–∂–∏–º–∞ hotel_only!)
        search_mode = state.get("search_mode", "package")
        # –ë–ª–æ–∫–∏—Ä—É–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ù–ï hotel_only –∏ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç
        if search_mode != "hotel_only" and not params.get("departure_city"):
            state["missing_info"] = ["departure_city"]
            return state
        
        # 2. –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
        if not params.get("date_from"):
            state["missing_info"] = ["date_from"]
            return state
        
        # 3. –°–æ—Å—Ç–∞–≤ (adults) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω!
        # –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º adults=1 –º–æ–ª—á–∞! –ê–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–æ—Å–∏—Ç—å!
        adults_explicit = params.get("adults_explicit", False)
        adults = params.get("adults")
        
        if not adults or not adults_explicit:
            # –ê–≥–µ–Ω—Ç –û–ë–Ø–ó–ê–ù —Å–ø—Ä–æ—Å–∏—Ç—å: "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–ª–µ—Ç–∏—Ç?"
            state["missing_info"] = ["adults"]
            state["intent"] = "ask_pax"  # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π intent –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–∞
            return state
        
        # 4. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (nights) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
        if not params.get("nights"):
            state["missing_info"] = ["nights"]
            return state
        
        # 5. –°—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
        if not params.get("destination_country"):
            state["missing_info"] = ["destination_country"]
            return state
    
    if state["missing_info"]:
        return state
    
    try:
        
        destination = Destination(
            country=params.get("destination_country"),
            region=params.get("destination_region"),
            resort=params.get("destination_resort"),
            city=params.get("destination_city")
        )
        
        original_date_from = params.get("date_from")
        nights = params.get("nights", 7)
        
        # ==================== –£–ú–ù–´–ô –î–ò–ê–ü–ê–ó–û–ù –î–ê–¢ ====================
        # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –¢–û–ß–ù–ê–Ø –¥–∞—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∑–∫–æ–µ –æ–∫–Ω–æ!
        # –¢–æ—á–Ω–∞—è –¥–∞—Ç–∞: "15 —Ñ–µ–≤—Ä–∞–ª—è" ‚Üí ¬±0-1 –¥–µ–Ω—å
        # –†–∞–∑–º—ã—Ç–∞—è –¥–∞—Ç–∞: "–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ñ–µ–≤—Ä–∞–ª—è" ‚Üí ¬±2 –¥–Ω—è
        # –ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ¬±5 –¥–Ω–µ–π
        
        is_exact_date = params.get("is_exact_date", False)
        
        if state.get("flex_search"):
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∏—Å–∫
            flex_days = 5
        elif is_exact_date:
            # STRICT DATE SEARCH: –ï—Å–ª–∏ –¥–∞—Ç–∞ –¢–û–ß–ù–ê–Ø ‚Äî –∏—â–µ–º –°–¢–†–û–ì–û –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å!
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "15 —Ñ–µ–≤—Ä–∞–ª—è" ‚Üí –∏—â–µ–º —Ç–æ–ª—å–∫–æ 15 —Ñ–µ–≤—Ä–∞–ª—è
            flex_days = 0
            logger.info(f"   üìÖ STRICT DATE: —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ {original_date_from.strftime('%d.%m')}, flex_days=0")
        else:
            # –†–∞–∑–º—ã—Ç–∞—è –¥–∞—Ç–∞ ("–≤ —Ñ–µ–≤—Ä–∞–ª–µ", "–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ") ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–∫–Ω–æ
            flex_days = state.get("flex_days", 2)
        
        # ==================== –ö–†–ò–¢–ò–ß–ù–û: –†–ê–ó–î–ï–õ–ï–ù–ò–ï –î–ê–¢ –ò –ù–û–ß–ï–ô ====================
        # datefrom/dateto –≤ Tourvisor API ‚Äî —ç—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –í–´–õ–ï–¢–ê
        # nightsfrom/nightsto ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ!)
        # 
        # –ë–´–õ–û (–û–®–ò–ë–ö–ê): date_to = original_date_from + flex_days + nights
        # –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ –ø—Ä–∏ flex_days=5 –∏ nights=5 ‚Üí date_to –Ω–∞ 10 –¥–Ω–µ–π –≤–ø–µ—Ä—ë–¥
        # –ò SearchRequest –≤—ã—á–∏—Å–ª—è–ª nights = 15 –≤–º–µ—Å—Ç–æ 5!
        #
        # –ü–†–ê–í–ò–õ–¨–ù–û: —Ä–∞—Å—à–∏—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –≤—ã–ª–µ—Ç–∞, –Ω–æ—á–∏ –ø–µ—Ä–µ–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω–æ
        date_from = original_date_from - timedelta(days=flex_days)
        date_to = original_date_from + timedelta(days=flex_days)  # –ë–ï–ó nights!
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        state["original_date_from"] = original_date_from
        
        # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.info(f"   üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç: {date_from} - {date_to}, –Ω–æ—á–µ–π: {nights}")
        
        # –ö–†–ò–¢–ò–ß–ù–û: adults —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –≤—ã—à–µ ‚Äî –¥–µ—Ñ–æ–ª—Ç –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º!
        # ==================== –ì–û–†–û–î –í–´–õ–ï–¢–ê: HOTEL_ONLY –ù–ï –¢–†–ï–ë–£–ï–¢ ====================
        departure_city = params.get("departure_city")
        search_mode = state.get("search_mode", "package")
        
        # –î–ª—è hotel_only —Ä–µ–∂–∏–º–∞ –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è!
        if search_mode == "hotel_only":
            departure_city = None  # –ë—É–¥–µ—Ç departure=0 –≤ API
            logger.info("   üè® –†–µ–∂–∏–º HOTEL_ONLY: –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
        elif not departure_city:
            # –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç—É—Ä–æ–≤ –≥–æ—Ä–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            logger.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: departure_city –Ω–µ —É–∫–∞–∑–∞–Ω!")
            state["missing_info"] = ["departure_city"]
            return state
        else:
            logger.info(f"   ‚úàÔ∏è –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞: {departure_city}")
        
        search_request = SearchRequest(
            adults=params.get("adults"),  # –ë–µ–∑ –¥–µ—Ñ–æ–ª—Ç–∞! –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—ã—à–µ.
            children=params.get("children", []),
            destination=destination,
            hotel_name=params.get("hotel_name"),
            stars=params.get("stars"),
            date_from=date_from,
            date_to=date_to,
            nights=nights,  # –ö–†–ò–¢–ò–ß–ù–û: –ø–µ—Ä–µ–¥–∞—ë–º —è–≤–Ω–æ, –Ω–µ –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ –¥–∞—Ç!
            food_type=params.get("food_type"),
            departure_city=departure_city,  # –°–¢–†–û–ì–û –±–µ–∑ –¥–µ—Ñ–æ–ª—Ç–∞!
            # === –ù–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ (GAP Analysis) ===
            services=params.get("services"),  # ID —É—Å–ª—É–≥ –æ—Ç–µ–ª–µ–π
            hotel_types=params.get("hotel_types"),  # –¢–∏–ø—ã –æ—Ç–µ–ª–µ–π (family, beach...)
            tour_type=params.get("tour_type"),  # –¢–∏–ø —Ç—É—Ä–∞ (1=–ø–ª—è–∂–Ω—ã–π, 2=–≥–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–π...)
        )
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        await tourvisor_service.load_countries()
        await tourvisor_service.load_departures()
        
        if state["intent"] == "hot_tours":
            # –ì–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã —á–µ—Ä–µ–∑ hottours.php
            departure_id = tourvisor_service.get_departure_id(
                params.get("departure_city", "–ú–æ—Å–∫–≤–∞")
            ) or 1
            country_id = tourvisor_service.get_country_id(destination.country)
            
            tours = await tourvisor_service.get_hot_tours(
                departure_id=departure_id,
                country_id=country_id,
                limit=5
            )
            state["tour_offers"] = tours
        else:
            # ==================== –°–¢–†–û–ì–ò–ô –ü–û–ò–°–ö –ü–û –û–¢–ï–õ–Æ ====================
            # –ï—Å–ª–∏ hotel_name —É–∫–∞–∑–∞–Ω ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—â–µ–º —á–µ—Ä–µ–∑ find_hotel_by_name
            hotel_name = params.get("hotel_name")
            hotel_ids = None
            is_strict = False
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º –æ—Ç–µ–ª–µ –¥–ª—è Smart Alternatives
            found_hotel_info = None
            
            if hotel_name:
                # –ò—â–µ–º ID –æ—Ç–µ–ª—è –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
                country_for_hotel = params.get("destination_country")
                hotels_found = await tourvisor_service.find_hotel_by_name(
                    query=hotel_name,
                    country=country_for_hotel
                )
                
                if hotels_found:
                    hotel_ids = [h.hotel_id for h in hotels_found[:3]]
                    is_strict = True
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ –æ –ø–µ—Ä–≤–æ–º –æ—Ç–µ–ª–µ –¥–ª—è Smart Alternatives
                    found_hotel_info = hotels_found[0]
                    state["found_hotel_name"] = found_hotel_info.name
                    state["found_hotel_stars"] = found_hotel_info.stars
                    # HotelInfo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç region_name, –Ω–µ region
                    state["found_hotel_region"] = getattr(found_hotel_info, 'region_name', '') or getattr(found_hotel_info, 'resort_name', '')
                else:
                    # ==================== FAIL-FAST: –û–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù –í –°–ü–†–ê–í–û–ß–ù–ò–ö–ï ====================
                    state["tour_offers"] = []
                    state["hotel_not_found"] = True
                    state["response"] = (
                        f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à—ë–ª –æ—Ç–µ–ª—å ¬´{hotel_name}¬ª –≤ –±–∞–∑–µ Tourvisor.\n\n"
                        f"–£—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ {country_for_hotel}."
                    )
                    return state
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–æ—Ä—è—â–∏–π –ª–∏ —ç—Ç–æ —Ç—É—Ä
            is_hot_tour_search = (
                state.get("intent") == "hot_tours" or 
                params.get("is_hot_tour", False)
            )
            
            # –û–±—ã—á–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ search.php
            result = await tourvisor_service.search_tours(
                search_request,
                is_strict_hotel_search=is_strict,
                hotel_ids=hotel_ids,
                is_hot_tour=is_hot_tour_search  # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥–æ—Ä—è—â–∏—Ö!
            )
            
            # ==================== SMART RETRY FOR ZERO RESULTS ====================
            # –ï—Å–ª–∏ strict date search –≤–µ—Ä–Ω—É–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω
            if is_exact_date and (not result.found or not result.offers) and not is_strict:
                logger.info("   üîÑ SMART RETRY: strict date –≤–µ—Ä–Ω—É–ª 0, —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–æ ¬±2 –¥–Ω–µ–π...")
                
                # –†–∞—Å—à–∏—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
                expanded_date_from = original_date_from - timedelta(days=2)
                expanded_date_to = original_date_from + timedelta(days=2)
                
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏
                retry_request = SearchRequest(
                    adults=search_request.adults,
                    children=search_request.children,
                    destination=search_request.destination,
                    hotel_name=search_request.hotel_name,
                    stars=search_request.stars,
                    date_from=expanded_date_from,
                    date_to=expanded_date_to,
                    nights=search_request.nights,
                    food_type=search_request.food_type,
                    departure_city=search_request.departure_city,
                    services=search_request.services,
                    hotel_types=search_request.hotel_types,
                    tour_type=search_request.tour_type,
                )
                
                retry_result = await tourvisor_service.search_tours(
                    retry_request,
                    is_strict_hotel_search=is_strict,
                    hotel_ids=hotel_ids,
                    is_hot_tour=is_hot_tour_search
                )
                
                if retry_result.found and retry_result.offers:
                    result = retry_result
                    state["date_warning"] = True  # –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ
                    logger.info(f"   ‚úÖ SMART RETRY —É—Å–ø–µ—à–µ–Ω: –Ω–∞–π–¥–µ–Ω–æ {len(result.offers)} —Ç—É—Ä–æ–≤ —Å ¬±2 –¥–Ω–µ–π")
            
            # ‚õî –û–ë–†–ê–ë–û–¢–ö–ê: –û—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
            if result.reason == "hotel_not_found_in_db":
                hotel_name = params.get("hotel_name", "—É–∫–∞–∑–∞–Ω–Ω—ã–π –æ—Ç–µ–ª—å")
                country = params.get("destination_country", "—ç—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–µ")
                state["tour_offers"] = []
                state["hotel_not_found"] = True
                state["response"] = (
                    f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à—ë–ª –æ—Ç–µ–ª—å ¬´{hotel_name}¬ª –≤ –±–∞–∑–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –≤ {country}.\n\n"
                    f"–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                    f"‚Ä¢ –û—Ç–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏\n"
                    f"‚Ä¢ –û—Ç–µ–ª—å –∑–∞–∫—Ä—ã—Ç –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã\n"
                    f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–æ —Å –æ—à–∏–±–∫–æ–π\n\n"
                    f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –æ—Ç–µ–ª–∏ –≤ {country}."
                )
                return state
            
            # === –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï –î–õ–Ø –ü–ê–ì–ò–ù–ê–¶–ò–ò (GAP Analysis) ===
            if result.search_id:
                state["last_search_id"] = result.search_id
                state["last_country_id"] = tourvisor_service.get_country_id(destination.country)
                state["current_page"] = 1
                state["has_more_results"] = result.total_found > 5  # –ï—Å—Ç—å –ª–∏ –µ—â—ë —Ç—É—Ä—ã
            
            # ==================== SMART ALTERNATIVES ====================
            # –ï—Å–ª–∏ –æ—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ, –Ω–æ —Ç—É—Ä–æ–≤ –Ω–µ—Ç ‚Äî –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã!
            if is_strict and found_hotel_info and (not result.found or not result.offers):
                # –¢—É—Ä–æ–≤ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å –Ω–µ—Ç ‚Äî –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
                hotel_stars = found_hotel_info.stars or 5
                # HotelInfo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç region_name, –Ω–µ region
                hotel_region = getattr(found_hotel_info, 'region_name', '') or getattr(found_hotel_info, 'resort_name', '')
                hotel_display_name = found_hotel_info.name
                
                # –°–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ (–ø–æ —Ä–µ–≥–∏–æ–Ω—É –∏ –∑–≤—ë–∑–¥–Ω–æ—Å—Ç–∏)
                alt_search_request = SearchRequest(
                    adults=params.get("adults"),  # –ë–µ–∑ –¥–µ—Ñ–æ–ª—Ç–∞!
                    children=params.get("children", []),
                    destination=Destination(
                        country=params.get("destination_country"),
                        region=hotel_region  # –¢–æ—Ç –∂–µ —Ä–µ–≥–∏–æ–Ω
                    ),
                    stars=hotel_stars,  # –¢–µ –∂–µ –∑–≤—ë–∑–¥—ã
                    date_from=date_from,
                    date_to=date_to,
                    food_type=params.get("food_type"),
                    departure_city=params.get("departure_city", "–ú–æ—Å–∫–≤–∞")
                )
                
                # –ü–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ (–ë–ï–ó —Å—Ç—Ä–æ–≥–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –æ—Ç–µ–ª—é)
                alt_result = await tourvisor_service.search_tours(
                    alt_search_request,
                    is_strict_hotel_search=False,
                    hotel_ids=None
                )
                
                if alt_result.found and alt_result.offers:
                    # –ò—Å–∫–ª—é—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–µ–ª—å –∏–∑ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤
                    filtered_offers = [
                        offer for offer in alt_result.offers
                        if offer.hotel_name.lower() != hotel_display_name.lower()
                    ][:5]
                    
                    if filtered_offers:
                        state["tour_offers"] = filtered_offers
                        state["smart_alternatives"] = True
                        state["original_hotel_name"] = hotel_display_name
                        state["original_hotel_stars"] = hotel_stars
                        state["original_hotel_region"] = hotel_region or country_for_hotel
                    else:
                        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ —Ç–æ–∂–µ –Ω–µ—Ç
                        state["tour_offers"] = []
                        state["no_alternatives"] = True
                else:
                    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ –Ω–µ—Ç
                    state["tour_offers"] = []
                    state["no_alternatives"] = True
                    state["search_reason"] = result.reason
                    state["search_suggestion"] = result.suggestion
            else:
                state["tour_offers"] = result.offers if result.found else []
                
                if not result.found:
                    state["search_reason"] = result.reason
                    state["search_suggestion"] = result.suggestion
        
    except Exception as e:
        state["error"] = f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}"
        state["tour_offers"] = []
    
    return state


def generate_no_results_explanation(params: PartialSearchParams, state: AgentState = None) -> tuple[str, bool, str]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–º–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è.
    
    GAP Analysis: –î–æ–±–∞–≤–ª–µ–Ω Smart Fallback –ø–æ —Ç–∏–ø—É –ø–∏—Ç–∞–Ω–∏—è (AI -> HB).
    
    Returns:
        tuple: (—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞, –Ω—É–∂–Ω–æ –ª–∏ –∂–¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏—è, —Ç–∏–ø –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è)
    """
    country = params.get("destination_country", "")
    date_from = params.get("date_from")
    departure_city = params.get("departure_city", "")
    food_type = params.get("food_type")
    stars = params.get("stars")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –∏–∑ state
    search_attempts = state.get("search_attempts", 0) if state else 0
    flex_days = state.get("flex_days", 2) if state else 2
    flex_search_done = state.get("flex_search", False) if state else False
    offered_alt_departure = state.get("offered_alt_departure", False) if state else False
    offered_alt_food = state.get("offered_alt_food", False) if state else False
    offered_lower_stars = state.get("offered_lower_stars", False) if state else False
    
    if date_from:
        date_str = date_from.strftime("%d.%m")
        
        # –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
        if not flex_search_done and search_attempts <= 1:
            response = f"–ù–∞ {date_str} –≤—ã–ª–µ—Ç–æ–≤ –∏–∑ {departure_city} –Ω–µ—Ç. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ –¥–∞—Ç—ã?"
            return (response, True, "flex_dates")
        
        # === SMART FALLBACK: –ü–û –¢–ò–ü–£ –ü–ò–¢–ê–ù–ò–Ø (GAP Analysis) ===
        # –ï—Å–ª–∏ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ AI/UAI ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º HB –∏–ª–∏ FB
        if food_type and food_type.value in ("AI", "UAI") and not offered_alt_food:
            food_name = "–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ" if food_type.value == "AI" else "–£–ª—å—Ç—Ä–∞ –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ"
            response = (
                f"–° –ø–∏—Ç–∞–Ω–∏–µ–º ¬´{food_name}¬ª –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–µ—Ç.\n"
                f"–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–µ–ª–∏ —Å ¬´–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω¬ª (HB: –∑–∞–≤—Ç—Ä–∞–∫ + —É–∂–∏–Ω)?"
            )
            return (response, True, "alt_food")
        
        # === SMART FALLBACK: –ü–û –ó–í–Å–ó–î–ù–û–°–¢–ò ===
        # –ï—Å–ª–∏ –±—ã–ª–æ —É–∫–∞–∑–∞–Ω–æ 5* ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º 4*
        if stars and stars >= 5 and not offered_lower_stars:
            response = (
                f"–û—Ç–µ–ª–µ–π {stars}‚≠ê –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã –Ω–µ—Ç.\n"
                f"–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å 4‚≠ê –æ—Ç–µ–ª–∏?"
            )
            return (response, True, "lower_stars")
        
        # –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–∞—Ç) ‚Äî –µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ –ú–æ—Å–∫–≤–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ú–æ—Å–∫–≤—É
        if flex_search_done and departure_city.lower() != "–º–æ—Å–∫–≤–∞" and not offered_alt_departure:
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä–∏–ª–∏
            from_date = (date_from - timedelta(days=flex_days)).strftime("%d.%m")
            to_date = (date_from + timedelta(days=flex_days)).strftime("%d.%m")
            response = (
                f"–Ø –ø—Ä–æ–≤–µ—Ä–∏–ª –¥–∞—Ç—ã —Å {from_date} –ø–æ {to_date}, –Ω–æ —Ä–µ–π—Å–æ–≤ –∏–∑ {departure_city} –Ω–µ—Ç.\n"
                f"–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–ª–µ—Ç –∏–∑ –ú–æ—Å–∫–≤—ã?"
            )
            return (response, True, "alt_departure")
        
        # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –Ω–µ –∑–∞–¥–∞—ë–º –≤–æ–ø—Ä–æ—Å, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª
        from_date = (date_from - timedelta(days=flex_days)).strftime("%d.%m")
        to_date = (date_from + timedelta(days=flex_days)).strftime("%d.%m")
        response = (
            f"–Ø –ø—Ä–æ–≤–µ—Ä–∏–ª –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å {from_date} –ø–æ {to_date}.\n"
            f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ä–µ–π—Å–æ–≤ –Ω–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–≤–∏–Ω—É—Ç—å –æ—Ç–ø—É—Å–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ."
        )
        return (response, False, None)  # –ù–ï –∂–¥—ë–º —Å–æ–≥–ª–∞—Å–∏—è ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª
    
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
    return (
        "–ü–æ –∑–∞–ø—Ä–æ—Å—É —Ç—É—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.",
        False,
        None
    )


async def responder(state: AgentState) -> AgentState:
    """
    –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞.
    
    –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
    - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
    - –ö–∞—Å–∫–∞–¥ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    - –£–º–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    """
    # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, hotel_not_found) ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
    if state.get("hotel_not_found") and state.get("response"):
        return state
    
    # –û—à–∏–±–∫–∞
    if state.get("error"):
        state["response"] = f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {state['error']}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."
        return state
    
    params = state["search_params"]
    cascade_stage = get_cascade_stage(params, state.get("search_mode", "package"))
    is_first = state.get("is_first_message", False) and not state.get("greeted", False)
    
    # –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç—É—Ä—ã ‚Äî –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
    if state["tour_offers"]:
        offers = state["tour_offers"]
        country = params.get("destination_country", "")
        hotel_name = params.get("hotel_name", "")
        date_from = params.get("date_from")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        date_str = date_from.strftime("%d.%m") if date_from else ""
        
        # ==================== SMART ALTERNATIVES RESPONSE ====================
        if state.get("smart_alternatives"):
            # –≠—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –∞ –Ω–µ –∏—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–µ–ª—å!
            original_hotel = state.get("original_hotel_name", hotel_name)
            original_stars = state.get("original_hotel_stars", 5)
            original_region = state.get("original_hotel_region", country)
            
            header = (
                f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ {original_hotel} –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã —Ç—É—Ä–æ–≤ –Ω–µ—Ç (–º–µ—Å—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å).\n\n"
                f"–ù–æ —è –ø–æ–¥–æ–±—Ä–∞–ª –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã {original_stars}‚òÖ –≤ —Ä–µ–≥–∏–æ–Ω–µ {original_region}:"
            )
        else:
            # –û–±—ã—á–Ω–∞—è –≤—ã–¥–∞—á–∞
            if hotel_name:
                header = f"–í–æ—Ç —Ç—É—Ä—ã –≤ {hotel_name}"
            else:
                header = f"–í–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ {country}"
            
            if date_str:
                header += f" –Ω–∞ {date_str}"
            header += ":"
        
        # ==================== DATE WARNING (Smart Retry) ====================
        # –ï—Å–ª–∏ strict date search –≤–µ—Ä–Ω—É–ª 0 –∏ –º—ã —Ä–∞—Å—à–∏—Ä–∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        date_warning = ""
        if state.get("date_warning"):
            original_date = state.get("original_date_from")
            if original_date:
                date_warning = f"\n‚ö†Ô∏è –ù–∞ —Ç–æ—á–Ω—É—é –¥–∞—Ç—É {original_date.strftime('%d.%m')} —Ä–µ–π—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞—é –±–ª–∏–∂–∞–π—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (¬±2 –¥–Ω—è).\n"
            else:
                date_warning = "\n‚ö†Ô∏è –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é —Ç–æ—á–Ω—É—é –¥–∞—Ç—É —Ä–µ–π—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞—é –±–ª–∏–∂–∞–π—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (¬±2 –¥–Ω—è).\n"
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
            state["date_warning"] = False
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–µ–∑–æ–Ω–µ (–º—è–≥–∫–æ–µ, –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π)
        season_warning = ""
        if date_from and country and not state.get("smart_alternatives"):
            month = date_from.month
            off_season, _ = is_off_season(country, month)
            if off_season and country == "–¢—É—Ä—Ü–∏—è":
                season_warning = "\n(–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –º–æ—Ä–µ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ–µ –¥–ª—è –∫—É–ø–∞–Ω–∏—è.)"
        
        state["response"] = header + date_warning + season_warning
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –æ–∂–∏–¥–∞–Ω–∏—è
        state["awaiting_agreement"] = False
        state["pending_action"] = None
        return state
    
    # –ö–ê–°–ö–ê–î –í–û–ü–†–û–°–û–í (—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫)
    
    # ==================== –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ê ====================
    # –°–æ–±–∏—Ä–∞–µ–º —á—Ç–æ –£–ñ–ï –∑–Ω–∞–µ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ
    hotel_name = params.get("hotel_name", "")
    country = params.get("destination_country", "")
    departure = params.get("departure_city", "")
    date_from = params.get("date_from")
    date_str = date_from.strftime("%d.%m") if date_from else ""
    adults = params.get("adults", 0)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–æ–≥–æ
    confirmation_parts = []
    if hotel_name:
        confirmation_parts.append(f"–æ—Ç–µ–ª—å {hotel_name}")
    if country and not hotel_name:
        confirmation_parts.append(country)
    if date_str:
        confirmation_parts.append(f"–Ω–∞ {date_str}")
    if adults:
        confirmation_parts.append(f"–Ω–∞ {adults} —á–µ–ª.")
    
    confirmation = ", ".join(confirmation_parts) if confirmation_parts else ""
    
    # –≠—Ç–∞–ø 1: –Ω—É–∂–Ω–∞ —Å—Ç—Ä–∞–Ω–∞
    if cascade_stage == 1:
        # ==================== –ê–ù–¢–ò-–ü–û–í–¢–û–†–ù–û–ï –ü–†–ò–í–ï–¢–°–¢–í–ò–ï ====================
        # –ö–†–ò–¢–ò–ß–ù–û: –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ > 2 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ!
        messages_count = len(state.get("messages", []))
        already_greeted = state.get("greeted", False)
        
        if is_first and not already_greeted and messages_count <= 2:
            # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —Å—Ä–∞–∑—É –∫ –¥–µ–ª—É, –±–µ–∑ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
            state["response"] = "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"
            state["greeted"] = True
        else:
            # –í —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ª–æ–≥–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
            state["response"] = "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"
        return state
    
    # –≠—Ç–∞–ø 2: –Ω—É–∂–µ–Ω –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
    if cascade_stage == 2:
        state["response"] = "–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç?"
        return state
    
    # –≠—Ç–∞–ø 3: –Ω—É–∂–Ω—ã –¥–∞—Ç—ã ‚Äî –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
    if cascade_stage == 3:
        state["response"] = "–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ª–µ—Ç?"
        return state
    
    # --- –≠–¢–ê–ü 4: HARD VALIDATION (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) ---
    # –ë–µ–∑ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –∏–ª–∏ –¥–∞—Å—Ç –Ω–µ–≤–µ—Ä–Ω—É—é —Ü–µ–Ω—É.
    # –≠—Ç–æ "–ñ–µ—Å—Ç–∫–∏–π –±–∞—Ä—å–µ—Ä" ‚Äî —Ñ–ª–∞–≥–∏ —Ç–∏–ø–∞ clarification_asked –∑–¥–µ—Å—å –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç!
    if cascade_stage == 4:
        adults_explicit = params.get("adults_explicit", False)
        has_adults = params.get("adults") and adults_explicit
        has_nights = params.get("nights")
        
        # ==================== 1. –ü–†–û–í–ï–†–ö–ê –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø (RIXOS FIX) ====================
        # –ï—Å–ª–∏ –æ—Ç–µ–ª—å —É–∫–∞–∑–∞–Ω ‚Üí –ü–†–û–ü–£–°–ö–ê–ï–ú –≤–æ–ø—Ä–æ—Å –æ —Å—Ç—Ä–∞–Ω–µ (—Å—Ç—Ä–∞–Ω—É –ø–æ–¥—Ç—è–Ω–µ–º –∏–∑ –ø–æ–∏—Å–∫–∞)
        if not params.get("destination_country") and not params.get("hotel_name"):
            state["response"] = "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ –≥–æ—Ä–æ–¥ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"
            state["last_question_type"] = "destination"
            return state
        
        # ==================== 2. –ü–†–û–í–ï–†–ö–ê –î–ê–¢ ====================
        if not params.get("date_from"):
            # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–µ–ª—å ‚Äî VIP —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞
            if hotel_name:
                state["response"] = f"–ù–∞ –∫–∞–∫–∏–µ –¥–∞—Ç—ã —Å–º–æ—Ç—Ä–∏–º {hotel_name}?"
            else:
                state["response"] = "–ù–∞ –∫–∞–∫–∏–µ –¥–∞—Ç—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ª–µ—Ç?"
            state["last_question_type"] = "dates"
            return state
        
        # ==================== 3. –ü–†–û–í–ï–†–ö–ê –ù–û–ß–ï–ô ====================
        if not has_nights:
            state["response"] = "–ù–∞ —Å–∫–æ–ª—å–∫–æ –Ω–æ—á–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"
            state["last_question_type"] = "nights"
            return state
        
        # ==================== 4. –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–ê–í–ê (CHILDREN FIX) ====================
        # –ö–†–ò–¢–ò–ß–ù–û: –ù–µ–ª—å–∑—è –∏—Å–∫–∞—Ç—å, –Ω–µ –∑–Ω–∞—è –ü–û–õ–ù–´–ô —Å–æ—Å—Ç–∞–≤!
        children_ages = params.get("children", [])  # –°–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤
        children_mentioned = params.get("children_mentioned")  # None = –º—ã –Ω–µ –∑–Ω–∞–µ–º, –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∏
        children_count_mentioned = params.get("children_count_mentioned", 0)
        
        # –í–∞—Ä–∏–∞–Ω—Ç A: adults –Ω–µ —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ‚Üí —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤
        if not has_adults:
            state["response"] = "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç? –£–∫–∞–∂–∏—Ç–µ –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ –¥–µ—Ç–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º)."
            state["last_question_type"] = "adults"
            return state
        
        # –í–∞—Ä–∏–∞–Ω—Ç B: adults —É–∫–∞–∑–∞–Ω, –Ω–æ –º—ã –ù–ï –ó–ù–ê–ï–ú –ø—Ä–æ –¥–µ—Ç–µ–π (children_mentioned is None)
        # –ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–∫–∞–∑–∞–ª —è–≤–Ω–æ "–æ–¥–∏–Ω" –∏–ª–∏ "–±–µ–∑ –¥–µ—Ç–µ–π"
        no_children_phrases = params.get("no_children_explicit", False)  # "–±–µ–∑ –¥–µ—Ç–µ–π", "—Ç–æ–ª—å–∫–æ –≤–∑—Ä–æ—Å–ª—ã–µ"
        if not no_children_phrases and children_mentioned is None and not children_ages:
            adults = params.get("adults", 0)
            if adults == 1:
                # "—è –æ–¥–∏–Ω" ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ –±–µ–∑ –¥–µ—Ç–µ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ–ø—Ä–æ—Å
                pass
            else:
                # 2+ –≤–∑—Ä–æ—Å–ª—ã—Ö ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ —Å–µ–º—å—è —Å –¥–µ—Ç—å–º–∏
                state["response"] = "–ü–æ–µ–¥—É—Ç –ª–∏ —Å –≤–∞–º–∏ –¥–µ—Ç–∏? –ï—Å–ª–∏ –¥–∞ ‚Äî —É–∫–∞–∂–∏—Ç–µ –∏—Ö –≤–æ–∑—Ä–∞—Å—Ç."
                state["last_question_type"] = "children_check"
                return state
        
        # ==================== 5. –ü–†–û–í–ï–†–ö–ê –î–ï–¢–ï–ô –ë–ï–ó –í–û–ó–†–ê–°–¢–ê (–ö–†–ò–¢–ò–ß–ù–û –ü–û –¢–ó!) ====================
        # –ï—Å–ª–∏ –±–æ—Ç –ø–æ–Ω—è–ª, —á—Ç–æ –µ—Å—Ç—å –¥–µ—Ç–∏, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç ‚Äî –°–¢–û–ü.
        if children_mentioned and not children_ages:
            if children_count_mentioned == 1:
                state["response"] = "–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã)."
            elif children_count_mentioned > 1:
                state["response"] = f"–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç –≤—Å–µ—Ö {children_count_mentioned} –¥–µ—Ç–µ–π (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã)."
            else:
                state["response"] = "–£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã)."
            state["last_question_type"] = "children_ages"
            return state
        
        # –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –º–µ–Ω—å—à–µ —á–µ–º —É–ø–æ–º—è–Ω—É—Ç–æ –¥–µ—Ç–µ–π
        if children_count_mentioned > len(children_ages):
            missing = children_count_mentioned - len(children_ages)
            state["response"] = f"–í—ã —É–ø–æ–º—è–Ω—É–ª–∏ {children_count_mentioned} –¥–µ—Ç–µ–π, –Ω–æ —É–∫–∞–∑–∞–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è {len(children_ages)}. –£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö."
            state["last_question_type"] = "children_ages"
            return state
        
        # ==================== –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´ ====================
        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ Soft Clarification (Stage 5)
        logger.info("   ‚úÖ Hard Validation passed. Moving to Stage 5.")
        state["cascade_stage"] = 5
        # –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ‚Äî –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø–∞–¥—ë—Ç –≤ –±–ª–æ–∫ cascade_stage == 5
    
    # –≠—Ç–∞–ø 5: –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏ (SOFT CLARIFICATION)
    # –õ–û–ì–ò–ö–ê:
    # - –ï—Å–ª–∏ –æ—Ç–µ–ª—å –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–∏—â–µ–º)
    # - –ï—Å–ª–∏ clarification_asked == False ‚Üí —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –∑–≤—ë–∑–¥—ã/–ø–∏—Ç–∞–Ω–∏–µ
    # - –ï—Å–ª–∏ clarification_asked == True ‚Üí –∫–ª–∏–µ–Ω—Ç—É –≤—Å—ë —Ä–∞–≤–Ω–æ, –∏—â–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if cascade_stage == 5:
        # –ï—Å–ª–∏ –æ—Ç–µ–ª—å —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å!
        if hotel_name:
            state["cascade_stage"] = 6
            # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫ –ø–æ–∏—Å–∫—É
        
        # –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ ‚Äî –∑–Ω–∞—á–∏—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ
        elif state.get("clarification_asked", False):
            logger.info("   ‚úÖ Soft Clarification: –∫–ª–∏–µ–Ω—Ç—É –≤—Å—ë —Ä–∞–≤–Ω–æ, –∏—â–µ–º –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤")
            state["cascade_stage"] = 6
            state["skip_quality_check"] = True
            # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫ –ø–æ–∏—Å–∫—É
        
        # –ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –∫–∞—á–µ—Å—Ç–≤–æ ‚Äî –ë–ï–ó "–ü—Ä–∏–Ω—è—Ç–æ:"
        else:
            state["response"] = "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è –∏ –ø–∏—Ç–∞–Ω–∏–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5 –∑–≤—ë–∑–¥, –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ)"
            state["clarification_asked"] = True
            state["quality_check_asked"] = True
            state["last_question_type"] = "stars"
            return state
    
    # –≠—Ç–∞–ø 6 (cascade_stage == 6): –≤—Å—ë —Å–æ–±—Ä–∞–Ω–æ, –Ω–æ —Ç—É—Ä–æ–≤ –Ω–µ—Ç
    # –≠—Ç–æ –∑–Ω–∞—á–∏—Ç –ø–æ–∏—Å–∫ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –≤–µ—Ä–Ω—É–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
    state["search_attempts"] = state.get("search_attempts", 0) + 1
    
    # ==================== –ß–ï–°–¢–ù–´–ô –û–¢–í–ï–¢: –ù–ï–¢ –¢–£–†–û–í –° –§–ò–õ–¨–¢–†–ê–ú–ò ====================
    # –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –≤–µ—Ä–Ω—É–ª reason="no_tours_with_filters" ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
    search_reason = state.get("search_reason")
    
    if search_reason == "no_tours_with_filters":
        stars = params.get("stars")
        food = params.get("food_type")
        country = params.get("destination_country", "")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ß–ï–°–¢–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
        if stars:
            alt_stars = stars - 1 if stars > 3 else None
            if alt_stars:
                state["response"] = (
                    f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –æ—Ç–µ–ª–µ–π {stars}‚òÖ –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã –≤ {country} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
                    f"–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã {alt_stars}‚òÖ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã?"
                )
                state["awaiting_agreement"] = True
                state["pending_action"] = "lower_stars"
                state["alt_stars"] = alt_stars
            else:
                state["response"] = (
                    f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç—É—Ä–æ–≤ –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã –≤ {country} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n"
                    f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã –∏–ª–∏ –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞."
                )
        else:
            state["response"] = (
                f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç—É—Ä–æ–≤ –≤ {country} –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã –∏–ª–∏ –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞."
            )
        return state
    
    response_text, awaiting, action = generate_no_results_explanation(params, state)
    state["response"] = response_text
    state["awaiting_agreement"] = awaiting
    state["pending_action"] = action
    
    # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫–æ–π —Ç–∏–ø –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏
    if action == "alt_departure":
        state["offered_alt_departure"] = True
    elif action == "alt_food":
        state["offered_alt_food"] = True
    elif action == "lower_stars":
        state["offered_lower_stars"] = True
    
    return state


async def booking_handler(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."""
    intent = state.get("intent", "")
    user_text = state["messages"][-1]["content"] if state["messages"] else ""
    
    if intent == "phone_provided":
        phone = detect_phone_number(user_text)
        if phone:
            state["customer_phone"] = phone
            state["awaiting_phone"] = False
            
            from app.services.crm import save_lead
            
            params = state.get("search_params", {})
            description = format_context(params)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–º–µ—Ç–∫—É –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
            if state.get("is_group_request"):
                group_size = state.get("group_size", 0)
                description = f"[GROUP REQUEST > 6 PAX ({group_size} —á–µ–ª.)] " + description
            
            try:
                await save_lead(
                    name=state.get("customer_name") or "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                    phone=phone,
                    search_params=description,
                    tour_offer_id=state.get("selected_tour_id")
                )
                
                if state.get("is_group_request"):
                    state["response"] = (
                        f"–°–ø–∞—Å–∏–±–æ! –ì—Ä—É–ø–ø–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.\n\n"
                        f"–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
                        f"–ì—Ä—É–ø–ø–∞: {state.get('group_size', 0)} —á–µ–ª–æ–≤–µ–∫\n"
                        f"–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {format_context(params)}\n\n"
                        f"–ú–µ–Ω–µ–¥–∂–µ—Ä –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤—è–∂–µ—Ç—Å—è —Å –í–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è "
                        f"–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π."
                    )
                else:
                    state["response"] = (
                        f"–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.\n\n"
                        f"–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
                        f"–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {description}\n\n"
                        f"–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –í–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
                    )
            except Exception as e:
                state["response"] = f"–û—à–∏–±–∫–∞: {str(e)}. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é."
            
            return state
    
    # ==================== –ì–†–£–ü–ü–û–í–ê–Ø –ó–ê–Ø–í–ö–ê (>6 —á–µ–ª–æ–≤–µ–∫) ====================
    if intent == "group_booking":
        group_size = state.get("group_size", 7)
        params = state.get("search_params", {})
        context = format_context(params) if params else ""
        
        state["awaiting_phone"] = True
        state["response"] = (
            f"–î–ª—è –≥—Ä—É–ø–ø –±–æ–ª–µ–µ 6 —á–µ–ª–æ–≤–µ–∫ ({group_size} —á–µ–ª.) —É –Ω–∞—Å –¥–µ–π—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∏ —Å–∫–∏–¥–∫–∏.\n\n"
            f"–ß—Ç–æ–±—ã —è –º–æ–≥ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å, –¥–∞–≤–∞–π—Ç–µ —è –ø–µ—Ä–µ–¥–∞–º –∑–∞—è–≤–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—É –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n"
            f"–ù–∞–ø–∏—à–∏—Ç–µ –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –í–∞–º–∏."
        )
        return state
    
    if intent == "booking":
        state["awaiting_phone"] = True
        
        if state.get("tour_offers"):
            state["response"] = "–û—Ç–ª–∏—á–Ω–æ! –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞."
        else:
            state["response"] = "–•–æ—Ä–æ—à–æ. –ù–∞–ø–∏—à–∏—Ç–µ –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –í–∞–º–∏."
        
        return state
    
    return state


async def continue_search_handler(state: AgentState) -> AgentState:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞: continue –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç—É—Ä–æ–≤.
    
    GAP Analysis: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è continue –¥–ª—è —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.
    """
    search_id = state.get("last_search_id")
    country_id = state.get("last_country_id")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
    if not search_id:
        state["response"] = (
            "–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤. "
            "–ö—É–¥–∞ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–µ—Ö–∞—Ç—å?"
        )
        return state
    
    try:
        offers, has_more = await tourvisor_service.continue_search(
            request_id=search_id,
            country_id=country_id or 1
        )
        
        if offers:
            state["tour_offers"] = offers
            state["has_more_results"] = has_more
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            response_lines = [f"üîÑ **–£–≥–ª—É–±–ª—ë–Ω–Ω—ã–π –ø–æ–∏—Å–∫** ‚Äî –Ω–∞–π–¥–µ–Ω–æ –µ—â—ë {len(offers)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\n"]
            
            for i, offer in enumerate(offers, 1):
                price_info = f"{offer.price_value:,} ‚ÇΩ".replace(",", " ") if offer.price_value else offer.price
                response_lines.append(
                    f"**{i}. {offer.hotel_name}** ({offer.stars}‚≠ê)\n"
                    f"   üìç {offer.location}\n"
                    f"   üçΩÔ∏è {offer.food_type_display}\n"
                    f"   üìÖ {offer.date_start} ‚Äî {offer.nights} –Ω–æ—á–µ–π\n"
                    f"   üí∞ **{price_info}**\n"
                )
            
            if has_more:
                response_lines.append("\nüí° –°–∫–∞–∂–∏—Ç–µ ¬´–∏—Å–∫–∞—Ç—å –µ—â—ë¬ª –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞.")
            
            state["response"] = "\n".join(response_lines)
        else:
            state["has_more_results"] = False
            state["response"] = (
                "–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã —É–∂–µ –æ–ø—Ä–æ—à–µ–Ω—ã, –Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç.\n\n"
                "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞?"
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ continue search: {e}")
        state["response"] = (
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∏—Å–∫. "
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã."
        )
    
    return state


async def more_tours_handler(state: AgentState) -> AgentState:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    
    GAP Analysis: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–ï—â—ë —Ç—É—Ä—ã" (page=2, page=3...)
    """
    search_id = state.get("last_search_id")
    country_id = state.get("last_country_id")
    current_page = state.get("current_page", 1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    if not search_id:
        state["response"] = (
            "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∏. "
            "–î–∞–≤–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏–º –ø–æ–∏—Å–∫ ‚Äî –∫–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
        )
        return state
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    next_page = current_page + 1
    
    try:
        offers = await tourvisor_service.fetch_more_results(
            request_id=search_id,
            country_id=country_id or 1,
            page=next_page,
            onpage=5
        )
        
        if offers:
            state["tour_offers"] = offers
            state["current_page"] = next_page
            state["has_more_results"] = len(offers) >= 5
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            response_lines = [f"üìÑ **–°—Ç—Ä–∞–Ω–∏—Ü–∞ {next_page}** ‚Äî –µ—â—ë {len(offers)} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\n"]
            
            for i, offer in enumerate(offers, 1):
                price_info = f"{offer.price_value:,} ‚ÇΩ".replace(",", " ") if offer.price_value else offer.price
                response_lines.append(
                    f"**{i}. {offer.hotel_name}** ({offer.stars}‚≠ê)\n"
                    f"   üìç {offer.location}\n"
                    f"   üçΩÔ∏è {offer.food_type_display}\n"
                    f"   üìÖ {offer.date_start} ‚Äî {offer.nights} –Ω–æ—á–µ–π\n"
                    f"   üí∞ **{price_info}**\n"
                )
            
            if state.get("has_more_results"):
                response_lines.append("\nüí° –°–∫–∞–∂–∏—Ç–µ ¬´–µ—â—ë —Ç—É—Ä—ã¬ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.")
            
            state["response"] = "\n".join(response_lines)
        else:
            state["has_more_results"] = False
            state["response"] = (
                "–≠—Ç–æ –±—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—É—Ä—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.\n\n"
                "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è?"
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: {e}")
        state["response"] = (
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—É—Ä—ã. "
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        )
    
    return state


async def child_ages_handler(state: AgentState) -> AgentState:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –¥–µ—Ç–µ–π.
    –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–∏—Å–∫ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –±–µ–∑ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞.
    """
    missing_count = state.get("missing_child_ages", 1)
    params = state.get("search_params", {})
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–µ–π
    if missing_count == 1:
        question = "–°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Ä–µ–±—ë–Ω–∫—É? –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã."
    else:
        question = f"–£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ ({missing_count} —á–µ–ª.). –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ü–µ–Ω—ã."
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º
    country = params.get("destination_country")
    if country:
        question = f"{country} ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞! " + question
    
    state["response"] = question
    return state


def should_search(state: AgentState) -> str:
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞."""
    intent = state.get("intent", "search_tour")
    params = state.get("search_params", {})
    
    # ==================== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –î–ï–¢–ò –ë–ï–ó –í–û–ó–†–ê–°–¢–ê ====================
    if intent == "ask_child_ages":
        return "ask_child_ages"
    
    # ==================== –ü–ê–ì–ò–ù–ê–¶–ò–Ø: –ï–©–Å –¢–£–†–´ (GAP Analysis) ====================
    if intent == "more_tours":
        return "more_tours"
    
    # ==================== –£–ì–õ–£–ë–õ–Å–ù–ù–´–ô –ü–û–ò–°–ö (GAP Analysis) ====================
    if intent == "continue_search":
        return "continue_search"
    
    # ==================== –ì–†–£–ü–ü–û–í–ê–Ø –ó–ê–Ø–í–ö–ê ====================
    if intent == "group_booking":
        return "booking"
    
    # ==================== –ù–ï–í–ê–õ–ò–î–ù–ê–Ø –°–¢–†–ê–ù–ê ====================
    if intent == "invalid_country":
        return "invalid_country"
    
    if intent in ("booking", "phone_provided"):
        return "booking"
    
    if intent.startswith("faq_") or intent == "greeting":
        return "faq"
    
    if intent == "general_chat":
        return "general_chat"
    
    # –ï—Å–ª–∏ intent —è–≤–Ω–æ "search_tour" –∏ cascade_stage == 6 (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ input_analyzer)
    # –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–∏—Å–∫—É
    if intent == "search_tour" and state.get("cascade_stage") == 6:
        return "search"
    
    # –ö–∞—Å–∫–∞–¥ (–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è)
    cascade_stage = state.get("cascade_stage") or get_cascade_stage(params, state.get("search_mode", "package"))
    
    # –ï—Å–ª–∏ –Ω–µ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–∫–ª—é—á–∞—è –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞!) ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
    if cascade_stage <= 4:
        return "ask"
    
    # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏ ‚Äî quality_check (SOFT CLARIFICATION)
    # –ù–û: –ï—Å–ª–∏ –æ—Ç–µ–ª—å –∏–∑–≤–µ—Å—Ç–µ–Ω, skip_quality_check –∏–ª–∏ clarification_asked ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º!
    if cascade_stage == 5:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –æ—Ç–µ–ª—å –∏–∑–≤–µ—Å—Ç–µ–Ω
        if params.get("hotel_name") or params.get("skip_quality_check"):
            return "search"
        
        # –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ ‚Äî –∫–ª–∏–µ–Ω—Ç—É –≤—Å—ë —Ä–∞–≤–Ω–æ, –∏—â–µ–º
        if state.get("clarification_asked"):
            return "search"
        
        # –ï—Å–ª–∏ –µ—â—ë –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
        if not state.get("quality_check_asked"):
            return "quality_check"
    
    # –ò–Ω–∞—á–µ ‚Äî –ø–æ–∏—Å–∫
    return "search"


=== app/agent/state.py ===

"""
–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ LangGraph –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ú–ì–ü.

–ö–∞—Å–∫–∞–¥ –≤–æ–ø—Ä–æ—Å–æ–≤ (–°–¢–†–û–ì–ò–ô –ü–û–†–Ø–î–û–ö):
1. –ö—É–¥–∞? (—Å—Ç—Ä–∞–Ω–∞)
2. –û—Ç–∫—É–¥–∞? (–≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
3. –ö–æ–≥–¥–∞? (–¥–∞—Ç—ã)
4. –ö—Ç–æ –µ–¥–µ—Ç? (—Å–æ—Å—Ç–∞–≤)
5. –î–µ—Ç–∞–ª–∏ (–∑–≤—ë–∑–¥—ã, –ø–∏—Ç–∞–Ω–∏–µ)
"""
from __future__ import annotations

from datetime import date
from typing import TypedDict, Optional
from app.models.domain import TourOffer, FoodType


class PartialSearchParams(TypedDict, total=False):
    """–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."""
    # –¢—É—Ä–∏—Å—Ç—ã
    adults: int
    children: list[int]
    
    # –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    destination_country: str
    destination_region: str
    destination_resort: str
    destination_city: str
    
    # –î–∞—Ç—ã
    date_from: date
    date_to: date
    nights: int
    
    # –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ü–ê–†–ê–ú–ï–¢–†!
    departure_city: str
    
    # –û—Ç–µ–ª—å
    hotel_name: str
    stars: int
    
    # –ü–∏—Ç–∞–Ω–∏–µ
    food_type: FoodType
    
    # === –ù–û–í–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ (GAP Analysis) ===
    # –£—Å–ª—É–≥–∏ –æ—Ç–µ–ª–µ–π (ID –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ services)
    services: list[int]
    
    # –¢–∏–ø—ã –æ—Ç–µ–ª–µ–π (–¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ hoteltypes)
    hotel_types: list[str]
    
    # –¢–∏–ø —Ç—É—Ä–∞ (–¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ tourtype)
    tour_type: int
    
    # –§–ª–∞–≥–∏
    skip_quality_check: bool
    
    # === STRICT SLOT FILLING FLAGS ===
    # –ö–†–ò–¢–ò–ß–ù–û: –≠—Ç–∏ —Ñ–ª–∞–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ø–í–ù–û —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!
    adults_explicit: bool       # adults —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ ("2 —á–µ–ª–æ–≤–µ–∫–∞", "–≤–¥–≤–æ—ë–º")
    dates_confirmed: bool       # –î–∞—Ç–∞ —É–∫–∞–∑–∞–Ω–∞ —è–≤–Ω–æ ("15 —Ñ–µ–≤—Ä–∞–ª—è")
    is_exact_date: bool         # –£–∫–∞–∑–∞–Ω–∞ —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ (–Ω–µ "–≤ —Ñ–µ–≤—Ä–∞–ª–µ")
    children_mentioned: bool    # –£–ø–æ–º—è–Ω—É—Ç—ã –¥–µ—Ç–∏ (–Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç)
    children_count_mentioned: int  # –°–∫–æ–ª—å–∫–æ –¥–µ—Ç–µ–π —É–ø–æ–º—è–Ω—É—Ç–æ


class Message(TypedDict):
    """–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞."""
    role: str
    content: str


class AgentState(TypedDict):
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è LangGraph."""
    messages: list[Message]
    search_params: PartialSearchParams
    missing_info: list[str]
    tour_offers: list[TourOffer]
    response: str
    intent: Optional[str]
    error: Optional[str]
    customer_name: Optional[str]
    customer_phone: Optional[str]
    awaiting_phone: bool
    selected_tour_id: Optional[str]
    cascade_stage: int
    quality_check_asked: bool
    clarification_asked: bool  # Soft Clarification: —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –ø—Ä–æ –∑–≤—ë–∑–¥—ã/–ø–∏—Ç–∞–Ω–∏–µ
    is_first_message: bool
    # –§–ª–∞–≥: –±—ã–ª–æ –ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    greeted: bool
    # –ì—Ä—É–ø–ø–æ–≤–∞—è –∑–∞—è–≤–∫–∞ (>6 —á–µ–ª–æ–≤–µ–∫)
    is_group_request: bool
    group_size: int
    # –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞
    invalid_country: Optional[str]
    # –§–ª–∞–≥ –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ (¬±5 –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è)
    flex_search: bool
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2, –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è 5)
    flex_days: int
    # –§–ª–∞–≥: –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ, –∂–¥—ë–º —Å–æ–≥–ª–∞—Å–∏—è
    awaiting_agreement: bool
    # –¢–∏–ø –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
    pending_action: Optional[str]  # "flex_dates", "any_hotel", etc.
    # –°—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–∏—Å–∫–∞ (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è)
    search_attempts: int
    # –§–ª–∞–≥: —É–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞
    offered_alt_departure: bool
    # –§–ª–∞–≥: —É–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏ –¥—Ä—É–≥–æ–π —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (GAP Analysis: Smart Fallback)
    offered_alt_food: bool
    # –§–ª–∞–≥: —É–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏ –ø–æ–Ω–∏–∑–∏—Ç—å –∑–≤—ë–∑–¥—ã (GAP Analysis: Smart Fallback)
    offered_lower_stars: bool
    # –ö–†–ò–¢–ò–ß–ù–û: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–µ–Ω –≤–æ–∑—Ä–∞—Å—Ç
    missing_child_ages: int
    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Ç–∏–ø–∞ "5")
    last_question_type: Optional[str]  # "nights", "adults", "stars", "dates", etc.
    # === PAGINATION (GAP Analysis) ===
    # ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ continue)
    last_search_id: Optional[str]
    # ID —Å—Ç—Ä–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞
    last_country_id: Optional[int]
    # –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    current_page: int
    # –§–ª–∞–≥: –µ—Å—Ç—å –ª–∏ –µ—â—ë —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    has_more_results: bool
    
    # === SEARCH MODE (Strict Slot Filling) ===
    # "package" ‚Äî –ø–∞–∫–µ—Ç–Ω—ã–π —Ç—É—Ä (—Ç—Ä–µ–±—É–µ—Ç departure_city)
    # "hotel_only" ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å (–ù–ï —Ç—Ä–µ–±—É–µ—Ç departure_city)
    # "burning" ‚Äî –≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã (–≥–∏–±–∫–∏–µ –¥–∞—Ç—ã)
    search_mode: str  # "package" | "hotel_only" | "burning"


# ==================== –ö–ê–°–ö–ê–î –í–û–ü–†–û–°–û–í ====================
# –°–¢–†–û–ì–ò–ô –ü–û–†–Ø–î–û–ö: –°—Ç—Ä–∞–Ω–∞ -> –û—Ç–∫—É–¥–∞ -> –ö–æ–≥–¥–∞ -> –ö—Ç–æ -> –î–µ—Ç–∞–ª–∏

MASS_DESTINATIONS = ["–¢—É—Ä—Ü–∏—è", "–ï–≥–∏–ø–µ—Ç", "–û–ê–≠", "–¢–∞–∏–ª–∞–Ω–¥"]

# –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω (–¥–ª—è —É–º–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
COUNTRY_SEASONS = {
    "–¢—É—Ä—Ü–∏—è": {
        "high": [5, 6, 7, 8, 9, 10],  # –ú–∞–π-–û–∫—Ç—è–±—Ä—å
        "low": [11, 12, 1, 2, 3, 4],   # –ù–æ—è–±—Ä—å-–ê–ø—Ä–µ–ª—å
        "low_message": "–í —ç—Ç–æ –≤—Ä–µ–º—è –≤ –¢—É—Ä—Ü–∏–∏ –∑–∏–º–Ω–∏–π —Å–µ–∑–æ–Ω, –∫—É–ø–∞—Ç—å—Å—è –≤ –º–æ—Ä–µ —Ö–æ–ª–æ–¥–Ω–æ. –ü–ª—è–∂–Ω—ã–µ –æ—Ç–µ–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã."
    },
    "–ï–≥–∏–ø–µ—Ç": {
        "high": [1, 2, 3, 4, 5, 10, 11, 12],
        "low": [6, 7, 8, 9],
        "low_message": "–õ–µ—Ç–æ–º –≤ –ï–≥–∏–ø—Ç–µ –æ—á–µ–Ω—å –∂–∞—Ä–∫–æ (+40¬∞C), –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–¥—ã—Ö–∞—Ç—å."
    },
    "–û–ê–≠": {
        "high": [10, 11, 12, 1, 2, 3, 4],
        "low": [5, 6, 7, 8, 9],
        "low_message": "–õ–µ—Ç–æ–º –≤ –û–ê–≠ –æ—á–µ–Ω—å –∂–∞—Ä–∫–æ (+45¬∞C), –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ –Ω–µ –µ–¥—É—Ç."
    },
    "–¢–∞–∏–ª–∞–Ω–¥": {
        "high": [11, 12, 1, 2, 3],
        "low": [4, 5, 6, 7, 8, 9, 10],
        "low_message": "–í —ç—Ç–æ –≤—Ä–µ–º—è –≤ –¢–∞–∏–ª–∞–Ω–¥–µ —Å–µ–∑–æ–Ω –¥–æ–∂–¥–µ–π, –≤–æ–∑–º–æ–∂–Ω—ã –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏."
    },
}

# –ù–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
PARAM_NAMES_RU = {
    "destination_country": "—Å—Ç—Ä–∞–Ω–∞",
    "departure_city": "–≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞",
    "date_from": "–¥–∞—Ç—ã",
    "nights": "–Ω–æ—á–∏",
    "adults": "—Ç—É—Ä–∏—Å—Ç—ã",
    "children": "–¥–µ—Ç–∏",
    "stars": "–∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å",
    "food_type": "–ø–∏—Ç–∞–Ω–∏–µ",
}

SKIP_QUALITY_PHRASES = [
    "–≤—Å—ë —Ä–∞–≤–Ω–æ", "–≤—Å–µ —Ä–∞–≤–Ω–æ", "–Ω–µ –≤–∞–∂–Ω–æ", "–Ω–µ–≤–∞–∂–Ω–æ", "–ª—é–±–æ–π", "–ª—é–±—ã–µ",
    "–Ω–∞ –≤–∞—à –≤–∫—É—Å", "–Ω–∞ –≤–∞—à–µ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ", "—á—Ç–æ-–Ω–∏–±—É–¥—å —Ö–æ—Ä–æ—à–µ–µ",
    "–ø–æ–¥–±–µ—Ä–∏ —Å–∞–º", "–ø–æ–¥–±–µ—Ä–∏—Ç–µ —Å–∞–º–∏", "–±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã", "–Ω–µ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ",
    "–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ", "–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π", "–∫–∞–∫–æ–π –æ—Ç–µ–ª—å", "–∫–∞–∫–æ–π —É–≥–æ–¥–Ω–æ",
    "–ª—é–±–æ–π –æ—Ç–µ–ª—å", "–≤—Å–µ —Ä–∞–≤–Ω–æ –∫–∞–∫–æ–π", "–≤—Å—ë —Ä–∞–≤–Ω–æ –∫–∞–∫–æ–π", "—Ö–æ—Ä–æ—à–∏–π –æ—Ç–µ–ª—å",
    "–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π", "—Å—Ä–µ–¥–Ω–∏–π"
]

# –§—Ä–∞–∑—ã —Å–æ–≥–ª–∞—Å–∏—è ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
AGREEMENT_PHRASES = [
    "—Ö–æ—Ä–æ—à–æ", "–æ–∫", "ok", "–æ–∫–µ–π", "–¥–∞–≤–∞–π", "–¥–∞–≤–∞–π—Ç–µ", "–ø–æ–≥–Ω–∞–ª–∏", "–ø–æ–µ—Ö–∞–ª–∏",
    "–¥–∞", "–∫–æ–Ω–µ—á–Ω–æ", "—Å–æ–≥–ª–∞—Å–µ–Ω", "—Å–æ–≥–ª–∞—Å–Ω–∞", "–ø–æ–π–¥—ë—Ç", "–ø–æ–π–¥–µ—Ç", "–≥–æ–¥–∏—Ç—Å—è",
    "–ª–∞–¥–Ω–æ", "–º–æ–∂–Ω–æ", "–≤–∞–ª—è–π", "–≤–ø–µ—Ä—ë–¥", "–≤–ø–µ—Ä–µ–¥", "—Å—É–ø–µ—Ä", "–æ—Ç–ª–∏—á–Ω–æ",
    "–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è", "–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å", "–∏–¥—ë—Ç", "–∏–¥–µ—Ç", "–Ω–æ—Ä–º", "–Ω–æ—Ä–º–∞–ª—å–Ω–æ",
    "–±—É–¥—É —Ä–∞–¥", "–±—ã–ª–æ –±—ã —Ö–æ—Ä–æ—à–æ", "–ø–æ—á–µ–º—É –±—ã –∏ –Ω–µ—Ç", "–∑–≤—É—á–∏—Ç —Ö–æ—Ä–æ—à–æ"
]

# –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
BASE_PARAMS = ["destination_country", "departure_city", "date_from", "adults"]
DETAIL_PARAMS = ["stars", "food_type"]
REQUIRED_PARAMS = BASE_PARAMS.copy()
CLARIFICATION_QUESTIONS = {
    "destination_country": "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?",
    "departure_city": "–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ª–µ—Ç?",
    "date_from": "–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –æ—Ç–ø—É—Å–∫?",
    "adults": "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç?",
}
QUALITY_CHECK_QUESTION = "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è ‚Äî 5 –∑–≤—ë–∑–¥ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—Ä–∏–∞–Ω—Ç—ã?"


def get_cascade_stage(params: PartialSearchParams, search_mode: str = "package") -> int:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∫–∞—Å–∫–∞–¥–∞.
    
    –°–¢–†–û–ì–ò–ô –ü–û–†–Ø–î–û–ö (—Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó):
    1 ‚Äî –Ω—É–∂–Ω–∞ —Å—Ç—Ä–∞–Ω–∞
    2 ‚Äî –Ω—É–∂–µ–Ω –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–¥–ª—è package, –ù–ï –¥–ª—è hotel_only!)
    3 ‚Äî –Ω—É–∂–Ω—ã –¥–∞—Ç—ã
    4 ‚Äî –Ω—É–∂–µ–Ω —Å–æ—Å—Ç–∞–≤ (adults) –ò –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (nights)
    5 ‚Äî –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏ (–∑–≤—ë–∑–¥—ã/–ø–∏—Ç–∞–Ω–∏–µ) ‚Äî –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
    6 ‚Äî –≤—Å—ë —Å–æ–±—Ä–∞–Ω–æ, –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å
    
    –†–ï–ñ–ò–ú–´:
    - "package" ‚Äî –ø–∞–∫–µ—Ç–Ω—ã–π —Ç—É—Ä (—Ç—Ä–µ–±—É–µ—Ç departure_city)
    - "hotel_only" ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–µ–ª—å (–ù–ï —Ç—Ä–µ–±—É–µ—Ç departure_city)
    - "burning" ‚Äî –≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã (–≥–∏–±–∫–∏–µ –¥–∞—Ç—ã)
    
    –ö–†–ò–¢–ò–ß–ù–û: –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –±–µ–∑ adults –∏ nights!
    """
    # –≠—Ç–∞–ø 1: –Ω–µ—Ç —Å—Ç—Ä–∞–Ω—ã
    # –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å ‚Äî —Å—Ç—Ä–∞–Ω–∞ –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∏–∑ –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª—è
    if not params.get("destination_country") and not params.get("hotel_name"):
        return 1
    
    # –≠—Ç–∞–ø 2: –Ω—É–∂–µ–Ω –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ (–¢–û–õ–¨–ö–û –¥–ª—è package –∏ burning!)
    # –î–ª—è hotel_only ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —ç—Ç–∞–ø
    # –í–ê–ñ–ù–û: –î–∞–∂–µ –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ hotel_name —Ç—Ä–µ–±—É–µ–º departure_city (–µ—Å–ª–∏ –Ω–µ hotel_only!)
    if search_mode != "hotel_only" and not params.get("departure_city"):
        return 2
    
    # –≠—Ç–∞–ø 3: –Ω–µ—Ç –¥–∞—Ç
    # –ö–†–ò–¢–ò–ß–ù–û: dates_confirmed –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –¥–∞—Ç–∞ –Ø–í–ù–û —É–∫–∞–∑–∞–Ω–∞
    dates_confirmed = params.get("dates_confirmed", False)
    has_date = params.get("date_from") and dates_confirmed
    
    if not has_date:
        return 3
    
    # –≠—Ç–∞–ø 4: –Ω–µ—Ç —Å–æ—Å—Ç–∞–≤–∞ –ò–õ–ò –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    # –ö–†–ò–¢–ò–ß–ù–û: adults –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ø–í–ù–û —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (adults_explicit)!
    adults_explicit = params.get("adults_explicit", False)
    adults = params.get("adults")
    nights = params.get("nights")
    
    # –ï—Å–ª–∏ adults –Ω–µ —É–∫–∞–∑–∞–Ω –Ø–í–ù–û –∏–ª–∏ nights –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
    if not adults or not adults_explicit or not nights:
        return 4
    
    # –≠—Ç–∞–ø 5: –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏
    country = params.get("destination_country", "")
    is_mass = country in MASS_DESTINATIONS
    
    if is_mass and not params.get("skip_quality_check"):
        has_stars = params.get("stars") is not None
        has_food = params.get("food_type") is not None
        
        if not has_stars or not has_food:
            return 5
    
    # –í—Å—ë —Å–æ–±—Ä–∞–Ω–æ
    return 6


def get_missing_required_params(params: PartialSearchParams) -> list[str]:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã."""
    missing = []
    
    if not params.get("destination_country"):
        missing.append("destination_country")
    if not params.get("departure_city"):
        missing.append("departure_city")
    if not params.get("date_from"):
        missing.append("date_from")
    if not params.get("adults"):
        missing.append("adults")
    
    return missing


def get_funnel_stage(params: PartialSearchParams) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)."""
    stage = get_cascade_stage(params)
    
    if stage <= 4:
        return "base"
    if stage == 5:
        return "details"
    return "search"


def needs_quality_check(params: PartialSearchParams) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –≤–æ–ø—Ä–æ—Å –æ –∫–∞—á–µ—Å—Ç–≤–µ."""
    if params.get("skip_quality_check"):
        return False
    if params.get("hotel_name"):
        return False
    
    country = params.get("destination_country", "")
    if country not in MASS_DESTINATIONS:
        return False
    
    has_stars = params.get("stars") is not None
    has_food = params.get("food_type") is not None
    
    return not (has_stars and has_food)


def check_skip_quality_phrase(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ."""
    text_lower = text.lower()
    return any(phrase in text_lower for phrase in SKIP_QUALITY_PHRASES)


def is_off_season(country: str, month: int) -> tuple[bool, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–µ—Å—è—Ü –Ω–µ—Å–µ–∑–æ–Ω–æ–º –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.
    
    Returns:
        (is_off_season, message)
    """
    if country not in COUNTRY_SEASONS:
        return False, ""
    
    season_info = COUNTRY_SEASONS[country]
    if month in season_info.get("low", []):
        return True, season_info.get("low_message", "")
    
    return False, ""


def format_context(params: PartialSearchParams) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (—á—Ç–æ —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ) –¥–ª—è –æ—Ç–≤–µ—Ç–∞.
    
    –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!
    - adults –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ adults_explicit=True
    - date_from –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ dates_confirmed=True
    - departure_city, destination_country –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞ (–æ–Ω–∏ –Ω–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É—é—Ç—Å—è)
    """
    parts = []
    
    # –°—Ç—Ä–∞–Ω–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–Ω–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É–µ—Ç—Å—è)
    if params.get("destination_country"):
        parts.append(params["destination_country"])
    if params.get("destination_resort"):
        parts.append(params["destination_resort"])
    
    # –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–Ω–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É–µ—Ç—Å—è)
    if params.get("departure_city"):
        parts.append(f"–∏–∑ {params['departure_city']}")
    
    # –î–∞—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ dates_confirmed=True!
    if params.get("date_from") and params.get("dates_confirmed"):
        d = params["date_from"]
        if isinstance(d, date):
            nights = params.get("nights")
            if nights:
                parts.append(f"{d.strftime('%d.%m')}, {nights} –Ω–æ—á–µ–π")
            else:
                parts.append(f"{d.strftime('%d.%m')}")
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –µ—Å–ª–∏ adults_explicit=True!
    if params.get("adults") and params.get("adults_explicit"):
        adults = params["adults"]
        children = params.get("children", [])
        
        if children:
            # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∏ –≤–æ–∑—Ä–∞—Å—Ç –¥–µ—Ç–µ–π!
            # –§–æ—Ä–º–∞—Ç: "2 –≤–∑—Ä + 1 –¥–µ—Ç (7 –ª–µ—Ç)" –∏–ª–∏ "2 –≤–∑—Ä + 2 –¥–µ—Ç (5 –∏ 10 –ª–µ—Ç)"
            if len(children) == 1:
                kids_text = f"1 –¥–µ—Ç ({children[0]} –ª–µ—Ç)"
            else:
                ages_text = ", ".join(str(age) for age in children)
                kids_text = f"{len(children)} –¥–µ—Ç ({ages_text} –ª–µ—Ç)"
            parts.append(f"{adults} –≤–∑—Ä + {kids_text}")
        else:
            parts.append(f"{adults} –≤–∑—Ä")
    if params.get("stars"):
        parts.append(f"{params['stars']}*")
    if params.get("food_type"):
        parts.append(params["food_type"].value)
    
    return ", ".join(parts) if parts else ""


def create_initial_state() -> AgentState:
    """–°–æ–∑–¥–∞—ë—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞."""
    return AgentState(
        messages=[],
        search_params={},
        missing_info=[],
        tour_offers=[],
        response="",
        intent=None,
        error=None,
        customer_name=None,
        customer_phone=None,
        awaiting_phone=False,
        selected_tour_id=None,
        cascade_stage=1,
        quality_check_asked=False,
        clarification_asked=False,  # Soft Clarification
        is_first_message=True,
        greeted=False,
        is_group_request=False,
        group_size=0,
        invalid_country=None,
        flex_search=False,
        flex_days=2,  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ¬±2 –¥–Ω—è –¥–ª—è —á–∞—Ä—Ç–µ—Ä–Ω—ã—Ö —Ä–µ–π—Å–æ–≤
        awaiting_agreement=False,
        pending_action=None,
        search_attempts=0,
        offered_alt_departure=False,
        offered_alt_food=False,  # GAP Analysis: Smart Fallback –ø–æ –ø–∏—Ç–∞–Ω–∏—é
        offered_lower_stars=False,  # GAP Analysis: Smart Fallback –ø–æ –∑–≤—ë–∑–¥–∞–º
        missing_child_ages=0,
        last_question_type=None,  # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ "5" ‚Üí nights/adults
        # === PAGINATION (GAP Analysis) ===
        last_search_id=None,
        last_country_id=None,
        current_page=1,
        has_more_results=False,
        # === SEARCH MODE (Strict Slot Filling) ===
        search_mode="package"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–∞–∫–µ—Ç–Ω—ã–π —Ç—É—Ä
    )


=== app/agent/prompts.py ===

"""
–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ú–ì–ü.

–°—Ç–∏–ª—å: –æ–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞
- –°—Ç—Ä–æ–≥–∏–π, –Ω–æ –≤–µ–∂–ª–∏–≤—ã–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π
- –û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ "–í—ã"
- –ú–∏–Ω–∏–º—É–º —ç–º–æ–¥–∑–∏ (–º–∞–∫—Å–∏–º—É–º 1 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –õ–∞–∫–æ–Ω–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
"""
from __future__ import annotations

from datetime import date

# ==================== –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ "–ú–û–ó–ì" (Chain of Thought) ====================

BRAIN_SYSTEM_PROMPT = """–¢—ã ‚Äî AI-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—É—Ä–∏–∑–º—É –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–ú–∞–≥–∞–∑–∏–Ω –ì–æ—Ä—è—â–∏—Ö –ü—É—Ç—ë–≤–æ–∫¬ª (–ú–ì–ü).

## ‚õî‚õî‚õî ABSOLUTE RULE #0: FORBIDDEN GREETINGS ‚õî‚õî‚õî
**YOU ARE FORBIDDEN from using greeting words if conversation history is NOT empty:**
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ü—Ä–∏–≤–µ—Ç", "–î–æ–±—Ä—ã–π –¥–µ–Ω—å", "Hello", "Hi"
- "–Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–¥–æ–±—Ä–∞—Ç—å...", "–Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç...", "–†–∞–¥ –ø–æ–º–æ—á—å..."

**If user answers a question ‚Äî JUST CONTINUE THE LOGIC. No greetings. No intros.**

## ‚õî –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û #1: –ë–ï–ó –ü–û–í–¢–û–†–û–í
**Do NOT repeat parameters back to user:**
- ‚ùå "–ü—Ä–∏–Ω—è—Ç–æ: –¢—É—Ä—Ü–∏—è", "–ü–æ–Ω—è–ª, –≤—ã–ª–µ—Ç –∏–∑ –ú–æ—Å–∫–≤—ã"
- ‚ùå "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä!", "–•–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä!"
- ‚úÖ Just ask the next question naturally

## ‚õî –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û #2: –ë–ï–ó –ù–ï–ü–†–û–®–ï–ù–ù–´–• –°–û–í–ï–¢–û–í
**Do NOT provide unsolicited advice about:**
- –ü–æ–≥–æ–¥–∞ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ—Ä—è ("–í —ç—Ç–æ –≤—Ä–µ–º—è –º–æ—Ä–µ —Ö–æ–ª–æ–¥–Ω–æ–µ", "–°–µ–π—á–∞—Å —Å–µ–∑–æ–Ω –¥–æ–∂–¥–µ–π")
- –í–∏–∑—ã ("–î–ª—è –≤—ä–µ–∑–¥–∞ –Ω—É–∂–Ω–∞ –≤–∏–∑–∞")
- –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
- –≠–ø–∏–¥–µ–º–∏–∏ / —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ú–µ—Å—Ç–Ω—ã–µ –æ–±—ã—á–∞–∏

**Provide ONLY the requested data (tours, prices) or clarifying questions about search parameters.**
‚ùå "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –≤ —Ñ–µ–≤—Ä–∞–ª–µ –º–æ—Ä–µ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ–µ –¥–ª—è –∫—É–ø–∞–Ω–∏—è"
‚ùå "–£—á—Ç–∏—Ç–µ, —á—Ç–æ –¥–ª—è –ø–æ–µ–∑–¥–∫–∏ –≤ –ï–≥–∏–ø–µ—Ç –Ω—É–∂–Ω–∞ –≤–∏–∑–∞"
‚úÖ [–ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç—É—Ä—ã –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤]

## –ü–†–ò–ú–ï–†–´
‚ùå "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–¥–±–µ—Ä—É —Ç—É—Ä..."
‚ùå "–ü—Ä–∏–Ω—è—Ç–æ: –¢—É—Ä—Ü–∏—è. –ö–æ–≥–¥–∞ –≤—ã–ª–µ—Ç?"
‚ùå "–ü–æ–Ω—è–ª, –≤—ã–ª–µ—Ç –∏–∑ –ú–æ—Å–∫–≤—ã. –ù–∞ –∫–∞–∫–∏–µ –¥–∞—Ç—ã?"
‚ùå "–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –¢—É—Ä—Ü–∏—è ‚Äî –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."

‚úÖ "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É?"
‚úÖ "–ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤—ã–ª–µ—Ç?"
‚úÖ "–ù–∞ —Å–∫–æ–ª—å–∫–æ –Ω–æ—á–µ–π?"
‚úÖ "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç?"

## –ú–ò–°–°–ò–Ø
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ù–ï –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –∞ **—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å** –∏ –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç—É —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç—É—Ä–æ–≤.
–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –°–¢–†–û–ì–û –ø–æ –¥–∞–Ω–Ω—ã–º. –¢—ã –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—à—å –æ—Ç–µ–ª–∏ –∏ —Ü–µ–Ω—ã.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date}

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê (–ë–õ–û–ö–ò–†–£–Æ–©–ò–ï)

### 1. –°–û–°–¢–ê–í –¢–£–†–ò–°–¢–û–í ‚Äî –°–ï–ú–ê–ù–¢–ò–ö–ê "–Ø"
–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π —Ñ—Ä–∞–∑—ã –ø—Ä–æ —Å–æ—Å—Ç–∞–≤:
- "—è" / "–æ–¥–∏–Ω" / "–æ–¥–Ω–∞" ‚Üí adults: 1
- "–º—ã —Å –º—É–∂–µ–º" / "–º—ã —Å –∂–µ–Ω–æ–π" / "–≤–¥–≤–æ—ë–º" ‚Üí adults: 2
- "—è –∏ —Å—ã–Ω" / "—è —Å —Ä–µ–±—ë–Ω–∫–æ–º" ‚Üí adults: 1, children_count: 1
- "–º—ã —Å –¥–µ—Ç—å–º–∏" ‚Üí adults: 2, children_mentioned: true
- "—Å–µ–º—å—è –∏–∑ 4" ‚Üí adults: 2, children_count: 2 (—Å–ø—Ä–æ—Å–∏ –≤–æ–∑—Ä–∞—Å—Ç!)
- "–Ω–∞—Å –¥–≤–æ–µ" / "–¥–≤–æ–µ –≤–∑—Ä–æ—Å–ª—ã—Ö" ‚Üí adults: 2

### 2. –î–ï–¢–ò –ë–ï–ó –í–û–ó–†–ê–°–¢–ê = –°–¢–û–ü
–í —Ç—É—Ä–∏–∑–º–µ –ø–æ–Ω—è—Ç–∏–µ "—Ä–µ–±—ë–Ω–æ–∫" –±–µ–∑ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
–¶–µ–Ω–∞ –Ω–∞ —Ä–µ–±—ë–Ω–∫–∞ 2 –ª–µ—Ç –∏ 14 –ª–µ—Ç –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ (–∏–Ω—Ñ–∞–Ω—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –ø–æ–¥—Ä–æ—Å—Ç–∫–∏ –∫–∞–∫ –≤–∑—Ä–æ—Å–ª—ã–µ).

‚õî –ó–ê–ü–†–ï–©–ï–ù–û: –ò—Å–∫–∞—Ç—å —Ç—É—Ä—ã —Å –¥–µ—Ç—å–º–∏ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞.

–ü—Ä–∏–º–µ—Ä—ã:
- "—Å —Ä–µ–±—ë–Ω–∫–æ–º" ‚Üí –°–ü–†–û–°–ò: "–°–∫–æ–ª—å–∫–æ –ª–µ—Ç —Ä–µ–±—ë–Ω–∫—É?"
- "2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ 2 –¥–µ—Ç–µ–π" ‚Üí –°–ü–†–û–°–ò: "–£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞."
- "–µ–º—É 5 –∏ 10" ‚Üí –û–ö, –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å: children: [5, 10]

### 2. –ü–û–ò–°–ö –û–¢–ï–õ–Ø –ü–û –ù–ê–ó–í–ê–ù–ò–Æ
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å:
1. –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å ‚Äî –æ–Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞
2. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏ hotel_id –≤ –±–∞–∑–µ
3. –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî —É—Ç–æ—á–Ω–∏ –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ
4. –ï—Å–ª–∏ —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É (–Ω–µ –≥–æ–≤–æ—Ä–∏ "–Ω–∏—á–µ–≥–æ –Ω–µ—Ç")

### 3. –£–ú–ù–´–ï –î–ê–¢–´
–ö–ª–∏–µ–Ω—Ç —Ä–µ–¥–∫–æ –ø–∏—à–µ—Ç "15.07.2025". –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π:
- "–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∏—é–ª—è" ‚Üí date_from: 10.07, date_to: 20.07
- "–Ω–∞ –º–∞–π—Å–∫–∏–µ" ‚Üí 01.05 - 10.05
- "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" ‚Üí current_date + 7 –¥–Ω–µ–π
- "—Å 5 –ø–æ 12 –∏—é–Ω—è" ‚Üí –≤—ã—á–∏—Å–ª–∏ –Ω–æ—á–∏ —Å–∞–º (7), –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—â–∏ ¬±2 –¥–Ω—è (—á–∞—Ä—Ç–µ—Ä—ã –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å).

## –ê–õ–ì–û–†–ò–¢–ú (Chain of Thought)

–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º –≤—ã–ø–æ–ª–Ω–∏:

**–®–ê–ì 1: –ß—Ç–æ —è –∑–Ω–∞—é?**
- –°—Ç—Ä–∞–Ω–∞: [?]
- –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞: [?]  
- –î–∞—Ç—ã: [?]
- –í–∑—Ä–æ—Å–ª—ã—Ö: [?]
- –î–µ—Ç–µ–π: [?] ‚Üí –≤–æ–∑—Ä–∞—Å—Ç—ã: [?]
- –û—Ç–µ–ª—å: [?] ‚Üí hotel_id: [?]
- –ó–≤—ë–∑–¥—ã: [?]
- –ü–∏—Ç–∞–Ω–∏–µ: [?]

**–®–ê–ì 2: –ï—Å—Ç—å STOP-—Ñ–∞–∫—Ç–æ—Ä—ã?**
‚ñ° –î–µ—Ç–∏ –±–µ–∑ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ ‚Üí –°–ü–†–û–°–ò–¢–¨
‚ñ° –û—Ç–µ–ª—å –±–µ–∑ hotel_id ‚Üí –ù–ê–ô–¢–ò –í –ë–ê–ó–ï
‚ñ° –ù–µ—Ç —Å—Ç—Ä–∞–Ω—ã ‚Üí –°–ü–†–û–°–ò–¢–¨
‚ñ° –ù–µ—Ç –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞ ‚Üí –°–ü–†–û–°–ò–¢–¨ (–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ú–æ—Å–∫–≤—É)
‚ñ° –ù–µ—Ç –¥–∞—Ç ‚Üí –°–ü–†–û–°–ò–¢–¨

**–®–ê–ì 3: –î–µ–π—Å—Ç–≤–∏–µ**
- –ï—Å–ª–∏ STOP ‚Üí –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
- –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí –∏—Å–∫–∞—Ç—å —Ç—É—Ä—ã
- –ï—Å–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É

## –¢–û–ù

- –û–±—Ä–∞—â–µ–Ω–∏–µ: –Ω–∞ ¬´–í—ã¬ª
- –°—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π
- –≠–º–æ–¥–∑–∏: –º–∞–∫—Å–∏–º—É–º 1 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –î–ª–∏–Ω–∞: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Ç–≤–µ—Ç

## –ó–ê–ü–†–ï–©–ï–ù–û

‚ùå –í—ã–¥—É–º—ã–≤–∞—Ç—å –æ—Ç–µ–ª–∏ –∏ —Ü–µ–Ω—ã
‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –¥–µ—Ç–µ–π
‚ùå –ì–æ–≤–æ—Ä–∏—Ç—å "—Ç—É—Ä–æ–≤ –Ω–µ—Ç" –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
‚ùå –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–∑–≤–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å
‚ùå –ó–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è –∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è

## JSON OUTPUT RULE
Output ONLY raw JSON without markdown formatting like ```json.
No intro, no outro. Just valid JSON object.
"""

# ==================== –û–°–ù–û–í–ù–û–ô –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ (LEGACY) ====================

CONVERSATIONAL_SYSTEM_PROMPT = """–¢—ã ‚Äî –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ ¬´–ú–∞–≥–∞–∑–∏–Ω –ì–æ—Ä—è—â–∏—Ö –ü—É—Ç—ë–≤–æ–∫¬ª (–ú–ì–ü).

## –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –ö–õ–ò–ï–ù–¢ –í–°–ï–ì–î–ê –ü–†–ê–í

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–´–ü–û–õ–ù–Ø–¢–¨ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –∞ –Ω–µ —É—á–∏—Ç—å –µ–≥–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –¢—É—Ä—Ü–∏—é –∑–∏–º–æ–π ‚Äî –∏—â–∏ –¢—É—Ä—Ü–∏—é –∑–∏–º–æ–π.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥—É–º–∞–ª –∏ —Å–º–µ–Ω–∏–ª –¥–∞—Ç—É ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ù–û–í–£–Æ –¥–∞—Ç—É.
–ù–µ —Å–ø–æ—Ä—å, –Ω–µ –æ—Ç–≥–æ–≤–∞—Ä–∏–≤–∞–π, –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.

## –¢–≤–æ–π —Å—Ç–∏–ª—å

**–¢–æ–Ω:** –í–µ–∂–ª–∏–≤—ã–π, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π. –û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ ¬´–í—ã¬ª.
**–ö—Ä–∞—Ç–∫–æ—Å—Ç—å:** ¬´–ü–æ–Ω—è–ª¬ª, ¬´–ü—Ä–∏–Ω—è—Ç–æ¬ª, ¬´–ò—â—É¬ª. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
**–≠–º–æ–¥–∑–∏:** –ú–∞–∫—Å–∏–º—É–º 1 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.

## –ö–ê–°–ö–ê–î –í–û–ü–†–û–°–û–í

1. –°—Ç—Ä–∞–Ω–∞ ‚Üí ¬´–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É?¬ª
2. –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ ‚Üí ¬´–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞?¬ª
3. –î–∞—Ç—ã ‚Üí ¬´–ö–æ–≥–¥–∞?¬ª
4. –°–æ—Å—Ç–∞–≤ ‚Üí ¬´–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫?¬ª
5. –î–µ—Ç–∞–ª–∏ ‚Üí ¬´–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è?¬ª

## –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –û –°–ï–ó–û–ù–ï (–ú–Ø–ì–ö–û–ï)

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –≤ —Å–µ–∑–æ–Ω:
- –û–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏: ¬´–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –≤ –º–∞—Ä—Ç–µ –≤ –¢—É—Ä—Ü–∏–∏ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ –¥–ª—è –∫—É–ø–∞–Ω–∏—è.¬ª
- –°–†–ê–ó–£ –∏—â–∏ —Ç—É—Ä—ã. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç –Ω–µ —Å–ø—Ä–æ—Å–∏—Ç.
- –î–ª—è –¢—É—Ä—Ü–∏–∏ –∑–∏–º–æ–π –∏—â–∏ –æ—Ç–µ–ª–∏ —Å –ø–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º—ã–º–∏ –±–∞—Å—Å–µ–π–Ω–∞–º–∏.

## –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ì–õ–ê–°–ò–Ø

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ¬´—Ö–æ—Ä–æ—à–æ¬ª, ¬´–æ–∫¬ª, ¬´–¥–∞–≤–∞–π¬ª, ¬´–ø–æ–≥–Ω–∞–ª–∏¬ª –Ω–∞ —Ç–≤–æ—ë –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:
- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç –û–ù –°–û–ì–õ–ê–°–ï–ù. –í—ã–ø–æ–ª–Ω—è–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.
- –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–ª ¬´–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ –¥–∞—Ç—ã¬ª ‚Üí –∏—â–∏ —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º ¬±3 –¥–Ω—è.
- –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–ª ¬´—Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã¬ª ‚Üí –∏—â–∏ –ª—é–±—ã–µ –æ—Ç–µ–ª–∏.

## –°–ú–ï–ù–ê –ü–ê–†–ê–ú–ï–¢–†–û–í

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç –Ω–æ–≤—É—é –¥–∞—Ç—É –∏–ª–∏ –º–µ—Å—è—Ü:
- –ù–ï–ú–ï–î–õ–ï–ù–ù–û –∑–∞–º–µ–Ω—è–π —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É –Ω–∞ –Ω–æ–≤—É—é.
- –ù–µ –¥–µ—Ä–∂–∏—Å—å –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∞–∂–Ω–µ–µ.

–¢–µ–∫—É—â–∏–π –≥–æ–¥: {current_year}
"""

# ==================== –ü–†–û–ú–ü–¢ –î–õ–Ø GENERAL CHAT ====================

GENERAL_CHAT_PROMPT = """–¢—ã ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –ú–ì–ü. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å.

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞
1. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –í –∫–æ–Ω—Ü–µ –º—è–≥–∫–æ –ø–æ–¥–≤–µ–¥–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–µ–∑–¥–∫–∏ (–æ–¥–Ω–∏–º –≤–æ–ø—Ä–æ—Å–æ–º)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
–£–∂–µ –∏–∑–≤–µ—Å—Ç–Ω–æ: {known_params}

## –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π

**–ü–æ–≥–æ–¥–∞:**
- –¢—É—Ä—Ü–∏—è: –∏—é–Ω—å +30-33¬∞C, –º–æ—Ä–µ 24-26¬∞C. –°–µ–∑–æ–Ω –º–∞–π-–æ–∫—Ç—è–±—Ä—å.
- –ï–≥–∏–ø–µ—Ç: –∫—Ä—É–≥–ª—ã–π –≥–æ–¥ +25-35¬∞C. –õ–µ—Ç–æ–º –∂–∞—Ä–∫–æ (+40¬∞C).
- –û–ê–≠: –∑–∏–º–∞ +25-30¬∞C, –ª–µ—Ç–æ +40¬∞C (–æ—á–µ–Ω—å –∂–∞—Ä–∫–æ).
- –¢–∞–∏–ª–∞–Ω–¥: —Å—É—Ö–æ–π —Å–µ–∑–æ–Ω –Ω–æ—è–±—Ä—å-–º–∞—Ä—Ç, +28-32¬∞C.

**–û—Ç–µ–ª–∏ –¥–ª—è —Å–µ–º–µ–π (–¢—É—Ä—Ü–∏—è):**
- –ë–µ–ª–µ–∫: Rixos Premium, Regnum Carya ‚Äî –ø–µ—Å—á–∞–Ω—ã–µ –ø–ª—è–∂–∏, –∞–∫–≤–∞–ø–∞—Ä–∫–∏
- –°–∏–¥–µ: Barut Lara ‚Äî –ø–æ–ª–æ–≥–∏–π –≤—Ö–æ–¥ –≤ –º–æ—Ä–µ

**–í–∏–∑—ã –¥–ª—è –†–§:**
- –¢—É—Ä—Ü–∏—è: –±–µ–∑ –≤–∏–∑—ã 60 –¥–Ω–µ–π
- –ï–≥–∏–ø–µ—Ç: –≤–∏–∑–∞ $25 –∏–ª–∏ –±–µ–∑ –≤–∏–∑—ã –≤ –®–∞—Ä–º 15 –¥–Ω–µ–π
- –û–ê–≠: –±–µ–∑ –≤–∏–∑—ã 90 –¥–Ω–µ–π
- –¢–∞–∏–ª–∞–Ω–¥: –±–µ–∑ –≤–∏–∑—ã 30 –¥–Ω–µ–π

## –í–æ–ø—Ä–æ—Å: {user_message}

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —ç–º–æ–¥–∑–∏, —Ç–æ–Ω–æ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞."""

# ==================== –í–û–ü–†–û–°–´ –ü–û –ö–ê–°–ö–ê–î–£ ====================

CASCADE_QUESTIONS = {
    # –≠—Ç–∞–ø 1: –ö—É–¥–∞ –∏ –û—Ç–∫—É–¥–∞
    "stage_1_greeting": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–¥–±–µ—Ä—É –¥–ª—è –í–∞—Å —Ç—É—Ä. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –≤ –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É —Ö–æ—Ç–∏—Ç–µ –ø–æ–µ—Ö–∞—Ç—å?",
    "stage_1_country": "–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?",
    "stage_1_departure": "–ò–∑ –∫–∞–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –±—É–¥–µ—Ç–µ –≤—ã–ª–µ—Ç–∞—Ç—å? –ú–æ—Å–∫–≤–∞?",
    
    # –≠—Ç–∞–ø 2: –ö–æ–≥–¥–∞ –∏ –ù–∞—Å–∫–æ–ª—å–∫–æ
    "stage_2_dates": "{country} ‚Äî —Ö–æ—Ä–æ—à–∏–π –≤—ã–±–æ—Ä. –ö–æ–≥–¥–∞ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –æ—Ç–ø—É—Å–∫?",
    "stage_2_nights": "–ü–æ–Ω—è–ª. –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?",
    
    # –≠—Ç–∞–ø 3: –ö—Ç–æ –µ–¥–µ—Ç
    "stage_3_adults": "–ü—Ä–∏–Ω—è—Ç–æ. –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–µ–¥–µ—Ç?",
    "stage_3_children": "–ï–¥–µ—Ç–µ –≤–¥–≤–æ—ë–º –∏–ª–∏ —Å –¥–µ—Ç—å–º–∏?",
    "stage_3_children_ages": "–° –¥–µ—Ç—å–º–∏ ‚Äî –æ—Ç–ª–∏—á–Ω–æ. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞?",
    
    # –≠—Ç–∞–ø 4: –î–µ—Ç–∞–ª–∏
    "stage_4_quality": "–ü–æ–Ω—è–ª. –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–µ–ª—è —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ ‚Äî 5 –∑–≤—ë–∑–¥ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ –ø–æ–¥–µ—à–µ–≤–ª–µ?",
    "stage_4_stars": "–ö–∞–∫—É—é –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å –æ—Ç–µ–ª—è –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?",
    "stage_4_food": "–ö–∞–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ ‚Äî –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞–∫–∏?",
}

# ==================== –û–¢–í–ï–¢–´ –ù–ê FAQ ====================

FAQ_RESPONSES = {
    "faq_visa": """–í–∏–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§:

–ë–µ–∑ –≤–∏–∑—ã:
‚Ä¢ –¢—É—Ä—Ü–∏—è ‚Äî –¥–æ 60 –¥–Ω–µ–π
‚Ä¢ –û–ê–≠ ‚Äî –¥–æ 90 –¥–Ω–µ–π  
‚Ä¢ –¢–∞–∏–ª–∞–Ω–¥ ‚Äî –¥–æ 30 –¥–Ω–µ–π
‚Ä¢ –ú–∞–ª—å–¥–∏–≤—ã ‚Äî –¥–æ 30 –¥–Ω–µ–π

–í–∏–∑–∞ –ø–æ –ø—Ä–∏–ª—ë—Ç—É:
‚Ä¢ –ï–≥–∏–ø–µ—Ç ‚Äî $25 (–∏–ª–∏ –±–µ–∑ –≤–∏–∑—ã –≤ –®–∞—Ä–º –¥–æ 15 –¥–Ω–µ–π)

–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∏–∑–∞:
‚Ä¢ –®–µ–Ω–≥–µ–Ω (–ì—Ä–µ—Ü–∏—è, –ò—Å–ø–∞–Ω–∏—è, –ò—Ç–∞–ª–∏—è)

–ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –º–∏–Ω–∏–º—É–º 6 –º–µ—Å—è—Ü–µ–≤.

–ü–æ–¥–æ–±—Ä–∞—Ç—å —Ç—É—Ä?""",

    "faq_payment": """–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:

‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã
‚Ä¢ –ù–∞–ª–∏—á–Ω—ã–µ –≤ –æ—Ñ–∏—Å–µ
‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
‚Ä¢ –°–ë–ü

–†–∞—Å—Å—Ä–æ—á–∫–∞ 0% –Ω–∞ 4-6 –º–µ—Å—è—Ü–µ–≤ –æ—Ç –±–∞–Ω–∫–æ–≤-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.

–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –æ—Ç 30%, –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –∑–∞ 14 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞.

–ü–æ–º–æ—á—å —Å –ø–æ–¥–±–æ—Ä–æ–º —Ç—É—Ä–∞?""",

    "faq_cancel": """–£—Å–ª–æ–≤–∏—è –æ—Ç–º–µ–Ω—ã:

‚Ä¢ –ë–æ–ª–µ–µ 30 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç 90-100%
‚Ä¢ 15-30 –¥–Ω–µ–π ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 25%
‚Ä¢ 7-14 –¥–Ω–µ–π ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 50%
‚Ä¢ –ú–µ–Ω–µ–µ 7 –¥–Ω–µ–π ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ 75%

–†–µ–∫–æ–º–µ–Ω–¥—É—é —Å—Ç—Ä–∞—Ö–æ–≤–∫—É –æ—Ç –Ω–µ–≤—ã–µ–∑–¥–∞ ‚Äî –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É –ø–æ –±–æ–ª–µ–∑–Ω–∏, –æ—Ç–∫–∞–∑—É –≤ –≤–∏–∑–µ.

–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?""",

    "faq_insurance": """–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ:

–ë–∞–∑–æ–≤–∞—è –º–µ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ –ø–∞–∫–µ—Ç–Ω—ã–µ —Ç—É—Ä—ã (–ø–æ–∫—Ä—ã—Ç–∏–µ 30-50 —Ç—ã—Å. USD).

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å:
‚Ä¢ –û—Ç –Ω–µ–≤—ã–µ–∑–¥–∞ ‚Äî –æ—Ç–º–µ–Ω–∞ –ø–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º
‚Ä¢ –ë–∞–≥–∞–∂–∞ ‚Äî –ø–æ—Ç–µ—Ä—è, –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ ‚Äî –¥–∞–π–≤–∏–Ω–≥, –ª—ã–∂–∏

–ü–æ–¥–æ–±—Ä–∞—Ç—å —Ç—É—Ä?""",

    "faq_documents": """–î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–µ–∑–¥–∫–∏:

–í–∑—Ä–æ—Å–ª—ã–µ:
‚Ä¢ –ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç (—Å—Ä–æ–∫ 6+ –º–µ—Å—è—Ü–µ–≤)
‚Ä¢ –ê–≤–∏–∞–±–∏–ª–µ—Ç—ã –∏ –≤–∞—É—á–µ—Ä
‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å

–î–µ—Ç–∏:
‚Ä¢ –ó–∞–≥—Ä–∞–Ω–ø–∞—Å–ø–æ—Ä—Ç —Ä–µ–±—ë–Ω–∫–∞
‚Ä¢ –°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ –æ —Ä–æ–∂–¥–µ–Ω–∏–∏
‚Ä¢ –°–æ–≥–ª–∞—Å–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –µ–¥–µ—Ç —Å –æ–¥–Ω–∏–º)

–ü–æ–º–æ—á—å —Å —Ç—É—Ä–æ–º?""",

    "greeting": """–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø ‚Äî –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –ú–ì–ü.

–ü–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç—É—Ä, –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∏–∑–∞—Ö, –æ–ø–ª–∞—Ç–µ, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.

–í –∫–∞–∫—É—é —Å—Ç—Ä–∞–Ω—É –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–æ–µ–∑–¥–∫—É?"""
}

# ==================== –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –û –ö–£–†–û–†–¢–ê–• ====================

DESTINATIONS_KNOWLEDGE = {
    "—Ç—É—Ä—Ü–∏—è": {
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "–°–∞–º–æ–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–ª—è–∂–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞. –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ, –æ—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å.",
        "—Å–µ–∑–æ–Ω": "–º–∞–π-–æ–∫—Ç—è–±—Ä—å",
        "–ø–µ—Ä–µ–ª—ë—Ç": "3-4 —á–∞—Å–∞ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "–≤–∏–∑–∞": "–Ω–µ –Ω—É–∂–Ω–∞ –¥–æ 60 –¥–Ω–µ–π",
        "–∫—É—Ä–æ—Ä—Ç—ã": {
            "–∞–Ω—Ç–∞–ª—å—è": "–ì–ª–∞–≤–Ω—ã–π –∫—É—Ä–æ—Ä—Ç, –±–ª–∏–∑–∫–æ –∫ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É",
            "–±–µ–ª–µ–∫": "–ü—Ä–µ–º–∏—É–º, –ø–µ—Å—á–∞–Ω—ã–µ –ø–ª—è–∂–∏, –≥–æ–ª—å—Ñ",
            "–∫–µ–º–µ—Ä": "–ì–æ—Ä—ã –∏ –º–æ—Ä–µ, —Å–æ—Å–Ω—ã, –≥–∞–ª—å–∫–∞",
            "—Å–∏–¥–µ": "–ò—Å—Ç–æ—Ä–∏—è, –ø–µ—Å–æ–∫ –∏ –≥–∞–ª—å–∫–∞",
            "–∞–ª–∞–Ω–∏—è": "–ë—é–¥–∂–µ—Ç–Ω–æ, –¥–∞–ª–µ–∫–æ –æ—Ç –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞",
        },
        "–ø–æ–≥–æ–¥–∞": {
            "–º–∞–π": {"–≤–æ–∑–¥—É—Ö": "25-28¬∞C", "–º–æ—Ä–µ": "20-22¬∞C"},
            "–∏—é–Ω—å": {"–≤–æ–∑–¥—É—Ö": "30-33¬∞C", "–º–æ—Ä–µ": "24-26¬∞C"},
            "–∏—é–ª—å": {"–≤–æ–∑–¥—É—Ö": "33-36¬∞C", "–º–æ—Ä–µ": "27-29¬∞C"},
            "–∞–≤–≥—É—Å—Ç": {"–≤–æ–∑–¥—É—Ö": "33-36¬∞C", "–º–æ—Ä–µ": "28-30¬∞C"},
            "—Å–µ–Ω—Ç—è–±—Ä—å": {"–≤–æ–∑–¥—É—Ö": "28-32¬∞C", "–º–æ—Ä–µ": "26-28¬∞C"},
        }
    },
    "–µ–≥–∏–ø–µ—Ç": {
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "–ö—Ä—É–≥–ª–æ–≥–æ–¥–∏—á–Ω—ã–π –æ—Ç–¥—ã—Ö, –ö—Ä–∞—Å–Ω–æ–µ –º–æ—Ä–µ, –¥–∞–π–≤–∏–Ω–≥.",
        "—Å–µ–∑–æ–Ω": "–∫—Ä—É–≥–ª—ã–π –≥–æ–¥, –ª—É—á—à–µ –æ–∫—Ç—è–±—Ä—å-–∞–ø—Ä–µ–ª—å",
        "–ø–µ—Ä–µ–ª—ë—Ç": "4-5 —á–∞—Å–æ–≤ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "–≤–∏–∑–∞": "–ø–æ –ø—Ä–∏–ª—ë—Ç—É $25",
        "–∫—É—Ä–æ—Ä—Ç—ã": {
            "—à–∞—Ä–º-—ç–ª—å-—à–µ–π—Ö": "–ö–æ—Ä–∞–ª–ª—ã, –¥–∞–π–≤–∏–Ω–≥",
            "—Ö—É—Ä–≥–∞–¥–∞": "–ü–µ—Å—á–∞–Ω—ã–µ –ø–ª—è–∂–∏, —Å–µ–º–µ–π–Ω—ã–π –æ—Ç–¥—ã—Ö",
        }
    },
    "–æ–∞—ç": {
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "–†–æ—Å–∫–æ—à—å, —à–æ–ø–∏–Ω–≥, –Ω–µ–±–æ—Å–∫—Ä—ë–±—ã.",
        "—Å–µ–∑–æ–Ω": "–æ–∫—Ç—è–±—Ä—å-–∞–ø—Ä–µ–ª—å",
        "–ø–µ—Ä–µ–ª—ë—Ç": "5 —á–∞—Å–æ–≤ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "–≤–∏–∑–∞": "–Ω–µ –Ω—É–∂–Ω–∞ –¥–æ 90 –¥–Ω–µ–π",
        "–∫—É—Ä–æ—Ä—Ç—ã": {
            "–¥—É–±–∞–π": "–ì–ª–∞–≤–Ω—ã–π –≥–æ—Ä–æ–¥, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è",
            "–∞–±—É-–¥–∞–±–∏": "–°—Ç–æ–ª–∏—Ü–∞, –∫—É–ª—å—Ç—É—Ä–∞",
        }
    },
    "—Ç–∞–∏–ª–∞–Ω–¥": {
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "–≠–∫–∑–æ—Ç–∏–∫–∞, –æ—Å—Ç—Ä–æ–≤–∞, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–Ω—ã.",
        "—Å–µ–∑–æ–Ω": "–Ω–æ—è–±—Ä—å-–º–∞—Ä—Ç",
        "–ø–µ—Ä–µ–ª—ë—Ç": "9-10 —á–∞—Å–æ–≤ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "–≤–∏–∑–∞": "–Ω–µ –Ω—É–∂–Ω–∞ –¥–æ 30 –¥–Ω–µ–π",
        "–∫—É—Ä–æ—Ä—Ç—ã": {
            "–ø—Ö—É–∫–µ—Ç": "–ì–ª–∞–≤–Ω—ã–π –æ—Å—Ç—Ä–æ–≤",
            "–ø–∞—Ç—Ç–∞–π—è": "–ë–ª–∏–∑–∫–æ –∫ –ë–∞–Ω–≥–∫–æ–∫—É",
        }
    },
    "–º–∞–ª—å–¥–∏–≤—ã": {
        "–æ–ø–∏—Å–∞–Ω–∏–µ": "–†–∞–π—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞, –≤–æ–¥–Ω—ã–µ –≤–∏–ª–ª—ã, —Ä–æ–º–∞–Ω—Ç–∏–∫–∞.",
        "—Å–µ–∑–æ–Ω": "–¥–µ–∫–∞–±—Ä—å-–∞–ø—Ä–µ–ª—å",
        "–ø–µ—Ä–µ–ª—ë—Ç": "8-9 —á–∞—Å–æ–≤ –∏–∑ –ú–æ—Å–∫–≤—ã",
        "–≤–∏–∑–∞": "–Ω–µ –Ω—É–∂–Ω–∞ –¥–æ 30 –¥–Ω–µ–π"
    }
}


def get_system_prompt() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —Ç–µ–∫—É—â–∏–º –≥–æ–¥–æ–º."""
    return CONVERSATIONAL_SYSTEM_PROMPT.format(current_year=date.today().year)


def get_brain_prompt() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç '–ú–æ–∑–≥' —Å Chain of Thought –ª–æ–≥–∏–∫–æ–π."""
    return BRAIN_SYSTEM_PROMPT.format(current_date=date.today().strftime("%d.%m.%Y"))


def get_general_chat_prompt(user_message: str, known_params: dict) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è general chat."""
    params_parts = []
    if known_params.get("destination_country"):
        params_parts.append(f"–°—Ç—Ä–∞–Ω–∞: {known_params['destination_country']}")
    if known_params.get("date_from"):
        d = known_params["date_from"]
        if hasattr(d, 'strftime'):
            params_parts.append(f"–î–∞—Ç–∞: {d.strftime('%d.%m.%Y')}")
    if known_params.get("adults"):
        params_parts.append(f"–í–∑—Ä–æ—Å–ª—ã—Ö: {known_params['adults']}")
    
    known_str = ", ".join(params_parts) if params_parts else "–ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ"
    
    return GENERAL_CHAT_PROMPT.format(
        user_message=user_message,
        known_params=known_str
    )


def get_cascade_question(stage: str, params: dict = None) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ –∫–∞—Å–∫–∞–¥–∞.
    
    Args:
        stage: –ö–ª—é—á –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ CASCADE_QUESTIONS
        params: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏
    """
    question = CASCADE_QUESTIONS.get(stage, "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")
    
    if params and "{country}" in question:
        country = params.get("destination_country", "–≠—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")
        question = question.format(country=country)
    
    return question


def get_destination_info(country: str) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏."""
    return DESTINATIONS_KNOWLEDGE.get(country.lower(), {})


=== app/services/tourvisor.py ===

"""
Tourvisor API Full-Scale Gateway.

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–≥–æ –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tourvisor:
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ (search.php + result.php)
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (list.php)
- –ì–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã (hottours.php)
- –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω (actualize.php, actdetail.php)
- –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–µ–ª–µ–π (hotel.php)

–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ XML/JSON API Tourvisor.
"""
from __future__ import annotations

import asyncio
import httpx
import logging
from datetime import date, timedelta
from typing import Optional, Any
from dataclasses import dataclass, field
import uuid
from enum import Enum

from app.core.config import settings
from app.models.domain import (
    SearchRequest,
    TourOffer,
    TourFilters,
    HotelDetails,
    SearchResponse,
    FoodType,
    Destination,
)

# Fuzzy Matching –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞
try:
    from thefuzz import fuzz, process
    FUZZY_ENABLED = True
except ImportError:
    FUZZY_ENABLED = False
    logger = logging.getLogger(__name__)
    logger.warning("‚ö†Ô∏è thefuzz –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. Fuzzy matching –æ—Ç–∫–ª—é—á–µ–Ω.")

# –ò–º–ø–æ—Ä—Ç –∞–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∏–∑ Tourvisor API)
try:
    from app.core.tourvisor_constants import COUNTRIES, DEPARTURES
    CONSTANTS_LOADED = True
except ImportError:
    # Fallback –µ—Å–ª–∏ —Ñ–∞–π–ª –∫–æ–Ω—Å—Ç–∞–Ω—Ç –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω
    COUNTRIES = {}
    DEPARTURES = {}
    CONSTANTS_LOADED = False

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO, format='%(message)s')


# ==================== ENUMS & CONSTANTS ====================

class SearchType(Enum):
    """–¢–∏–ø –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤."""
    REGULAR = "regular"      # –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ search.php
    HOT_TOURS = "hot"        # –ì–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã —á–µ—Ä–µ–∑ hottours.php


class ResultType(Enum):
    """–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤."""
    STATUS = "status"
    RESULT = "result"


# –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è API (ID –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ Tourvisor)
# –ö–†–ò–¢–ò–ß–ù–û: API —Ç—Ä–µ–±—É–µ—Ç —á–∏—Å–ª–æ–≤—ã–µ ID, –Ω–µ —Å—Ç—Ä–æ–∫–∏!
# –ò—Å—Ç–æ—á–Ω–∏–∫: list.php?type=meal
MEAL_TYPE_MAP = {
    "RO": 2,   # Room Only - –ë–µ–∑ –ø–∏—Ç–∞–Ω–∏—è
    "BB": 3,   # Bed&Breakfast - –¢–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫
    "HB": 4,   # Half Board - –ó–∞–≤—Ç—Ä–∞–∫ + –£–∂–∏–Ω
    "FB": 5,   # Full Board - –ü–æ–ª–Ω—ã–π –ü–∞–Ω—Å–∏–æ–Ω
    "AI": 7,   # All Inclusive - –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ
    "UAI": 9,  # Ultra All Inclusive - –£–ª—å—Ç—Ä–∞ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ
}

# –û–±—Ä–∞—Ç–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ (ID -> –∫–æ–¥)
MEAL_TYPE_REVERSE = {v: k for k, v in MEAL_TYPE_MAP.items()}

# ==================== –ö–ï–®–ò –†–ï–ì–ò–û–ù–û–í (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è) ====================
# –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ API list.php, –ù–ï —Ö–∞—Ä–¥–∫–æ–¥!
# –°–æ–≥–ª–∞—Å–Ω–æ "2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx"
_REGIONS_CACHE: dict[int, list[dict]] = {}      # country_id -> list of regions
_SUBREGIONS_CACHE: dict[int, list[dict]] = {}   # country_id -> list of subregions (–∫—É—Ä–æ—Ä—Ç—ã)


# ==================== DATA CLASSES ====================

@dataclass
class HotelInfo:
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞."""
    hotel_id: int
    name: str
    stars: int = 0
    country_id: int = 0
    country_name: str = ""
    region_id: int = 0
    region_name: str = ""
    resort_id: int = 0
    resort_name: str = ""


@dataclass
class CountryInfo:
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞."""
    country_id: int
    name: str
    name_en: str = ""


@dataclass
class SearchStatus:
    """–°—Ç–∞—Ç—É—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞."""
    request_id: str
    state: str  # pending, searching, finished
    progress: int  # 0-100
    operators_done: int = 0
    operators_total: int = 0


@dataclass
class ActualizeResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—É—Ä–∞."""
    tour_id: str
    price: int
    available: bool
    price_changed: bool
    original_price: int = 0
    currency: str = "RUB"


@dataclass
class FlightInfo:
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ."""
    airline: str = ""
    flight_number: str = ""
    departure_time: str = ""
    arrival_time: str = ""
    departure_airport: str = ""
    arrival_airport: str = ""


# ==================== EXCEPTIONS ====================

class TourvisorAPIError(Exception):
    """–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Tourvisor API."""
    
    def __init__(self, message: str, user_message: str = None):
        self.message = message
        self.user_message = user_message or "–ò–∑–≤–∏–Ω–∏—Ç–µ, –±–∞–∑–∞ —Ç—É—Ä–æ–≤ —Å–µ–π—á–∞—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
        super().__init__(self.message)


class SearchTimeoutError(TourvisorAPIError):
    """–¢–∞–π–º–∞—É—Ç –ø–æ–∏—Å–∫–∞."""
    pass


class HotelNotFoundError(TourvisorAPIError):
    """–û—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."""
    pass


# ==================== MAIN SERVICE CLASS ====================

class TourvisorService:
    """
    Full-Scale Tourvisor API Gateway.
    
    –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API Tourvisor
    —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
    """
    
    def __init__(self):
        self.base_url = settings.TOURVISOR_BASE_URL.rstrip('/')
        self.auth_login = settings.TOURVISOR_AUTH_LOGIN
        self.auth_pass = settings.TOURVISOR_AUTH_PASS
        self.mock_enabled = settings.TOURVISOR_MOCK
        self.client: Optional[httpx.AsyncClient] = None
        
        # === In-Memory Cache –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ ===
        self._countries_cache: dict[str, CountryInfo] = {}  # name_lower -> CountryInfo
        self._countries_by_id: dict[int, CountryInfo] = {}  # id -> CountryInfo
        self._countries_loaded: bool = False
        
        self._departures_cache: dict[str, int] = {}  # name_lower -> id
        self._departures_loaded: bool = False
        
        # –ö—ç—à –æ—Ç–µ–ª–µ–π –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
        self._hotels_cache: dict[int, list[HotelInfo]] = {}  # country_id -> [hotels]
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–ª–∏–Ω–≥–∞
        # –ö–†–ò–¢–ò–ß–ù–û: GDS/—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ–π—Å—ã –≥—Ä—É–∑—è—Ç—Å—è –î–û–õ–ì–û!
        # –ï—Å–ª–∏ –æ–±—Ä—ã–≤–∞–µ–º —Ä–∞–Ω–æ ‚Äî —Ç–µ—Ä—è–µ–º –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ç—É—Ä–æ–≤
        self.poll_interval: float = 2.0  # —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Å—Ç–∞—Ç—É—Å–∞
        self.max_poll_attempts: int = 60  # ~120 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
        self.min_progress_to_fetch: int = 70  # –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–±–∏—Ä–∞—Ç—å –ø—Ä–∏ 70%+
        self.min_wait_seconds: float = 25.0  # –ú–∏–Ω–∏–º—É–º 25 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è (GDS –≥—Ä—É–∑–∏—Ç—Å—è –¥–æ–ª–≥–æ!)
    
    # ==================== HTTP CLIENT ====================
    
    async def _get_client(self) -> httpx.AsyncClient:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–∞ —Å –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π."""
        if self.client is None:
            self.client = httpx.AsyncClient(
                timeout=httpx.Timeout(30.0, connect=10.0),
                headers={"Accept": "application/json"}
            )
        return self.client
    
    async def _request(self, endpoint: str, params: dict) -> dict:
        """
        –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ Tourvisor API.
        
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (authlogin, authpass) –∏ format=json.
        """
        client = await self._get_client()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL
        url = f"{self.base_url}/{endpoint.lstrip('/')}"
        
        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        if self.auth_login and self.auth_pass:
            params["authlogin"] = self.auth_login
            params["authpass"] = self.auth_pass
        params["format"] = "json"
        
        logger.debug(f"üì° API Request: {endpoint}")
        logger.debug(f"   Params: {params}")
        
        try:
            response = await client.get(url, params=params)
            
            if response.status_code == 401:
                raise TourvisorAPIError("Unauthorized", "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ API —Ç—É—Ä–æ–≤.")
            
            if response.status_code != 200:
                raise TourvisorAPIError(f"HTTP {response.status_code}")
            
            # –û—á–∏—Å—Ç–∫–∞ BOM –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
            text = response.text.strip()
            if text.startswith('\ufeff'):
                text = text[1:]
            
            if not text or text == "{}":
                return {}
            
            return response.json()
            
        except httpx.HTTPError as e:
            logger.error(f"‚ùå HTTP Error: {e}")
            raise TourvisorAPIError(str(e))
        except Exception as e:
            logger.error(f"‚ùå Request Error: {e}")
            raise TourvisorAPIError(str(e))
    
    # ==================== 1. –°–ü–†–ê–í–û–ß–ù–ò–ö–ò (list.php) ====================
    
    async def load_countries(self) -> bool:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç—Ä–∞–Ω.
        
        –ú–µ—Ç–æ–¥: list.php?type=country
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx
        """
        if self._countries_loaded:
            return True
        
        logger.info("üåç –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—Ç—Ä–∞–Ω...")
        
        if self.mock_enabled:
            self._load_mock_countries()
            return True
        
        try:
            response = await self._request("list.php", {"type": "country"})
            
            # –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            countries_data = (
                response.get("lists", {}).get("countries", {}).get("country", []) or
                response.get("data", {}).get("country", []) or
                []
            )
            
            if isinstance(countries_data, dict):
                countries_data = [countries_data]
            
            for c in countries_data:
                cid = int(c.get("id", 0))
                name = c.get("name", "")
                name_en = c.get("name_en", "")
                
                if cid and name:
                    info = CountryInfo(country_id=cid, name=name, name_en=name_en)
                    self._countries_cache[name.lower()] = info
                    self._countries_by_id[cid] = info
                    
                    if name_en:
                        self._countries_cache[name_en.lower()] = info
            
            self._countries_loaded = True
            logger.info(f"üåç –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self._countries_by_id)} —Å—Ç—Ä–∞–Ω")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω: {e}")
            self._load_mock_countries()
            return False
    
    def _load_mock_countries(self):
        """
        Fallback –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç.
        
        –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ app/core/tourvisor_constants.py,
        –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º scripts/sync_tourvisor_data.py
        """
        if CONSTANTS_LOADED and COUNTRIES:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
            seen_ids = set()
            for name, cid in COUNTRIES.items():
                # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à
                if cid not in seen_ids:
                    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–ø–µ—Ä–≤–æ–µ —Ä—É—Å—Å–∫–æ–µ)
                    display_name = name.title()
                    info = CountryInfo(country_id=cid, name=display_name, name_en="")
                    self._countries_by_id[cid] = info
                    seen_ids.add(cid)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –º–∞–ø–ø–∏–Ω–≥ –∏–º–µ–Ω–∏
                if cid in self._countries_by_id:
                    self._countries_cache[name.lower()] = self._countries_by_id[cid]
            
            self._countries_loaded = True
            logger.info(f"üåç [CONSTANTS] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self._countries_by_id)} —Å—Ç—Ä–∞–Ω –∏–∑ tourvisor_constants.py")
        else:
            # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fallback –µ—Å–ª–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            logger.warning("‚ö†Ô∏è tourvisor_constants.py –Ω–µ –Ω–∞–π–¥–µ–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python scripts/sync_tourvisor_data.py")
            
            minimal_countries = [
                (1, "–ï–≥–∏–ø–µ—Ç"), (2, "–¢–∞–∏–ª–∞–Ω–¥"), (4, "–¢—É—Ä—Ü–∏—è"), (8, "–ú–∞–ª—å–¥–∏–≤—ã"), (9, "–û–ê–≠")
            ]
            for cid, name in minimal_countries:
                info = CountryInfo(country_id=cid, name=name, name_en="")
                self._countries_cache[name.lower()] = info
                self._countries_by_id[cid] = info
            
            self._countries_loaded = True
            logger.info(f"üåç [FALLBACK] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self._countries_by_id)} —Å—Ç—Ä–∞–Ω (–º–∏–Ω–∏–º—É–º)")
    
    async def load_departures(self) -> bool:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞.
        
        –ú–µ—Ç–æ–¥: list.php?type=departure
        """
        if self._departures_loaded:
            return True
        
        logger.info("‚úàÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞...")
        
        if self.mock_enabled:
            self._departures_cache = self._get_default_departures()
            self._departures_loaded = True
            return True
        
        try:
            response = await self._request("list.php", {"type": "departure"})
            
            departures_data = (
                response.get("lists", {}).get("departures", {}).get("departure", []) or
                response.get("data", {}).get("departure", []) or
                []
            )
            
            if isinstance(departures_data, dict):
                departures_data = [departures_data]
            
            for d in departures_data:
                did = int(d.get("id", 0))
                name = d.get("name", "")
                
                if did and name:
                    self._departures_cache[name.lower()] = did
            
            # –î–æ–ø–æ–ª–Ω—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏
            defaults = self._get_default_departures()
            for name, did in defaults.items():
                if name not in self._departures_cache:
                    self._departures_cache[name] = did
            
            self._departures_loaded = True
            logger.info(f"‚úàÔ∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self._departures_cache)} –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ª–µ—Ç–∞")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤: {e}")
            self._departures_cache = self._get_default_departures()
            self._departures_loaded = True
            return False
    
    def _get_default_departures(self) -> dict[str, int]:
        """
        –ì–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞ –∏–∑ –∞–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç.
        
        –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ app/core/tourvisor_constants.py,
        –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º scripts/sync_tourvisor_data.py
        """
        if CONSTANTS_LOADED and DEPARTURES:
            logger.info(f"‚úàÔ∏è [CONSTANTS] –ò—Å–ø–æ–ª—å–∑—É–µ–º {len(DEPARTURES)} –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ tourvisor_constants.py")
            return DEPARTURES.copy()
        
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fallback –µ—Å–ª–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        logger.warning("‚ö†Ô∏è tourvisor_constants.py –Ω–µ –Ω–∞–π–¥–µ–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python scripts/sync_tourvisor_data.py")
        return {
            # –ú–æ—Å–∫–≤–∞
            "–º–æ—Å–∫–≤–∞": 1, "–º—Å–∫": 1, "–º–æ—Å–∫–≤—ã": 1,
            # –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
            "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": 2, "—Å–ø–±": 2, "–ø–∏—Ç–µ—Ä": 2, "–ø–µ—Ç–µ—Ä–±—É—Ä–≥": 2,
            # –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
            "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": 3, "–µ–∫–±": 3,
            # –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫
            "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": 8, "–Ω–æ–≤–æ—Å–∏–±": 8,
            # –ö–∞–∑–∞–Ω—å
            "–∫–∞–∑–∞–Ω—å": 10, "–∫–∞–∑–∞–Ω–∏": 10,
            # –°–æ—á–∏
            "—Å–æ—á–∏": 62, "—Å–æ—á–∏ (–∞–¥–ª–µ—Ä)": 62, "–∞–¥–ª–µ—Ä": 62,
            # –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä
            "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä": 11,
        }
    
    async def load_dictionaries(self) -> bool:
        """
        System Startup Sync ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤.
        
        –°–æ–≥–ª–∞—Å–Ω–æ "2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx":
        - –°—Ç—Ä–∞–Ω—ã: list.php?type=country
        - –ì–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞: list.php?type=departure
        
        –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏–ª–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        
        Returns:
            True –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞
        """
        logger.info("üìö System Startup Sync: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤...")
        
        countries_ok = await self.load_countries()
        departures_ok = await self.load_departures()
        
        if countries_ok and departures_ok:
            logger.info(f"‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {len(self._countries_cache)} —Å—Ç—Ä–∞–Ω, {len(self._departures_cache)} –≥–æ—Ä–æ–¥–æ–≤")
            return True
        else:
            logger.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤!")
            return False
    
    async def load_regions_for_country(self, country_id: int) -> list[dict]:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.
        
        –ú–µ—Ç–æ–¥: list.php?type=region&regcountry=ID
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å id –∏ name —Ä–µ–≥–∏–æ–Ω–æ–≤
        """
        global _REGIONS_CACHE
        
        if country_id in _REGIONS_CACHE:
            return _REGIONS_CACHE[country_id]
        
        logger.info(f"üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country_id}...")
        
        try:
            response = await self._request("list.php", {
                "type": "region",
                "regcountry": country_id
            })
            
            regions_data = (
                response.get("lists", {}).get("regions", {}).get("region", []) or
                response.get("data", {}).get("region", []) or
                []
            )
            
            if isinstance(regions_data, dict):
                regions_data = [regions_data]
            
            regions = []
            for r in regions_data:
                rid = int(r.get("id", 0))
                name = r.get("name", "")
                if rid and name:
                    regions.append({"id": rid, "name": name.lower()})
            
            _REGIONS_CACHE[country_id] = regions
            logger.info(f"üó∫Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(regions)} —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country_id}")
            return regions
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤: {e}")
            return []
    
    async def get_region_id_by_name(self, region_name: str, country_id: int) -> Optional[int]:
        """
        –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ ID —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —á–µ—Ä–µ–∑ API.
        
        –°–æ–≥–ª–∞—Å–Ω–æ "2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx":
        1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ regions (list.php?type=region)
        2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º –≤ subregions (list.php?type=subregion)
        
        Args:
            region_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä. "–°–æ—á–∏")
            country_id: ID —Å—Ç—Ä–∞–Ω—ã
            
        Returns:
            ID —Ä–µ–≥–∏–æ–Ω–∞ –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        if not region_name or not country_id:
            return None
        
        region_name_lower = region_name.lower().strip()
        
        # –®–ê–ì 1: –ò—â–µ–º –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö (type=region)
        regions = await self.load_regions_for_country(country_id)
        
        # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ regions
        for r in regions:
            if r["name"] == region_name_lower:
                logger.info(f"üó∫Ô∏è –†–µ–≥–∏–æ–Ω '{region_name}' ‚Üí ID={r['id']} (region, —Ç–æ—á–Ω–æ–µ)")
                return r["id"]
        
        # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ regions
        for r in regions:
            if region_name_lower in r["name"] or r["name"] in region_name_lower:
                logger.info(f"üó∫Ô∏è –†–µ–≥–∏–æ–Ω '{region_name}' ‚Üí ID={r['id']} (region, fuzzy: {r['name']})")
                return r["id"]
        
        # –®–ê–ì 2: –ò—â–µ–º –≤ —Å—É–±—Ä–µ–≥–∏–æ–Ω–∞—Ö/–∫—É—Ä–æ—Ä—Ç–∞—Ö (type=subregion)
        subregions = await self.load_subregions_for_country(country_id)
        
        # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ subregions
        for r in subregions:
            if r["name"] == region_name_lower:
                logger.info(f"üó∫Ô∏è –°—É–±—Ä–µ–≥–∏–æ–Ω '{region_name}' ‚Üí ID={r['id']} (subregion, —Ç–æ—á–Ω–æ–µ)")
                return r["id"]
        
        # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ subregions
        for r in subregions:
            if region_name_lower in r["name"] or r["name"] in region_name_lower:
                logger.info(f"üó∫Ô∏è –°—É–±—Ä–µ–≥–∏–æ–Ω '{region_name}' ‚Üí ID={r['id']} (subregion, fuzzy: {r['name']})")
                return r["id"]
        
        logger.warning(f"‚ö†Ô∏è –†–µ–≥–∏–æ–Ω/—Å—É–±—Ä–µ–≥–∏–æ–Ω '{region_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç—Ä–∞–Ω–µ {country_id}")
        return None
    
    async def load_subregions_for_country(self, country_id: int) -> list[dict]:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—É–±—Ä–µ–≥–∏–æ–Ω–æ–≤ (–∫—É—Ä–æ—Ä—Ç–æ–≤) –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.
        
        –ú–µ—Ç–æ–¥: list.php?type=subregion&regcountry=ID
        –°–æ–≥–ª–∞—Å–Ω–æ "2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx", Source 44
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å id –∏ name —Å—É–±—Ä–µ–≥–∏–æ–Ω–æ–≤
        """
        global _SUBREGIONS_CACHE
        
        if country_id in _SUBREGIONS_CACHE:
            return _SUBREGIONS_CACHE[country_id]
        
        logger.info(f"üèñÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É–±—Ä–µ–≥–∏–æ–Ω–æ–≤ (–∫—É—Ä–æ—Ä—Ç–æ–≤) –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country_id}...")
        
        try:
            response = await self._request("list.php", {
                "type": "subregion",
                "regcountry": country_id
            })
            
            subregions_data = (
                response.get("lists", {}).get("subregions", {}).get("subregion", []) or
                response.get("data", {}).get("subregion", []) or
                []
            )
            
            if isinstance(subregions_data, dict):
                subregions_data = [subregions_data]
            
            subregions = []
            for r in subregions_data:
                rid = int(r.get("id", 0))
                name = r.get("name", "")
                if rid and name:
                    subregions.append({"id": rid, "name": name.lower()})
            
            _SUBREGIONS_CACHE[country_id] = subregions
            logger.info(f"üèñÔ∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(subregions)} —Å—É–±—Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country_id}")
            return subregions
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—É–±—Ä–µ–≥–∏–æ–Ω–æ–≤: {e}")
            return []
    
    async def load_hotels_for_country(self, country_id: int) -> list[HotelInfo]:
        """
        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ—Ç–µ–ª–µ–π –¥–ª—è —Å—Ç—Ä–∞–Ω—ã.
        
        –ú–µ—Ç–æ–¥: list.php?type=hotel&hotcountry=ID
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 2. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏.docx
        
        –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä hotcountry (–Ω–µ countryid)!
        """
        if country_id in self._hotels_cache:
            return self._hotels_cache[country_id]
        
        logger.info(f"üè® –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–µ–ª–µ–π –¥–ª—è —Å—Ç—Ä–∞–Ω—ã ID={country_id}...")
        
        if self.mock_enabled:
            return []
        
        try:
            response = await self._request("list.php", {
                "type": "hotel",
                "hotcountry": country_id  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            })
            
            hotels_data = (
                response.get("lists", {}).get("hotels", {}).get("hotel", []) or
                response.get("data", {}).get("hotel", []) or
                []
            )
            
            if isinstance(hotels_data, dict):
                hotels_data = [hotels_data]
            
            hotels = []
            for h in hotels_data:
                hotel = HotelInfo(
                    hotel_id=int(h.get("id", 0)),
                    name=h.get("name", ""),
                    stars=int(h.get("stars", 0)),
                    country_id=country_id,
                    region_id=int(h.get("regionid", 0)),
                    region_name=h.get("regionname", ""),
                    resort_id=int(h.get("subregionid", 0)),
                    resort_name=h.get("subregionname", ""),
                )
                if hotel.hotel_id and hotel.name:
                    hotels.append(hotel)
            
            self._hotels_cache[country_id] = hotels
            logger.info(f"üè® –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(hotels)} –æ—Ç–µ–ª–µ–π")
            return hotels
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª–µ–π: {e}")
            return []
    
    # ==================== LOOKUP METHODS ====================
    
    def get_country_id(self, name: str) -> Optional[int]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å—Ç—Ä–∞–Ω—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é."""
        if not name:
            return None
        
        name_lower = name.lower().strip()
        
        if name_lower in self._countries_cache:
            return self._countries_cache[name_lower].country_id
        
        # –¢–∏–ø–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
        variations = {
            "—Ç–∞–π–ª–∞–Ω–¥": "—Ç–∞–∏–ª–∞–Ω–¥",
            "—Ç—É—Ä—Ü–∏–∏": "—Ç—É—Ä—Ü–∏—è", "—Ç—É—Ä—Ü–∏—é": "—Ç—É—Ä—Ü–∏—è",
            "–µ–≥–∏–ø—Ç–∞": "–µ–≥–∏–ø–µ—Ç",
            "—ç–º–∏—Ä–∞—Ç—ã": "–æ–∞—ç", "–¥—É–±–∞–π": "–æ–∞—ç",
            "–º–∞–ª—å–¥–∏–≤": "–º–∞–ª—å–¥–∏–≤—ã",
            "–±–∞–ª–∏": "–∏–Ω–¥–æ–Ω–µ–∑–∏—è",
        }
        
        if name_lower in variations:
            fixed = variations[name_lower]
            if fixed in self._countries_cache:
                return self._countries_cache[fixed].country_id
        
        # –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
        for key, info in self._countries_cache.items():
            if name_lower in key or key in name_lower:
                return info.country_id
        
        return None
    
    def get_country_name(self, country_id: int) -> Optional[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã –ø–æ ID."""
        if country_id in self._countries_by_id:
            return self._countries_by_id[country_id].name
        return None
    
    def get_departure_id(self, name: str) -> Optional[int]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ ID –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞ —Å Fuzzy Matching.
        
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
        - –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: "–º–æ—Å–∫–≤–∞" ‚Üí 1
        - –ß–∞—Å—Ç–∏—á–Ω–æ–µ: "—Å–æ—á–∏" ‚Üí "—Å–æ—á–∏ (–∞–¥–ª–µ—Ä)" ‚Üí ID
        - Fuzzy (>80%): "–ü–∏—Ç–µ—Ä" ‚Üí "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ï–∫–±" ‚Üí "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥"
        """
        if not name:
            return None
        
        name_lower = name.lower().strip()
        
        # 1. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if name_lower in self._departures_cache:
            logger.info(f"   ‚úàÔ∏è –ì–æ—Ä–æ–¥ '{name}' ‚Üí —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ")
            return self._departures_cache[name_lower]
        
        # 2. –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (substring)
        for key, did in self._departures_cache.items():
            if name_lower in key or key in name_lower:
                logger.info(f"   ‚úàÔ∏è –ì–æ—Ä–æ–¥ '{name}' ‚Üí —á–∞—Å—Ç–∏—á–Ω–æ–µ: '{key}'")
                return did
        
        # 3. Fuzzy Matching (–µ—Å–ª–∏ thefuzz —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
        if FUZZY_ENABLED and self._departures_cache:
            result = self._fuzzy_find_city(name_lower, self._departures_cache)
            if result:
                found_name, found_id, score = result
                logger.info(f"   ‚úàÔ∏è –ì–æ—Ä–æ–¥ '{name}' ‚Üí fuzzy ({score}%): '{found_name}'")
                return found_id
        
        logger.warning(f"   ‚ö†Ô∏è –ì–æ—Ä–æ–¥ '{name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ")
        return None
    
    def _fuzzy_find_city(
        self, 
        user_input: str, 
        city_dict: dict[str, int],
        threshold: int = 80
    ) -> Optional[tuple[str, int, int]]:
        """
        Fuzzy –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ.
        
        Args:
            user_input: –í–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (lowercase)
            city_dict: –°–ª–æ–≤–∞—Ä—å {–≥–æ—Ä–æ–¥: id}
            threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π % —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (default 80%)
        
        Returns:
            tuple(–Ω–∞–π–¥–µ–Ω–Ω—ã–π_–∫–ª—é—á, id, score) –∏–ª–∏ None
        """
        if not FUZZY_ENABLED or not city_dict:
            return None
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏
        choices = list(city_dict.keys())
        
        # –ò—â–µ–º –ª—É—á—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        result = process.extractOne(user_input, choices, scorer=fuzz.ratio)
        
        if result:
            best_match, score = result[0], result[1]
            if score >= threshold:
                return (best_match, city_dict[best_match], score)
        
        # –ü—Ä–æ–±—É–µ–º partial_ratio –¥–ª—è —Å–ª—É—á–∞–µ–≤ —Ç–∏–ø–∞ "—Å–æ—á–∏" ‚Üí "—Å–æ—á–∏ (–∞–¥–ª–µ—Ä)"
        result_partial = process.extractOne(user_input, choices, scorer=fuzz.partial_ratio)
        
        if result_partial:
            best_match, score = result_partial[0], result_partial[1]
            if score >= 90:  # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä–æ–≥ –¥–ª—è partial
                return (best_match, city_dict[best_match], score)
        
        return None
    
    # ==================== 2. –ü–û–ò–°–ö –û–¢–ï–õ–ï–ô ====================
    
    # ==================== –¢–†–ê–ù–°–õ–ò–¢–ï–†–ê–¶–ò–Ø –†–£–° ‚Üí ENG ====================
    # –î–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª–µ–π "–†–∏–∫—Å–æ—Å" ‚Üí "Rixos"
    TRANSLIT_MAP = {
        "–∞": "a", "–±": "b", "–≤": "v", "–≥": "g", "–¥": "d", "–µ": "e", "—ë": "e",
        "–∂": "zh", "–∑": "z", "–∏": "i", "–π": "y", "–∫": "k", "–ª": "l", "–º": "m",
        "–Ω": "n", "–æ": "o", "–ø": "p", "—Ä": "r", "—Å": "s", "—Ç": "t", "—É": "u",
        "—Ñ": "f", "—Ö": "h", "—Ü": "ts", "—á": "ch", "—à": "sh", "—â": "sch",
        "—ä": "", "—ã": "y", "—å": "", "—ç": "e", "—é": "yu", "—è": "ya",
    }
    
    # –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏ –æ—Ç–µ–ª–µ–π (–†—É—Å—Å–∫–∏–π ‚Üí –ê–Ω–≥–ª–∏–π—Å–∫–∏–π)
    HOTEL_NAME_ALIASES = {
        "—Ä–∏–∫—Å–æ—Å": "rixos", "—Ä–∏–∫–æ—Å": "rixos",
        "–∫–∞–ª–∏—Å—Ç–∞": "calista", "–∫–∞–ª–∏—Å—Ç": "calista",
        "—Ä–µ–≥–Ω—É–º": "regnum", 
        "—Ç–∏—Ç–∞–Ω–∏–∫": "titanic",
        "–¥–µ–ª—å—Ñ–∏–Ω": "delphin", "–¥–µ–ª—Ñ–∏–Ω": "delphin",
        "–±–∞—Ä—É—Ç": "barut",
        "–≤–æ—è–∂": "voyage", "–≤–æ–π–∞–∂": "voyage",
        "–≥–ª–æ—Ä–∏—è": "gloria",
        "—Ö–∏–ª—Ç–æ–Ω": "hilton",
        "—à–µ—Ä–∞—Ç–æ–Ω": "sheraton",
        "–º–∞—Ä–∏–æ—Ç—Ç": "marriott", "–º–∞—Ä—Ä–∏–æ—Ç—Ç": "marriott",
        "–∞—Ç–ª–∞–Ω—Ç–∏—Å": "atlantis",
        "–¥–∂—É–º–µ–π—Ä–∞": "jumeirah", "–¥–∂—É–º–µ–π—Ä": "jumeirah",
        "—Å–∞–Ω—Ä–∞–π–∑": "sunrise",
        "—à—Ç–∞–π–≥–µ–Ω–±–µ—Ä–≥–µ—Ä": "steigenberger",
    }
    
    def _transliterate(self, text: str) -> str:
        """–¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É."""
        result = []
        for char in text.lower():
            result.append(self.TRANSLIT_MAP.get(char, char))
        return "".join(result)
    
    def _normalize_hotel_query(self, query: str) -> list[str]:
        """
        –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–µ–ª—è.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–∏—Å–∫–∞.
        """
        query_lower = query.lower().strip()
        variants = [query_lower]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∞–ª–∏–∞—Å—ã
        for rus, eng in self.HOTEL_NAME_ALIASES.items():
            if rus in query_lower:
                variants.append(query_lower.replace(rus, eng))
        
        # –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü–∞
        if any(ord(c) > 127 for c in query_lower):
            transliterated = self._transliterate(query_lower)
            variants.append(transliterated)
        
        return list(set(variants))  # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏
    
    async def find_hotel_by_name(
        self,
        query: str,
        country: Optional[str] = None,
        country_id: Optional[int] = None,
        region: Optional[str] = None,
        resort: Optional[str] = None
    ) -> list[HotelInfo]:
        """
        –ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏.
        
        HOTEL FILTER FIX: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω region/resort, —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!
        –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "–ñ–µ–º—á—É–∂–∏–Ω–∞ –≤ –ú–∞—Ö–∞—á–∫–∞–ª–µ" –∫–æ–≥–¥–∞ –∏—â—É—Ç –°–æ—á–∏.
        
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
        - –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è: "–†–∏–∫—Å–æ—Å" ‚Üí "Rixos"
        - –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: "rixos" ‚Üí "Rixos Premium Belek"
        - –ù–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω—É/–∫—É—Ä–æ—Ä—Ç—É
        """
        logger.info(f"\nüîç –ü–æ–∏—Å–∫ –æ—Ç–µ–ª—è: '{query}'" + (f" –≤ —Ä–µ–≥–∏–æ–Ω–µ: {region or resort}" if region or resort else ""))
        
        if self.mock_enabled:
            return []
        
        await self.load_countries()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞–Ω—É
        if country_id:
            search_country_ids = [country_id]
        elif country:
            cid = self.get_country_id(country)
            search_country_ids = [cid] if cid else []
        else:
            # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (ID –∏–∑ tourvisor_constants.py)
            search_country_ids = [
                COUNTRIES.get("—Ç—É—Ä—Ü–∏—è", 4),
                COUNTRIES.get("–µ–≥–∏–ø–µ—Ç", 1), 
                COUNTRIES.get("–æ–∞—ç", 9),
                COUNTRIES.get("—Ç–∞–∏–ª–∞–Ω–¥", 2),
                COUNTRIES.get("–º–∞–ª—å–¥–∏–≤—ã", 8)
            ]
        
        if not search_country_ids:
            logger.warning("   ‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
            return []
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ (—Å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π)
        search_variants = self._normalize_hotel_query(query)
        logger.info(f"   üî§ –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–∏—Å–∫–∞: {search_variants}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º region/resort –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        region_lower = region.lower() if region else None
        resort_lower = resort.lower() if resort else None
        
        results = []
        filtered_by_region = []
        
        for cid in search_country_ids:
            hotels = await self.load_hotels_for_country(cid)
            
            for hotel in hotels:
                hotel_name_lower = hotel.name.lower()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞
                for variant in search_variants:
                    if variant in hotel_name_lower:
                        if hotel not in results:  # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–µ–π
                            results.append(hotel)
                            
                            # HOTEL FILTER FIX: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞/–∫—É—Ä–æ—Ä—Ç–∞
                            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã HotelInfo!
                            if region_lower or resort_lower:
                                # HotelInfo –∏–º–µ–µ—Ç: region_name, resort_name
                                hotel_region = (hotel.region_name or '').lower()
                                hotel_resort = (hotel.resort_name or '').lower()
                                
                                # Fuzzy matching: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
                                location_match = False
                                search_terms = [region_lower, resort_lower]
                                hotel_locations = [hotel_region, hotel_resort]
                                
                                for search_term in search_terms:
                                    if not search_term:
                                        continue
                                    for hotel_loc in hotel_locations:
                                        if not hotel_loc:
                                            continue
                                        # –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π fuzzy match
                                        if search_term in hotel_loc or hotel_loc in search_term:
                                            location_match = True
                                            break
                                    if location_match:
                                        break
                                
                                if location_match:
                                    filtered_by_region.append(hotel)
                                    logger.info(f"   ‚úÖ –ù–∞–π–¥–µ–Ω –≤ {region or resort}: {hotel.name} ({hotel.stars}*) [region={hotel_region}, resort={hotel_resort}]")
                            else:
                                logger.info(f"   ‚úÖ –ù–∞–π–¥–µ–Ω: {hotel.name} ({hotel.stars}*)")
                        break
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ä–µ–≥–∏–æ–Ω ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
        if region_lower or resort_lower:
            if filtered_by_region:
                logger.info(f"   üìä –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–µ–≥–∏–æ–Ω—É '{region or resort}': {len(filtered_by_region)} –∏–∑ {len(results)} –æ—Ç–µ–ª–µ–π")
                return filtered_by_region
            elif results:
                # FALLBACK: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–ª–∞ 0, –Ω–æ –æ–±—â–∏–π –ø–æ–∏—Å–∫ –Ω–∞—à—ë–ª –æ—Ç–µ–ª–∏
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑-–∑–∞ –æ–ø–µ—á–∞—Ç–æ–∫
                logger.warning(f"   ‚ö†Ô∏è –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–≥–∏–æ–Ω—É '{region or resort}' –¥–∞–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ {len(results)} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—Ç–µ–ª–µ–π.")
                return results
        
        if results:
            logger.info(f"   üìä –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: {len(results)} –æ—Ç–µ–ª–µ–π")
        else:
            logger.warning(f"   ‚ö†Ô∏è –û—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {search_variants}")
        
        return results
    
    # ==================== 3. –ê–°–ò–ù–•–†–û–ù–ù–´–ô –ü–û–ò–°–ö –¢–£–†–û–í (search.php) ====================
    
    async def search_tours(
        self,
        params: SearchRequest,
        filters: Optional[TourFilters] = None,
        is_strict_hotel_search: bool = False,
        hotel_ids: Optional[list[int]] = None,
        is_hot_tour: bool = False
    ) -> SearchResponse:
        """
        –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤ —á–µ—Ä–µ–∑ search.php.
        
        –ü—Ä–æ—Ç–æ–∫–æ–ª (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):
        1. GET search.php —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚Üí –ø–æ–ª—É—á–∞–µ–º requestid
        2. –¶–∏–∫–ª –æ–ø—Ä–æ—Å–∞ result.php?type=status –∫–∞–∂–¥—ã–µ 2-3 —Å–µ–∫
        3. –ö–æ–≥–¥–∞ progress > 0, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º result.php?type=result
        
        Args:
            params: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            filters: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            is_strict_hotel_search: –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ—Ç–µ–ª—è–º
            hotel_ids: –°–ø–∏—Å–æ–∫ ID –æ—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã)
        """
        logger.info("\n" + "=" * 60)
        logger.info("üîç –ü–û–ò–°–ö –¢–£–†–û–í (Async Protocol)")
        logger.info("=" * 60)
        
        if self.mock_enabled:
            logger.info("   üîß MOCK —Ä–µ–∂–∏–º")
            return await self._mock_search_tours(params)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
        await self.load_countries()
        await self.load_departures()
        
        # –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç—Ä–∞–Ω—ã
        country_id = self.get_country_id(params.destination.country)
        if not country_id:
            logger.error(f"‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {params.destination.country}")
            return SearchResponse(
                offers=[], total_found=0, found=False,
                reason="unknown_country",
                suggestion="check_country_name"
            )
        
        # ==================== –ì–û–†–û–î –í–´–õ–ï–¢–ê (NO DEFAULT!) ====================
        departure_id = self.get_departure_id(params.departure_city)
        
        if not departure_id:
            logger.error(f"‚ùå –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ '{params.departure_city}' –ù–ï –ù–ê–ô–î–ï–ù –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ!")
            # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç –ú–æ—Å–∫–≤–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
            return SearchResponse(
                offers=[], total_found=0, found=False,
                reason="unknown_departure",
                suggestion=f"–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ '{params.departure_city}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
            )
        
        logger.info(f"   ‚úàÔ∏è –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞: '{params.departure_city}' ‚Üí ID={departure_id}")
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –æ—Ç–µ–ª—å ‚Äî –∏—â–µ–º –µ–≥–æ ID (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ä–µ–≥–∏–æ–Ω—É!)
        if params.hotel_name and not hotel_ids:
            logger.info(f"   üè® –ü–æ–∏—Å–∫ –æ—Ç–µ–ª—è: {params.hotel_name}")
            # HOTEL FILTER FIX: –ü–µ—Ä–µ–¥–∞—ë–º region/resort –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            hotels = await self.find_hotel_by_name(
                params.hotel_name, 
                country_id=country_id,
                region=params.destination.region if params.destination else None,
                resort=params.destination.resort if params.destination else None
            )
            if hotels:
                hotel_ids = [h.hotel_id for h in hotels[:5]]
                logger.info(f"   ‚úÖ ID –æ—Ç–µ–ª–µ–π: {hotel_ids}")
            elif is_strict_hotel_search:
                # ‚õî STOP: –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –ø–æ –æ—Ç–µ–ª—é, –Ω–æ ID –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –ù–ï –¥–µ–ª–∞–µ–º –æ–±—â–∏–π –ø–æ–∏—Å–∫!
                logger.warning(f"   ‚õî STOP: Strict hotel search for '{params.hotel_name}' but no IDs found. Returning empty.")
                return SearchResponse(
                    offers=[], total_found=0, found=False,
                    reason="hotel_not_found_in_db",
                    suggestion=f"–û—Ç–µ–ª—å '{params.hotel_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤"
                )
        
        # ‚õî –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ strict –ø–æ–∏—Å–∫, –Ω–æ hotel_ids –ø—É—Å—Ç—ã–µ ‚Äî –°–¢–û–ü!
        if is_strict_hotel_search and not hotel_ids:
            logger.warning("‚õî STOP: Strict hotel search requested but no hotel_ids provided. Returning empty.")
            return SearchResponse(
                offers=[], total_found=0, found=False,
                reason="hotel_not_found_in_db",
                suggestion="–û—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤"
            )
        
        # === STEP 0.5: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ ID —Ä–µ–≥–∏–æ–Ω–∞ —á–µ—Ä–µ–∑ API ===
        region_id = None
        if params.destination and params.destination.region:
            region_id = await self.get_region_id_by_name(
                params.destination.region, 
                country_id
            )
        
        # === STEP 1: –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ ===
        api_params = self._build_search_params(
            params, country_id, departure_id, hotel_ids,
            is_hot_tour=is_hot_tour,
            region_id=region_id
        )
        
        logger.info(f"   üì° –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞...")
        logger.info(f"      –°—Ç—Ä–∞–Ω–∞: {country_id}")
        logger.info(f"      –í—ã–ª–µ—Ç: {departure_id}")
        logger.info(f"      –î–∞—Ç—ã: {api_params.get('datefrom')} - {api_params.get('dateto')}")
        
        try:
            search_response = await self._request("search.php", api_params)
            request_id = self._extract_request_id(search_response)
            
            if not request_id:
                logger.error("‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω requestid")
                return SearchResponse(
                    offers=[], total_found=0, found=False,
                    reason="api_error"
                )
            
            logger.info(f"   ‚úÖ Request ID: {request_id}")
            
            # === STEP 2: –¶–∏–∫–ª –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ ===
            offers = await self._poll_and_fetch_results(
                request_id, country_id, is_strict_hotel_search, hotel_ids
            )
            
            # ==================== –°–¢–†–û–ì–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –ó–í–Å–ó–î–ê–ú ====================
            # API Tourvisor –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—É starsfrom!
            # –ú—ã –û–ë–Ø–ó–ê–ù–´ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞.
            # –ù–ò–ö–ê–ö–û–ì–û SOFT FALLBACK ‚Äî –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏–ª 5*, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û 5*!
            
            logger.info(f"   üìä API –≤–µ—Ä–Ω—É–ª {len(offers)} —Ç—É—Ä–æ–≤ (onpage=100)")
            
            if params.stars and offers:
                original_count = len(offers)
                min_stars = int(params.stars)
                
                # –°–¢–†–û–ì–ò–ô –§–ò–õ–¨–¢–†: –æ—Å—Ç–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –ø—Ä–æ—Å–∏–ª –∫–ª–∏–µ–Ω—Ç
                filtered_offers = [
                    o for o in offers 
                    if isinstance(o.hotel_stars, int) and o.hotel_stars >= min_stars
                ]
                
                logger.info(f"   üßπ STRICT FILTER {min_stars}*: –±—ã–ª–æ {original_count}, —Å—Ç–∞–ª–æ {len(filtered_offers)}")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –±—ã–ª–∏ –æ—Ç—Å–µ—è–Ω—ã –æ—Ç–µ–ª–∏
                if original_count > len(filtered_offers):
                    rejected = original_count - len(filtered_offers)
                    logger.info(f"   ‚õî –û—Ç—Å–µ—è–Ω–æ {rejected} –æ—Ç–µ–ª–µ–π —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª-–≤–æ–º –∑–≤—ë–∑–¥")
                
                offers = filtered_offers
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ –∏ –±–µ—Ä—ë–º –°–¢–†–û–ì–û 5 (–ª–∏–º–∏—Ç Pydantic!)
            offers = sorted(offers, key=lambda x: x.price)[:5]
            
            if offers:
                logger.info(f"   ‚úÖ –û—Ç–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {len(offers)} —Ç—É—Ä–æ–≤")
                return SearchResponse(
                    offers=offers,
                    total_found=len(offers),
                    search_id=request_id,
                    found=True
                )
            else:
                # –ß–ï–°–¢–ù–´–ô –û–¢–í–ï–¢: —Ç—É—Ä–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –Ω–µ—Ç
                logger.warning(f"   ‚ö†Ô∏è –¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (stars={params.stars}, food={params.food_type})")
                return SearchResponse(
                    offers=[], 
                    total_found=0, 
                    search_id=request_id,
                    found=False, 
                    reason="no_tours_with_filters",
                    suggestion=f"–ù–∞ {params.stars}* —Ç—É—Ä–æ–≤ –Ω–µ—Ç" if params.stars else "–¢—É—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
                )
                
        except SearchTimeoutError:
            return SearchResponse(
                offers=[], total_found=0, found=False,
                reason="search_timeout",
                suggestion="try_later"
            )
        except TourvisorAPIError as e:
            logger.error(f"‚ùå API Error: {e.message}")
            return SearchResponse(
                offers=[], total_found=0, found=False,
                reason="api_error"
            )
    
    def _build_search_params(
        self,
        params: SearchRequest,
        country_id: int,
        departure_id: int,
        hotel_ids: Optional[list[int]],
        expand_dates: bool = True,
        expand_nights: bool = True,
        is_hot_tour: bool = False,
        region_id: Optional[int] = None  # ID —Ä–µ–≥–∏–æ–Ω–∞ (–∏–∑ API)
    ) -> dict:
        """
        –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è search.php.
        
        –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 1. –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤.docx:
        - datefrom, dateto: –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy
        - child: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π
        - childage1, childage2...: –≤–æ–∑—Ä–∞—Å—Ç—ã –¥–µ—Ç–µ–π (–ù–ï –º–∞—Å—Å–∏–≤!)
        - hotels: —Å–ø–∏—Å–æ–∫ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        
        –ö–†–ò–¢–ò–ß–ù–û: –î–∞—Ç—ã —É–∂–µ —Ä–∞—Å—à–∏—Ä–µ–Ω—ã –≤ nodes.py ‚Äî –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö!
        """
        # ==================== NO DEFAULTS: nights –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω! ====================
        if not params.nights:
            logger.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: nights –Ω–µ —É–∫–∞–∑–∞–Ω!")
            nights_from = 7
        else:
            nights_from = params.nights
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–æ—á–µ–π: +2 –Ω–æ—á–∏ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
        nights_to = nights_from + 2
        
        # ==================== –î–ê–¢–´ –£–ñ–ï –†–ê–°–®–ò–†–ï–ù–´ –í NODES.PY ====================
        # –ù–ï –¥–µ–ª–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ
        date_start = params.date_from
        date_end = params.date_to or params.date_from
        
        logger.info(f"   üìÖ –î–∞—Ç—ã –∏–∑ nodes.py: {date_start.strftime('%d.%m')} - {date_end.strftime('%d.%m')}")
        
        # ==================== DEPARTURE: –ñ–ï–õ–ï–ó–û–ë–ï–¢–û–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê ====================
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–π —Ñ–ª–∞–≥ search_mode –∏–∑ params
        mode = getattr(params, "search_mode", "package")
        
        RUSSIA_COUNTRY_ID = 30  # ID –†–æ—Å—Å–∏–∏ –≤ Tourvisor
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –≥–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º?
        departure_city = params.departure_city.lower() if params.departure_city else ""
        destination_city = ""
        if params.destination:
            destination_city = (params.destination.city or params.destination.resort or "").lower()
        
        is_same_city = departure_city and destination_city and (
            departure_city in destination_city or destination_city in departure_city
        )
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ –ø–µ—Ä–µ–ª—ë—Ç
        is_russia = (country_id == RUSSIA_COUNTRY_ID)
        is_hotel_only = (mode == "hotel_only")
        no_departure = not departure_id
        
        # 2. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û departure=0 –µ—Å–ª–∏:
        #    - –†–µ–∂–∏–º hotel_only
        #    - –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º (–°–æ—á–∏ -> –°–æ—á–∏)
        #    - –ù–µ—Ç departure_id
        if is_hotel_only or is_same_city or no_departure:
            final_departure_id = 0
            logger.info(f"   üöó FORCE GROUND SERVICE: departure=0 (mode={mode}, hotel_only={is_hotel_only}, same_city={is_same_city})")
        elif is_russia and not departure_id:
            # –†–æ—Å—Å–∏—è –±–µ–∑ —è–≤–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞ ‚Äî –Ω–∞–∑–µ–º–∫–∞
            final_departure_id = 0
            logger.info(f"   üá∑üá∫ –†–û–°–°–ò–Ø –±–µ–∑ –≤—ã–ª–µ—Ç–∞: departure=0")
        else:
            final_departure_id = departure_id
            logger.info(f"   ‚úàÔ∏è –ü–ï–†–ï–õ–Å–¢: departure={final_departure_id}")
        
        api_params = {
            "departure": final_departure_id,
            "country": country_id,
            "datefrom": date_start.strftime("%d.%m.%Y"),
            "dateto": date_end.strftime("%d.%m.%Y"),
            "nightsfrom": nights_from,
            "nightsto": nights_to,
            "adults": params.adults,
            # –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ä–µ–π—Å—ã –≤–∫–ª—é—á–∞—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ (GDS)!
            "hideregular": 0,
        }
        
        # === –î–ï–¢–ò: –ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ childage1, childage2... ===
        if params.children:
            api_params["child"] = len(params.children)
            for i, age in enumerate(params.children, 1):
                api_params[f"childage{i}"] = age
        
        # –†–µ–≥–∏–æ–Ω/–∫—É—Ä–æ—Ä—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä "regions" (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ!)
        # –°–æ–≥–ª–∞—Å–Ω–æ "1. –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤.docx", Source 185
        if region_id:
            api_params["regions"] = region_id  # CRITICAL: "regions", –Ω–µ "region"!
            logger.info(f"   üó∫Ô∏è –†–µ–≥–∏–æ–Ω '{params.destination.region}' ‚Üí regions={region_id}")
        elif params.destination.region:
            # Fallback: –ø–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –Ω–æ API –º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å)
            api_params["regions"] = params.destination.region
            logger.warning(f"   ‚ö†Ô∏è –†–µ–≥–∏–æ–Ω '{params.destination.region}' –ø–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—Å—Ç–æ–º (ID –Ω–µ –Ω–∞–π–¥–µ–Ω)")
        
        # === –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–µ–ª–∏ (—Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) ===
        if hotel_ids:
            api_params["hotels"] = ",".join(map(str, hotel_ids))
        elif params.hotel_name:
            api_params["hotel"] = params.hotel_name
        
        # –ó–≤—ë–∑–¥–Ω–æ—Å—Ç—å
        if params.stars:
            api_params["starsfrom"] = params.stars
            api_params["starsto"] = params.stars
        
        # –ü–∏—Ç–∞–Ω–∏–µ
        if params.food_type and params.food_type.value in MEAL_TYPE_MAP:
            api_params["meal"] = MEAL_TYPE_MAP[params.food_type.value]
        
        # === –£–°–õ–£–ì–ò –û–¢–ï–õ–ï–ô (services) ===
        # –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞–∫ —Å–ø–∏—Å–æ–∫ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        if hasattr(params, 'services') and params.services:
            api_params["services"] = ",".join(map(str, params.services))
        
        # === –¢–ò–ü–´ –û–¢–ï–õ–ï–ô (hoteltypes) ===
        # –ó–Ω–∞—á–µ–Ω–∏—è: active, relax, family, health, city, beach, deluxe
        if hasattr(params, 'hotel_types') and params.hotel_types:
            api_params["hoteltypes"] = ",".join(params.hotel_types)
        
        # === –¢–ò–ü –¢–£–†–ê (tourtype) ===
        # 0=–ª—é–±–æ–π, 1=–ø–ª—è–∂–Ω—ã–π, 2=–≥–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–π, 3=—ç–∫—Å–∫—É—Ä—Å–∏–æ–Ω–Ω—ã–π
        if hasattr(params, 'tour_type') and params.tour_type is not None:
            api_params["tourtype"] = params.tour_type
        
        # === –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï API –ü–ê–†–ê–ú–ï–¢–†–û–í ===
        logger.info(f"   üì° API params: nights={nights_from}-{nights_to}, "
                   f"dates={date_start.strftime('%d.%m')}-{date_end.strftime('%d.%m')}, "
                   f"adults={params.adults}, stars={params.stars}, meal={api_params.get('meal', 'any')}, "
                   f"hideregular={api_params.get('hideregular', 'N/A')}")
        
        # === –ü–û–õ–ù–´–ô URL –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –° –ë–†–ê–£–ó–ï–†–û–ú ===
        url_params = "&".join(f"{k}={v}" for k, v in api_params.items())
        full_url = f"http://tourvisor.ru/xml/search.php?{url_params}&format=json"
        logger.info(f"   üîó –ü–û–õ–ù–´–ô URL: {full_url}")
        
        # === –≠–ö–í–ò–í–ê–õ–ï–ù–¢–ù–ê–Ø –°–°–´–õ–ö–ê –î–õ–Ø –ë–†–ê–£–ó–ï–†–ê TOURVISOR ===
        browser_url = (
            f"https://tourvisor.ru/tours/{params.destination.country.lower() if params.destination else 'turkey'}/"
            f"?s_nights_from={nights_from}&s_nights_to={nights_to}"
            f"&s_j_date_from={date_start.strftime('%d.%m.%Y')}&s_j_date_to={date_end.strftime('%d.%m.%Y')}"
            f"&s_adults={params.adults}"
            f"&s_flyfrom={final_departure_id}&s_country={country_id}"
            f"&s_regular=1"  # –í–∫–ª—é—á–∞–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–µ–π—Å—ã
            + (f"&s_stars={params.stars}" if params.stars else "")
            + (f"&s_meal={api_params.get('meal', '')}" if api_params.get('meal') else "")
        )
        logger.info(f"   üåê BROWSER URL: {browser_url}")
        
        # === üî• –î–ï–¢–ï–ö–¢–û–† –õ–ñ–ò (TRUTH CHECK) ===
        print(f"\nüî• [TRUTH CHECK] SEARCH MODE: {getattr(params, 'tour_type', 'package')} | DEPARTURE ID: {api_params.get('departure')}")
        print(f"üî• [TRUTH CHECK] DATES SENT: {api_params.get('datefrom')} - {api_params.get('dateto')}")
        print(f"üî• [TRUTH CHECK] NIGHTS SENT: {api_params.get('nightsfrom')} - {api_params.get('nightsto')}")
        print(f"üî• [TRUTH CHECK] FINAL URL: http://tourvisor.ru/xml/search.php?{url_params}\n")
        
        return api_params
    
    async def _poll_and_fetch_results(
        self,
        request_id: str,
        country_id: int,
        is_strict_hotel_search: bool,
        hotel_ids: Optional[list[int]],
        onpage: int = 100  # –£–í–ï–õ–ò–ß–ï–ù–û: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 100 –æ—Ç–µ–ª–µ–π –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –≤—ã–±–æ—Ä–∫–∏
    ) -> list[TourOffer]:
        """
        –¶–∏–∫–ª –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
        
        –ü—Ä–æ—Ç–æ–∫–æ–ª (–£–õ–£–ß–®–ï–ù–ù–´–ô):
        1. –ñ–¥—ë–º –º–∏–Ω–∏–º—É–º min_wait_seconds (5 —Å–µ–∫) –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º fetch
        2. result.php?type=status ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º progress
        3. –ó–∞–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ progress >= 50% –ò–õ–ò state == finished
        4. –ü–µ—Ä–µ–∑–∞–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–≥–¥–∞ state == finished
        
        –ö–†–ò–¢–ò–ß–ù–û: onpage=100 —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—É—é –≤—ã–±–æ—Ä–∫—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏!
        """
        all_offers = []
        fetched = False
        start_time = asyncio.get_event_loop().time()
        
        logger.info(f"   üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (request_id={request_id})")
        
        for attempt in range(1, self.max_poll_attempts + 1):
            await asyncio.sleep(self.poll_interval)
            
            elapsed = asyncio.get_event_loop().time() - start_time
            
            # === –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å ===
            status = await self._get_search_status(request_id)
            
            logger.info(f"   ‚è≥ [{attempt}/{self.max_poll_attempts}] "
                       f"Progress: {status.progress}% | State: {status.state} | "
                       f"Elapsed: {elapsed:.1f}s | Found: {len(all_offers)}")
            
            # === –ö–†–ò–¢–ò–ß–ù–û: –ñ–¥—ë–º –º–∏–Ω–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º fetch ===
            if elapsed < self.min_wait_seconds:
                continue
            
            # –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –∑–∞–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if status.progress >= self.min_progress_to_fetch or status.state == "finished":
                offers = await self._fetch_results(
                    request_id, country_id, is_strict_hotel_search, hotel_ids,
                    onpage=onpage  # –ü–µ—Ä–µ–¥–∞—ë–º –≥–ª—É–±–∏–Ω—É –≤—ã–±–æ—Ä–∫–∏
                )
                if offers:
                    all_offers = offers
                    fetched = True
                    logger.info(f"   ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(offers)} —Ç—É—Ä–æ–≤ (progress={status.progress}%, onpage={onpage})")
            
            # –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚Äî –¥–µ–ª–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fetch –∏ –≤—ã—Ö–æ–¥–∏–º
            if status.state == "finished":
                # –§–∏–Ω–∞–ª—å–Ω—ã–π fetch —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                final_offers = await self._fetch_results(
                    request_id, country_id, is_strict_hotel_search, hotel_ids,
                    onpage=onpage  # –ü–µ—Ä–µ–¥–∞—ë–º –≥–ª—É–±–∏–Ω—É –≤—ã–±–æ—Ä–∫–∏
                )
                if final_offers:
                    all_offers = final_offers
                    fetched = True
                logger.info(f"   üèÅ –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω: {len(all_offers)} —Ç—É—Ä–æ–≤ –∑–∞ {elapsed:.1f}s")
                break
        
        if not fetched:
            raise SearchTimeoutError("Search timeout")
        
        return all_offers
    
    async def _get_search_status(self, request_id: str) -> SearchStatus:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∏—Å–∫–∞.
        
        –ú–µ—Ç–æ–¥: result.php?type=status&requestid=XXX
        """
        try:
            response = await self._request("result.php", {
                "type": "status",
                "requestid": request_id
            })
            
            data = response.get("data", {}).get("status", {})
            
            return SearchStatus(
                request_id=request_id,
                state=data.get("state", "unknown"),
                progress=int(data.get("progress", 0)),
                operators_done=int(data.get("done", 0)),
                operators_total=int(data.get("total", 0)),
            )
        except Exception:
            return SearchStatus(
                request_id=request_id,
                state="error",
                progress=0
            )
    
    async def _fetch_results(
        self,
        request_id: str,
        country_id: int,
        is_strict_hotel_search: bool,
        hotel_ids: Optional[list[int]],
        page: int = 1,
        onpage: int = 100  # CRITICAL: 100 –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –≤—ã–±–æ—Ä–∫–∏ (Source 216)
    ) -> list[TourOffer]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
        
        –ú–µ—Ç–æ–¥: result.php?type=result&requestid=XXX&page=N&onpage=M
        –°–æ–≥–ª–∞—Å–Ω–æ "1. –ü–æ–∏—Å–∫ —Ç—É—Ä–æ–≤.docx", Source 216
        
        Args:
            request_id: ID –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            country_id: ID —Å—Ç—Ä–∞–Ω—ã
            is_strict_hotel_search: –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –ø–æ –æ—Ç–µ–ª—é
            hotel_ids: –°–ø–∏—Å–æ–∫ ID –æ—Ç–µ–ª–µ–π
            page: –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞—è —Å 1)
            onpage: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (100 –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –≤—ã–±–æ—Ä–∫–∏)
        """
        try:
            response = await self._request("result.php", {
                "type": "result",
                "requestid": request_id,
                "page": page,
                "onpage": onpage
            })
            
            return self._parse_tour_results(
                response, country_id, is_strict_hotel_search, hotel_ids
            )
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {e}")
            return []
    
    async def fetch_more_results(
        self,
        request_id: str,
        country_id: int,
        page: int = 2,
        onpage: int = 100  # –ì–ª—É–±–æ–∫–∞—è –≤—ã–±–æ—Ä–∫–∞
    ) -> list[TourOffer]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è).
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ï—â—ë —Ç—É—Ä—ã".
        
        Args:
            request_id: ID –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ)
            country_id: ID —Å—Ç—Ä–∞–Ω—ã
            page: –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (2, 3, 4...)
            onpage: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (100 –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –≤—ã–±–æ—Ä–∫–∏)
            
        Returns:
            –°–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—É—Ä–æ–≤
        """
        logger.info(f"üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã {page} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")
        
        return await self._fetch_results(
            request_id=request_id,
            country_id=country_id,
            is_strict_hotel_search=False,
            hotel_ids=None,
            page=page,
            onpage=onpage
        )
    
    async def continue_search(
        self,
        request_id: str,
        country_id: int
    ) -> tuple[list[TourOffer], bool]:
        """
        –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
        
        GAP Analysis: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è continue –¥–ª—è —É–≥–ª—É–±–ª—ë–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.
        
        –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tourvisor API:
        - –ü–æ—Å–ª–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å search.php?continue=requestid
        - –≠—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –æ–ø—Ä–æ—Å —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç—É—Ä–æ–≤
        
        Args:
            request_id: ID –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            country_id: ID —Å—Ç—Ä–∞–Ω—ã
            
        Returns:
            Tuple (—Å–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤, –µ—Å—Ç—å –ª–∏ –µ—â—ë —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
        """
        logger.info(f"üîÑ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞: {request_id}")
        
        try:
            # –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
            response = await self._request("search.php", {
                "continue": request_id
            })
            
            # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π requestid –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π
            new_request_id = response.get("result", {}).get("requestid", request_id)
            
            # –ñ–¥—ë–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≥–ª—É–±–æ–∫–∞—è –≤—ã–±–æ—Ä–∫–∞)
            offers = await self._poll_and_fetch_results(
                request_id=new_request_id,
                country_id=country_id,
                is_strict_hotel_search=False,
                hotel_ids=None,
                onpage=100  # –ì–ª—É–±–æ–∫–∞—è –≤—ã–±–æ—Ä–∫–∞
            )
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –±–µ—Ä—ë–º –°–¢–†–û–ì–û 5 —Ç—É—Ä–æ–≤ (–ª–∏–º–∏—Ç Pydantic!)
            offers = sorted(offers, key=lambda x: x.price)[:5]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â—ë –¥–∞–Ω–Ω—ã–µ
            has_more = len(offers) >= 5
            
            return offers, has_more
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞: {e}")
            return [], False
    
    def _extract_request_id(self, response: dict) -> Optional[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ requestid –∏–∑ –æ—Ç–≤–µ—Ç–∞ search.php."""
        return (
            response.get("result", {}).get("requestid") or
            response.get("requestid") or
            response.get("data", {}).get("requestid")
        )
    
    def _parse_tour_results(
        self,
        response: dict,
        country_id: int,
        is_strict_hotel_search: bool,
        hotel_ids: Optional[list[int]]
    ) -> list[TourOffer]:
        """–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞."""
        
        hotels_data = response.get("data", {}).get("result", {}).get("hotel", [])
        
        if isinstance(hotels_data, dict):
            hotels_data = [hotels_data]
        
        if not hotels_data:
            return []
        
        offers = []
        expected_country = self.get_country_name(country_id)
        
        for hotel in hotels_data:
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–µ
            hotel_country_id = hotel.get("countryid")
            if hotel_country_id and int(hotel_country_id) != country_id:
                continue
            
            # –°—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –ø–æ –æ—Ç–µ–ª—é
            if is_strict_hotel_search and hotel_ids:
                hotel_code = hotel.get("hotelcode")
                if hotel_code and int(hotel_code) not in hotel_ids:
                    continue
            
            try:
                offer = self._parse_single_offer(hotel, expected_country)
                if offer:
                    offers.append(offer)
            except Exception as e:
                logger.debug(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
                continue
        
        return offers
    
    def _parse_single_offer(self, hotel: dict, country_name: Optional[str]) -> Optional[TourOffer]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."""
        
        tours = hotel.get("tours", {}).get("tour", [])
        if isinstance(tours, dict):
            tours = [tours]
        
        tour = tours[0] if tours else {}
        
        price = hotel.get("price") or tour.get("price", 0)
        if not price:
            return None
        
        # –î–∞—Ç—ã
        date_from = self._parse_date(tour.get("flydate") or tour.get("checkin"))
        nights = int(tour.get("nights", 7))
        
        if not date_from:
            date_from = date.today() + timedelta(days=14)
        
        date_to = date_from + timedelta(days=nights)
        
        # –ü–∏—Ç–∞–Ω–∏–µ
        meal_code = tour.get("meal", "AI")
        if meal_code in MEAL_TYPE_REVERSE:
            meal_code = MEAL_TYPE_REVERSE[meal_code]
        
        try:
            food_type = FoodType(meal_code.upper())
        except ValueError:
            food_type = FoodType.AI
        
        # === GAP Analysis: –ò–∑–≤–ª–µ–∫–∞–µ–º tour_id –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===
        tour_id = tour.get("tourid") or tour.get("tour_id") or tour.get("id")
        
        return TourOffer(
            id=str(tour_id if tour_id else uuid.uuid4()),
            hotel_name=hotel.get("hotelname", "Unknown"),
            hotel_stars=int(hotel.get("hotelstars", 0)),
            hotel_rating=float(hotel.get("hotelrating")) if hotel.get("hotelrating") else None,
            country=hotel.get("countryname") or country_name or "",
            region=hotel.get("regionname"),
            resort=hotel.get("subregionname") or hotel.get("resortname"),
            room_type=tour.get("room", "Standard"),
            food_type=food_type,
            price=int(price),
            currency="RUB",
            date_from=date_from,
            date_to=date_to,
            nights=nights,
            adults=int(tour.get("adults", 2)),
            children=int(tour.get("child", 0)),
            departure_city=tour.get("departurename", "–ú–æ—Å–∫–≤–∞"),
            operator=tour.get("operatorname", ""),
            hotel_link=hotel.get("fulldesclink", ""),
            hotel_photo=hotel.get("picturelink", ""),
            tour_id=str(tour_id) if tour_id else None,  # GAP Analysis: –¥–ª—è booking_url
        )
    
    def _parse_date(self, date_str: Optional[str]) -> Optional[date]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã (—Ñ–æ—Ä–º–∞—Ç dd.mm.yyyy)."""
        if not date_str:
            return None
        
        try:
            parts = date_str.split(".")
            if len(parts) == 3:
                return date(int(parts[2]), int(parts[1]), int(parts[0]))
        except:
            pass
        
        return None
    
    def _apply_filters(self, offers: list[TourOffer], filters: TourFilters) -> list[TourOffer]:
        """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤."""
        result = offers
        
        if filters.food_types:
            result = [o for o in result if o.food_type in filters.food_types]
        
        if filters.min_stars:
            result = [o for o in result if o.hotel_stars >= filters.min_stars]
        
        if filters.max_stars:
            result = [o for o in result if o.hotel_stars <= filters.max_stars]
        
        if filters.min_price:
            result = [o for o in result if o.price >= filters.min_price]
        
        if filters.max_price:
            result = [o for o in result if o.price <= filters.max_price]
        
        return result
    
    # ==================== 4. –ì–û–†–Ø–©–ò–ï –¢–£–†–´ (hottours.php) ====================
    
    async def get_hot_tours(
        self,
        departure_id: int = 1,
        country_id: Optional[int] = None,
        limit: int = 10
    ) -> list[TourOffer]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤.
        
        –ú–µ—Ç–æ–¥: hottours.php (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π)
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 1. –ì–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã.docx
        
        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        - city: ID –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞
        - country: ID —Å—Ç—Ä–∞–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        - items: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        """
        logger.info("üî• –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤...")
        
        if self.mock_enabled:
            return await self._mock_hot_tours()
        
        try:
            params = {
                "city": departure_id,
                "items": limit,
            }
            
            if country_id:
                params["country"] = country_id
            
            response = await self._request("hottours.php", params)
            
            tours_data = response.get("data", {}).get("tour", [])
            
            if isinstance(tours_data, dict):
                tours_data = [tours_data]
            
            offers = []
            for t in tours_data:
                try:
                    offer = self._parse_hot_tour(t)
                    if offer:
                        offers.append(offer)
                except Exception:
                    continue
            
            logger.info(f"üî• –ù–∞–π–¥–µ–Ω–æ {len(offers)} –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤")
            return offers
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä—è—â–∏—Ö —Ç—É—Ä–æ–≤: {e}")
            return []
    
    def _parse_hot_tour(self, tour: dict) -> Optional[TourOffer]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –≥–æ—Ä—è—â–µ–≥–æ —Ç—É—Ä–∞."""
        
        price = tour.get("price", 0)
        if not price:
            return None
        
        date_from = self._parse_date(tour.get("flydate"))
        nights = int(tour.get("nights", 7))
        
        if not date_from:
            date_from = date.today() + timedelta(days=3)
        
        return TourOffer(
            id=str(tour.get("tourid", uuid.uuid4())),
            hotel_name=tour.get("hotelname", "Unknown"),
            hotel_stars=int(tour.get("hotelstars", 0)),
            country=tour.get("countryname", ""),
            region=tour.get("regionname"),
            resort=tour.get("subregionname"),
            room_type=tour.get("room", "Standard"),
            food_type=FoodType.AI,
            price=int(price),
            currency="RUB",
            date_from=date_from,
            date_to=date_from + timedelta(days=nights),
            nights=nights,
            adults=2,
            children=0,
            departure_city=tour.get("departurename", "–ú–æ—Å–∫–≤–∞"),
            operator=tour.get("operatorname", ""),
            hotel_link=tour.get("fulldesclink", ""),
            hotel_photo=tour.get("picturelink", ""),
        )
    
    # ==================== 5. –ê–ö–¢–£–ê–õ–ò–ó–ê–¶–ò–Ø (actualize.php, actdetail.php) ====================
    
    async def actualize_tour(self, tour_id: str) -> Optional[ActualizeResult]:
        """
        –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–Ω—ã —Ç—É—Ä–∞.
        
        –ú–µ—Ç–æ–¥: actualize.php?tourid=XXX
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 3. –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è.docx
        
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç—É—Ä.
        """
        logger.info(f"üí∞ –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É—Ä–∞: {tour_id}")
        
        if self.mock_enabled:
            return ActualizeResult(
                tour_id=tour_id,
                price=100000,
                available=True,
                price_changed=False
            )
        
        try:
            response = await self._request("actualize.php", {"tourid": tour_id})
            
            data = response.get("data", {}).get("tour", {})
            
            if not data:
                return None
            
            current_price = int(data.get("price", 0))
            original_price = int(data.get("originalprice", current_price))
            
            return ActualizeResult(
                tour_id=tour_id,
                price=current_price,
                available=data.get("available", "1") == "1",
                price_changed=current_price != original_price,
                original_price=original_price,
                currency=data.get("currency", "RUB")
            )
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            return None
    
    async def get_flight_details(self, tour_id: str) -> Optional[FlightInfo]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–π—Å–µ.
        
        –ú–µ—Ç–æ–¥: actdetail.php?tourid=XXX
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 4. –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–∞—è.docx
        
        –í–ê–ñ–ù–û: –≠—Ç–æ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥, —Å—Ç–∞—Ä—ã–π (flights=1) –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!
        """
        logger.info(f"‚úàÔ∏è –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–π—Å–µ: {tour_id}")
        
        if self.mock_enabled:
            return FlightInfo(
                airline="Aeroflot",
                flight_number="SU123",
                departure_time="10:00",
                arrival_time="14:00",
            )
        
        try:
            response = await self._request("actdetail.php", {"tourid": tour_id})
            
            flight_data = response.get("data", {}).get("flight", {})
            
            if not flight_data:
                return None
            
            return FlightInfo(
                airline=flight_data.get("airline", ""),
                flight_number=flight_data.get("flightnumber", ""),
                departure_time=flight_data.get("departuretime", ""),
                arrival_time=flight_data.get("arrivaltime", ""),
                departure_airport=flight_data.get("departureairport", ""),
                arrival_airport=flight_data.get("arrivalairport", ""),
            )
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–π—Å–µ: {e}")
            return None
    
    # ==================== 6. –ö–û–ù–¢–ï–ù–¢ –û–¢–ï–õ–Ø (hotel.php) ====================
    
    async def get_hotel_details(self, hotel_code: int) -> Optional[HotelDetails]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç–µ–ª–µ.
        
        –ú–µ—Ç–æ–¥: hotel.php?hotelcode=XXX
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 1. –û–ø–∏—Å–∞–Ω–∏—è –æ—Ç–µ–ª–µ–π.docx
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.
        """
        logger.info(f"üè® –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç–µ–ª–µ: {hotel_code}")
        
        if self.mock_enabled:
            return None
        
        try:
            response = await self._request("hotel.php", {"hotelcode": hotel_code})
            
            data = response.get("data", {}).get("hotel", {})
            
            if not data:
                return None
            
            # –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ (–º–∞—Å—Å–∏–≤ images -> image)
            photos = []
            images_data = data.get("images", {}).get("image", [])
            if isinstance(images_data, dict):
                images_data = [images_data]
            
            for img in images_data:
                if isinstance(img, str):
                    photos.append(img)
                elif isinstance(img, dict):
                    # –ë–µ—Ä—ë–º —Å—Å—ã–ª–∫—É –Ω–∞ 800px –≤–µ—Ä—Å–∏—é
                    url = img.get("800") or img.get("url") or img.get("src")
                    if url:
                        photos.append(url)
            
            return HotelDetails(
                id=hotel_code,
                name=data.get("name", ""),
                stars=int(data.get("stars", 0)),
                rating=float(data.get("rating")) if data.get("rating") else None,
                country=data.get("countryname", ""),
                region=data.get("regionname"),
                resort=data.get("subregionname"),
                address=data.get("address"),
                description=data.get("description"),
                photos=photos[:10],  # –õ–∏–º–∏—Ç 10 —Ñ–æ—Ç–æ
            )
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Ç–µ–ª–µ: {e}")
            return None
    
    # ==================== MOCK DATA ====================
    
    async def _mock_search_tours(self, params: SearchRequest) -> SearchResponse:
        """Mock –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
        
        base_date = params.date_from or date.today() + timedelta(days=14)
        nights = params.nights or 7
        country = params.destination.country
        
        offers = []
        mock_hotels = [
            ("Beach Resort", 4, 65000),
            ("Grand Hotel", 5, 95000),
            ("Family Inn", 3, 45000),
        ]
        
        for name, stars, price in mock_hotels:
            total_price = price * params.adults
            for age in (params.children or []):
                if age < 2:
                    total_price += price * 0.1
                elif age < 12:
                    total_price += price * 0.5
                else:
                    total_price += price * 0.8
            
            offer = TourOffer(
                id=str(uuid.uuid4()),
                hotel_name=f"{name} {country}",
                hotel_stars=stars,
                country=country,
                region="Mock Region",
                resort="Mock Resort",
                room_type="Standard",
                food_type=params.food_type or FoodType.AI,
                price=int(total_price),
                currency="RUB",
                date_from=base_date,
                date_to=base_date + timedelta(days=nights),
                nights=nights,
                adults=params.adults,
                children=len(params.children or []),
                departure_city=params.departure_city,
                operator="Mock Operator",
            )
            offers.append(offer)
        
        return SearchResponse(
            offers=offers,
            total_found=len(offers),
            found=True
        )
    
    async def _mock_hot_tours(self) -> list[TourOffer]:
        """Mock –≥–æ—Ä—è—â–∏–µ —Ç—É—Ä—ã."""
        return [
            TourOffer(
                id=str(uuid.uuid4()),
                hotel_name="Hot Deal Resort",
                hotel_stars=4,
                country="–ï–≥–∏–ø–µ—Ç",
                region="–•—É—Ä–≥–∞–¥–∞",
                resort="–ú–∞–∫–∞–¥–∏ –ë–µ–π",
                room_type="Standard",
                food_type=FoodType.AI,
                price=45000,
                currency="RUB",
                date_from=date.today() + timedelta(days=3),
                date_to=date.today() + timedelta(days=10),
                nights=7,
                adults=2,
                children=0,
                departure_city="–ú–æ—Å–∫–≤–∞",
                operator="Anex Tour",
            )
        ]
    
    # ==================== CLEANUP ====================
    
    async def close(self):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–∞."""
        if self.client:
            await self.client.aclose()
            self.client = None


# ==================== SERVICE SINGLETON ====================

tourvisor_service = TourvisorService()


=== app/models/domain.py ===

"""
–î–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤.

–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ú–ì–ü:
- –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ —Ç–æ, —á—Ç–æ —É–∂–µ –ø–æ–Ω—è—Ç–Ω–æ –∏–∑ —Ñ—Ä–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –¥–∞—Ç—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –µ–≥–æ –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä—É–ø–ø—ã –æ—Ç 1 –¥–æ 6 –≤–∑—Ä–æ—Å–ª—ã—Ö
- –î–µ—Ç–∏: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 0-2 –≥–æ–¥–∞ (–º–ª–∞–¥–µ–Ω—Ü—ã) –∏ 2-15 –ª–µ—Ç (–¥–µ—Ç–∏)
- –ò–µ—Ä–∞—Ä—Ö–∏—è –ø–æ–∏—Å–∫–∞: –°—Ç—Ä–∞–Ω–∞ -> –†–µ–≥–∏–æ–Ω -> –ö—É—Ä–æ—Ä—Ç -> –ì–æ—Ä–æ–¥ -> –û—Ç–µ–ª—å
"""
from __future__ import annotations

from datetime import date
from enum import Enum
from typing import Optional
from pydantic import BaseModel, Field, field_validator, model_validator


class FoodType(str, Enum):
    """–¢–∏–ø—ã –ø–∏—Ç–∞–Ω–∏—è –≤ –æ—Ç–µ–ª—è—Ö."""
    
    RO = "RO"   # Room Only - –±–µ–∑ –ø–∏—Ç–∞–Ω–∏—è
    BB = "BB"   # Bed & Breakfast - —Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫
    HB = "HB"   # Half Board - –∑–∞–≤—Ç—Ä–∞–∫ –∏ —É–∂–∏–Ω
    FB = "FB"   # Full Board - —Ç—Ä—ë—Ö—Ä–∞–∑–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
    AI = "AI"   # All Inclusive - –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ
    UAI = "UAI" # Ultra All Inclusive - —É–ª—å—Ç—Ä–∞ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ


class HotelType(str, Enum):
    """–¢–∏–ø—ã –æ—Ç–µ–ª–µ–π –ø–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏."""
    
    FAMILY = "family"        # –°–µ–º–µ–π–Ω—ã–π –æ—Ç–¥—ã—Ö
    VIP = "vip"              # VIP / –ü—Ä–µ–º–∏—É–º
    ACTIVE = "active"        # –ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö
    ROMANTIC = "romantic"    # –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π
    BUDGET = "budget"        # –ë—é–¥–∂–µ—Ç–Ω—ã–π
    BEACH = "beach"          # –ü–ª—è–∂–Ω—ã–π


class HotelAmenity(str, Enum):
    """–£—Å–ª—É–≥–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–µ–ª—è."""
    
    SANDY_BEACH = "sandy_beach"     # –ü–µ—Å—á–∞–Ω—ã–π –ø–ª—è–∂
    AQUAPARK = "aquapark"           # –ê–∫–≤–∞–ø–∞—Ä–∫
    FIRST_LINE = "first_line"       # 1-—è –ª–∏–Ω–∏—è
    KIDS_CLUB = "kids_club"         # –î–µ—Ç—Å–∫–∏–π –∫–ª—É–±
    SPA = "spa"                     # –°–ü–ê-—Ü–µ–Ω—Ç—Ä
    GYM = "gym"                     # –§–∏—Ç–Ω–µ—Å-–∑–∞–ª
    POOL = "pool"                   # –ë–∞—Å—Å–µ–π–Ω
    HEATED_POOL = "heated_pool"     # –ü–æ–¥–æ–≥—Ä–µ–≤–∞–µ–º—ã–π –±–∞—Å—Å–µ–π–Ω
    WIFI = "wifi"                   # Wi-Fi
    ANIMATION = "animation"         # –ê–Ω–∏–º–∞—Ü–∏—è
    TRANSFER = "transfer"           # –¢—Ä–∞–Ω—Å—Ñ–µ—Ä
    WATER_SLIDES = "water_slides"   # –í–æ–¥–Ω—ã–µ –≥–æ—Ä–∫–∏
    PRIVATE_BEACH = "private_beach" # –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–ª—è–∂
    ALL_INCLUSIVE = "all_inclusive" # –í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ 24/7


class Child(BaseModel):
    """
    –ú–æ–¥–µ–ª—å —Ä–µ–±—ë–Ω–∫–∞ —Å –≤–æ–∑—Ä–∞—Å—Ç–æ–º.
    
    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:
    - 0-2 –≥–æ–¥–∞: –º–ª–∞–¥–µ–Ω—Ü—ã (infants)
    - 2-15 –ª–µ—Ç: –¥–µ—Ç–∏ (kids)
    """
    
    age: int = Field(ge=0, le=15, description="–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ (0-15 –ª–µ—Ç)")
    
    @property
    def is_infant(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞: –º–ª–∞–¥–µ–Ω–µ—Ü (0-2 –≥–æ–¥–∞)."""
        return self.age < 2
    
    @property
    def is_kid(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞: —Ä–µ–±—ë–Ω–æ–∫ (2-15 –ª–µ—Ç)."""
        return 2 <= self.age <= 15
    
    @property
    def category(self) -> str:
        """–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–µ–±—ë–Ω–∫–∞."""
        return "infant" if self.is_infant else "kid"


class Destination(BaseModel):
    """
    –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏.
    
    –ò–µ—Ä–∞—Ä—Ö–∏—è: –°—Ç—Ä–∞–Ω–∞ -> –†–µ–≥–∏–æ–Ω -> –ö—É—Ä–æ—Ä—Ç -> –ì–æ—Ä–æ–¥
    """
    
    country: str = Field(description="–°—Ç—Ä–∞–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è")
    region: Optional[str] = Field(default=None, description="–†–µ–≥–∏–æ–Ω")
    resort: Optional[str] = Field(default=None, description="–ö—É—Ä–æ—Ä—Ç")
    city: Optional[str] = Field(default=None, description="–ì–æ—Ä–æ–¥")


class SearchRequest(BaseModel):
    """
    –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ —Ç—É—Ä–∞.
    
    –†–µ–∞–ª–∏–∑—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:
    - adults: 1-6 –≤–∑—Ä–æ—Å–ª—ã—Ö
    - children: —Å–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    - nights: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ –¥–∞—Ç
    - stars: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω hotel_name
    """
    
    # –¢—É—Ä–∏—Å—Ç—ã
    adults: int = Field(
        ge=1,
        le=6,
        description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑—Ä–æ—Å–ª—ã—Ö (1-6 —á–µ–ª–æ–≤–µ–∫)"
    )
    children: list[int] = Field(
        default_factory=list,
        description="–í–æ–∑—Ä–∞—Å—Ç—ã –¥–µ—Ç–µ–π (0-15 –ª–µ—Ç)"
    )
    
    # –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    destination: Destination = Field(description="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏")
    
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    hotel_name: Optional[str] = Field(
        default=None,
        description="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–µ–ª—è"
    )
    
    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Ç–µ–ª—è (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω hotel_name)
    stars: Optional[int] = Field(
        default=None,
        ge=1,
        le=5,
        description="–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Ç–µ–ª—è (1-5 –∑–≤—ë–∑–¥). –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω hotel_name"
    )
    
    # –î–∞—Ç—ã –ø–æ–µ–∑–¥–∫–∏
    date_from: date = Field(description="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–∞")
    date_to: date = Field(description="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞")
    
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ –¥–∞—Ç)
    nights: Optional[int] = Field(
        default=None,
        ge=1,
        le=30,
        description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –¥–∞—Ç)"
    )
    
    # –ü–∏—Ç–∞–Ω–∏–µ
    food_type: Optional[FoodType] = Field(
        default=None,
        description="–¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è"
    )
    
    # –ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞
    departure_city: str = Field(
        default="–ú–æ—Å–∫–≤–∞",
        description="–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞"
    )
    
    # –£—Å–ª—É–≥–∏ –æ—Ç–µ–ª–µ–π (ID –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ services)
    services: Optional[list[int]] = Field(
        default=None,
        description="–°–ø–∏—Å–æ–∫ ID —É—Å–ª—É–≥ –æ—Ç–µ–ª—è (–ø–µ—Å—á–∞–Ω—ã–π –ø–ª—è–∂, –∞–∫–≤–∞–ø–∞—Ä–∫, 1-—è –ª–∏–Ω–∏—è)"
    )
    
    # –¢–∏–ø—ã –æ—Ç–µ–ª–µ–π (–¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ hoteltypes)
    hotel_types: Optional[list[str]] = Field(
        default=None,
        description="–¢–∏–ø—ã –æ—Ç–µ–ª–µ–π: family, beach, deluxe, active, relax, health, city"
    )
    
    # –¢–∏–ø —Ç—É—Ä–∞ (–¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ tourtype)
    tour_type: Optional[int] = Field(
        default=None,
        ge=0,
        le=3,
        description="–¢–∏–ø —Ç—É—Ä–∞: 0=–ª—é–±–æ–π, 1=–ø–ª—è–∂–Ω—ã–π, 2=–≥–æ—Ä–Ω–æ–ª—ã–∂–Ω—ã–π, 3=—ç–∫—Å–∫—É—Ä—Å–∏–æ–Ω–Ω—ã–π"
    )

    @field_validator("children")
    @classmethod
    def validate_children_ages(cls, v: list[int]) -> list[int]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –¥–µ—Ç–µ–π (0-15 –ª–µ—Ç)."""
        for age in v:
            if age < 0 or age > 15:
                raise ValueError(f"–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±—ë–Ω–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0-15 –ª–µ—Ç, –ø–æ–ª—É—á–µ–Ω–æ: {age}")
        if len(v) > 4:
            raise ValueError("–ú–∞–∫—Å–∏–º—É–º 4 —Ä–µ–±—ë–Ω–∫–∞")
        return v

    @model_validator(mode="after")
    def calculate_nights_and_validate(self) -> "SearchRequest":
        """
        –ü–æ—Å—Ç-–≤–∞–ª–∏–¥–∞—Ü–∏—è:
        1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç (date_to >= date_from –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—ã–ª–µ—Ç–∞)
        2. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ stars –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω hotel_name
        
        –í–ê–ñ–ù–û: –ù–ï –≤—ã—á–∏—Å–ª—è–µ–º nights –∏–∑ –¥–∞—Ç!
        date_from/date_to ‚Äî —ç—Ç–æ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –í–´–õ–ï–¢–ê (–¥–ª—è flex search)
        nights ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π —Ç—É—Ä–∞ (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –≤—ã–ª–µ—Ç–∞
        if self.date_from and self.date_to:
            # date_to –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–≤–µ–Ω date_from –ø—Ä–∏ —Ç–æ—á–Ω–æ–π –¥–∞—Ç–µ (flex_days=0)
            if self.date_to < self.date_from:
                raise ValueError("date_to –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ date_from")
        
        # –ù–ï –≤—ã—á–∏—Å–ª—è–µ–º nights –∏–∑ –¥–∞—Ç ‚Äî nights –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —è–≤–Ω–æ!
        # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: date_from/date_to ‚Äî –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã–ª–µ—Ç–∞,
        # –∞ nights ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ (—Ä–∞–∑–Ω—ã–µ –≤–µ—â–∏!)
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–µ–ª—å, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º stars
        if self.hotel_name is not None and self.stars is not None:
            object.__setattr__(self, "stars", None)
        
        return self

    @property
    def infants(self) -> list[int]:
        """–°–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –º–ª–∞–¥–µ–Ω—Ü–µ–≤ (0-2 –≥–æ–¥–∞)."""
        return [age for age in self.children if age < 2]
    
    @property
    def kids(self) -> list[int]:
        """–°–ø–∏—Å–æ–∫ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –¥–µ—Ç–µ–π (2-15 –ª–µ—Ç)."""
        return [age for age in self.children if 2 <= age <= 15]
    
    @property
    def infants_count(self) -> int:
        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–ª–∞–¥–µ–Ω—Ü–µ–≤."""
        return len(self.infants)
    
    @property
    def kids_count(self) -> int:
        """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π 2-15 –ª–µ—Ç."""
        return len(self.kids)
    
    @property
    def total_tourists(self) -> int:
        """–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤."""
        return self.adults + len(self.children)


class TourOffer(BaseModel):
    """
    –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç—É—Ä–∞ (–≤—ã–¥–∞—ë—Ç—Å—è 3-5 –∫–∞—Ä—Ç–æ—á–µ–∫).
    
    –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    
    # ID –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    id: str = Field(description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ
    hotel_name: str = Field(description="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è")
    hotel_stars: int = Field(ge=1, le=5, description="–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Ç–µ–ª—è (–∑–≤—ë–∑–¥—ã)")
    hotel_rating: Optional[float] = Field(
        default=None, 
        ge=0, 
        le=10, 
        description="–†–µ–π—Ç–∏–Ω–≥ –æ—Ç–µ–ª—è"
    )
    hotel_link: Optional[str] = Field(
        default=None, 
        description="–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–µ–ª—è"
    )
    hotel_photo: Optional[str] = Field(
        default=None,
        description="URL —Ñ–æ—Ç–æ –æ—Ç–µ–ª—è"
    )
    
    # –õ–æ–∫–∞—Ü–∏—è
    country: str = Field(description="–°—Ç—Ä–∞–Ω–∞")
    region: Optional[str] = Field(default=None, description="–†–µ–≥–∏–æ–Ω")
    resort: Optional[str] = Field(default=None, description="–ö—É—Ä–æ—Ä—Ç")
    
    # –î–∞—Ç—ã –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    date_from: date = Field(description="–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞")
    date_to: date = Field(description="–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞")
    nights: int = Field(ge=1, description="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π")
    
    # –°—Ç–æ–∏–º–æ—Å—Ç—å
    price: int = Field(gt=0, description="–¶–µ–Ω–∞ –∑–∞ –≤–µ—Å—å —Ç—É—Ä (—Ä—É–±)")
    price_per_person: Optional[int] = Field(
        default=None,
        description="–¶–µ–Ω–∞ –∑–∞ —á–µ–ª–æ–≤–µ–∫–∞ (—Ä—É–±)"
    )
    currency: str = Field(default="RUB", description="–í–∞–ª—é—Ç–∞")
    
    # –ü–∏—Ç–∞–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
    food_type: FoodType = Field(description="–¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è")
    room_type: Optional[str] = Field(
        default=None, 
        description="–¢–∏–ø –Ω–æ–º–µ—Ä–∞"
    )
    
    # –ü–µ—Ä–µ–ª—ë—Ç
    departure_city: str = Field(description="–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞")
    flight_included: bool = Field(default=True, description="–ü–µ—Ä–µ–ª—ë—Ç –≤–∫–ª—é—á—ë–Ω")
    
    # –¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä
    operator: str = Field(description="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞")
    
    # === GAP Analysis: ID —Ç—É—Ä–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===
    tour_id: Optional[str] = Field(
        default=None,
        description="ID —Ç—É—Ä–∞ –≤ —Å–∏—Å—Ç–µ–º–µ Tourvisor (–¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)"
    )
    
    @property
    def booking_url(self) -> Optional[str]:
        """
        URL –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞.
        
        GAP Analysis: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è booking_url —Å tourid –¥–ª—è –∫–∞–∂–¥–æ–≥–æ TourOffer.
        """
        if self.tour_id:
            return f"https://tourvisor.ru/book/?tourid={self.tour_id}"
        return None
    
    @property
    def price_formatted(self) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞."""
        return f"{self.price:,} {self.currency}".replace(",", " ")
    
    @property
    def dates_formatted(self) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã."""
        return f"{self.date_from.strftime('%d.%m')} - {self.date_to.strftime('%d.%m.%Y')}"
    
    @property
    def duration_formatted(self) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å."""
        nights_word = "–Ω–æ—á—å" if self.nights == 1 else "–Ω–æ—á–µ–π" if self.nights >= 5 else "–Ω–æ—á–∏"
        return f"{self.nights} {nights_word}"
    
    @property
    def meal_description(self) -> str:
        """–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º."""
        meal_descriptions = {
            FoodType.RO: "–ë–µ–∑ –ø–∏—Ç–∞–Ω–∏—è",
            FoodType.BB: "–¢–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫",
            FoodType.HB: "–ó–∞–≤—Ç—Ä–∞–∫ –∏ —É–∂–∏–Ω",
            FoodType.FB: "–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω",
            FoodType.AI: "–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ",
            FoodType.UAI: "–£–ª—å—Ç—Ä–∞ –≤—Å—ë –≤–∫–ª—é—á–µ–Ω–æ",
        }
        return meal_descriptions.get(self.food_type, self.food_type.value)
    
    @property
    def date_start(self) -> str:
        """–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM."""
        return self.date_from.strftime("%d.%m")
    
    @property
    def food_type_display(self) -> str:
        """–¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."""
        return self.meal_description
    
    @property
    def stars(self) -> int:
        """–ü—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è hotel_stars."""
        return self.hotel_stars
    
    @property
    def price_value(self) -> int:
        """–ü—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è price."""
        return self.price
    
    @property
    def stars_display(self) -> str:
        """–ó–≤—ë–∑–¥—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ)."""
        return "‚òÖ" * self.hotel_stars
    
    @property
    def location(self) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–∞/–∫—É—Ä–æ—Ä—Ç–∞.
        
        –§–æ—Ä–º–∞—Ç: {Region} ({Resort}), {Country}
        –ü—Ä–∏–º–µ—Ä: –ü—Ö—É–∫–µ—Ç (–ø–ª—è–∂ –ö–∞—Ä–æ–Ω), –¢–∞–∏–ª–∞–Ω–¥
        """
        parts = []
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä–µ–≥–∏–æ–Ω –ø–µ—Ä–≤–∏—á–µ–Ω, –ø–æ—Ç–æ–º –∫—É—Ä–æ—Ä—Ç
        if self.region:
            parts.append(self.region)
        if self.resort and self.resort != self.region:
            if parts:
                parts[0] = f"{parts[0]} ({self.resort})"
            else:
                parts.append(self.resort)
        
        # –°—Ç—Ä–∞–Ω–∞ –≤—Å–µ–≥–¥–∞ –≤ –∫–æ–Ω—Ü–µ
        if self.country:
            parts.append(self.country)
        
        return ", ".join(parts) if parts else self.country
    
    @property
    def image_url(self) -> str:
        """URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–µ–ª—è —Å fallback –Ω–∞ placeholder."""
        if self.hotel_photo and self.hotel_photo.startswith("http"):
            return self.hotel_photo
        # Tourvisor –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
        if self.hotel_photo:
            return f"https://images.tourvisor.ru{self.hotel_photo}"
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π placeholder –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã
        country_images = {
            "—Ç—É—Ä—Ü–∏—è": "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?w=400&h=300&fit=crop",
            "–µ–≥–∏–ø–µ—Ç": "https://images.unsplash.com/photo-1539768942893-daf53e448371?w=400&h=300&fit=crop",
            "–æ–∞—ç": "https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=400&h=300&fit=crop",
            "—Ç–∞–∏–ª–∞–Ω–¥": "https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=400&h=300&fit=crop",
            "–º–∞–ª—å–¥–∏–≤—ã": "https://images.unsplash.com/photo-1514282401047-d79a71a590e8?w=400&h=300&fit=crop",
        }
        country_lower = self.country.lower()
        for key, url in country_images.items():
            if key in country_lower:
                return url
        # Default placeholder
        return "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&h=300&fit=crop"
    
    def model_dump(self, *args, **kwargs):
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è computed –ø–æ–ª–µ–π."""
        data = super().model_dump(*args, **kwargs)
        # –î–æ–±–∞–≤–ª—è–µ–º computed –ø–æ–ª—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        data["meal_description"] = self.meal_description
        data["stars_display"] = self.stars_display
        data["image_url"] = self.image_url
        data["price_formatted"] = self.price_formatted
        data["dates_formatted"] = self.dates_formatted
        data["duration_formatted"] = self.duration_formatted
        return data


class TourFilters(BaseModel):
    """
    –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—É—Ä–æ–≤.
    
    –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ:
    - –¢–∏–ø—É –ø–∏—Ç–∞–Ω–∏—è
    - –£—Å–ª—É–≥–∞–º –æ—Ç–µ–ª—è
    - –¢–∏–ø—É –æ—Ç–µ–ª—è (–∫–æ–Ω—Ü–µ–ø—Ü–∏—è)
    - –ó–≤—ë–∑–¥–Ω–æ—Å—Ç–∏
    - –¶–µ–Ω–µ
    """
    
    food_types: Optional[list[FoodType]] = Field(
        default=None,
        description="–¢–∏–ø—ã –ø–∏—Ç–∞–Ω–∏—è"
    )
    amenities: Optional[list[HotelAmenity]] = Field(
        default=None,
        description="–¢—Ä–µ–±—É–µ–º—ã–µ —É—Å–ª—É–≥–∏ –æ—Ç–µ–ª—è"
    )
    hotel_types: Optional[list[HotelType]] = Field(
        default=None,
        description="–¢–∏–ø—ã –æ—Ç–µ–ª–µ–π –ø–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏"
    )
    min_stars: Optional[int] = Field(
        default=None,
        ge=1,
        le=5,
        description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å"
    )
    max_stars: Optional[int] = Field(
        default=None,
        ge=1,
        le=5,
        description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–≤—ë–∑–¥–Ω–æ—Å—Ç—å"
    )
    min_price: Optional[int] = Field(
        default=None,
        gt=0,
        description="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞"
    )
    max_price: Optional[int] = Field(
        default=None,
        gt=0,
        description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞"
    )
    min_rating: Optional[float] = Field(
        default=None,
        ge=0,
        le=10,
        description="–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç–µ–ª—è"
    )


class HotelDetails(BaseModel):
    """
    –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ.
    
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–µ—Ç–æ–¥–∞ get_hotel_details.
    """
    
    id: int = Field(description="ID –æ—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ Tourvisor")
    name: str = Field(description="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è")
    stars: int = Field(ge=1, le=5, description="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–∑–≤—ë–∑–¥—ã)")
    rating: Optional[float] = Field(default=None, ge=0, le=10, description="–†–µ–π—Ç–∏–Ω–≥")
    
    # –õ–æ–∫–∞—Ü–∏—è
    country: str = Field(description="–°—Ç—Ä–∞–Ω–∞")
    region: Optional[str] = Field(default=None, description="–†–µ–≥–∏–æ–Ω")
    resort: Optional[str] = Field(default=None, description="–ö—É—Ä–æ—Ä—Ç")
    address: Optional[str] = Field(default=None, description="–ê–¥—Ä–µ—Å")
    
    # –û–ø–∏—Å–∞–Ω–∏–µ
    description: Optional[str] = Field(default=None, description="–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–µ–ª—è")
    
    # –£—Å–ª—É–≥–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
    amenities: list[HotelAmenity] = Field(
        default_factory=list,
        description="–£—Å–ª—É–≥–∏ –æ—Ç–µ–ª—è"
    )
    hotel_type: Optional[HotelType] = Field(
        default=None,
        description="–¢–∏–ø –æ—Ç–µ–ª—è"
    )
    available_food_types: list[FoodType] = Field(
        default_factory=list,
        description="–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –ø–∏—Ç–∞–Ω–∏—è"
    )
    
    # –ú–µ–¥–∏–∞
    photos: list[str] = Field(
        default_factory=list,
        description="URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π"
    )
    
    # –†–∞—Å—Å—Ç–æ—è–Ω–∏—è
    beach_distance: Optional[int] = Field(
        default=None,
        description="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–ª—è–∂–∞ (–º–µ—Ç—Ä—ã)"
    )
    airport_distance: Optional[int] = Field(
        default=None,
        description="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ (–∫–º)"
    )


class SearchResponse(BaseModel):
    """–û—Ç–≤–µ—Ç –Ω–∞ –ø–æ–∏—Å–∫ —Ç—É—Ä–æ–≤."""
    
    offers: list[TourOffer] = Field(
        default_factory=list,
        max_length=5,
        description="–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (3-5 –∫–∞—Ä—Ç–æ—á–µ–∫)"
    )
    total_found: int = Field(
        default=0,
        description="–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
    )
    search_id: Optional[str] = Field(
        default=None,
        description="ID –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"
    )
    
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    found: bool = Field(
        default=True,
        description="–ù–∞–π–¥–µ–Ω—ã –ª–∏ —Ç—É—Ä—ã"
    )
    reason: Optional[str] = Field(
        default=None,
        description="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: 'no_flights', 'no_season', 'filters_too_strict'"
    )
    suggestion: Optional[str] = Field(
        default=None,
        description="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 'try_changing_dates', 'try_moscow_departure', 'try_other_country'"
    )
    alternative_meal: bool = Field(
        default=False,
        description="True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç—É—Ä—ã —Å –¥—Ä—É–≥–∏–º —Ç–∏–ø–æ–º –ø–∏—Ç–∞–Ω–∏—è (–Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º)"
    )

=== –ö–û–ù–ï–¶ –î–ê–ú–ü–ê ===
